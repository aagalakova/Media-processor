<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediaProcessor | Relation-AI</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --bg-primary: #ffffff;
            --text-primary: #333333;
            --accent-color: #667eea;
            --success-color: #27ae60;
            --error-color: #e74c3c;
            --warning-color: #e67e22;
            --border-radius: 15px;
            --transition: all 0.3s ease;
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --text-primary: #ffffff;
            --accent-color: #764ba2;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 20px;
            transition: var(--transition);
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: var(--bg-primary);
            color: var(--text-primary);
            border-radius: var(--border-radius);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: var(--transition);
        }

        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: var(--transition);
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        /* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –ø–æ—Ö–æ–∂–∏–º–∏, –Ω–æ —Å CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ */
        .upload-zone {
            border: 3px dashed var(--accent-color);
            border-radius: var(--border-radius);
            padding: 60px 40px;
            text-align: center;
            margin: 30px;
            background: color-mix(in srgb, var(--bg-primary) 95%, var(--accent-color));
            transition: var(--transition);
            cursor: pointer;
        }

        .success-message {
            background: color-mix(in srgb, var(--success-color) 20%, transparent);
            border: 2px solid var(--success-color);
            color: var(--text-primary);
        }

        .error-message {
            background: color-mix(in srgb, var(--error-color) 20%, transparent);
            border: 2px solid var(--error-color);
            color: var(--text-primary);
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .upload-zone {
                margin: 15px;
                padding: 30px 20px;
            }
            
            .settings {
                padding: 15px;
                margin: 10px 15px;
            }
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä */
        .progress-container {
            width: 100%;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
            position: relative;
        }

        .progress-bar {
            height: 8px;
            background: linear-gradient(135deg, var(--accent-color), color-mix(in srgb, var(--accent-color) 70%, black));
            width: 0%;
            transition: width 0.3s ease;
            position: relative;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–∏–ª–∏... */
        .file-list {
            margin: 20px 30px;
            max-height: 400px;
            overflow-y: auto;
        }

        .file-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: color-mix(in srgb, var(--bg-primary) 95%, var(--accent-color));
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid var(--accent-color);
            transition: var(--transition);
        }

        .file-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .settings {
            background: color-mix(in srgb, var(--bg-primary) 98%, var(--accent-color));
            padding: 30px;
            margin: 20px 30px;
            border-radius: var(--border-radius);
        }

        .upload-btn, .process-btn, .download-all-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: var(--transition);
            margin: 5px;
        }

        .upload-btn:hover, .process-btn:hover, .download-all-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px color-mix(in srgb, var(--accent-color) 30%, transparent);
        }

        .hidden {
            display: none;
        }

        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è... */
    </style>
</head>
<body>
    <button class="theme-toggle" id="themeToggle">üåì</button>
    
    <div class="container">
        <div class="header">
            <h1>üöÄ MediaProcessor</h1>
            <p>–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤ | Relation-AI Module</p>
        </div>

        <div class="upload-zone" id="dropZone">
            <div class="upload-icon">üìÅ</div>
            <h3>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞</h3>
            <p>–∏–ª–∏</p>
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã
            </button>
            <input type="file" id="fileInput" class="file-input" multiple accept="image/*,.mp3,.mp4,.mov,.avi,.ogg,.wav,.flac,.aac,.mkv,.webm">
        </div>

        <div class="file-list" id="fileList">
            <div class="empty-state" id="emptyState">
                <div class="upload-icon">üìÑ</div>
                <h3>–ù–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤</h3>
                <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É</p>
            </div>
        </div>

        <div class="settings">
            <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
        </div>

        <div class="stats" id="statsInfo"></div>

        <button class="process-btn" id="processBtn">
            üöÄ –ù–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É
        </button>

        <div class="progress-container hidden" id="progressContainer">
            <div class="progress-bar" id="progressBar"></div>
            <div class="progress-text" id="progressText" style="text-align: center; margin-top: 10px; color: var(--text-primary);"></div>
        </div>

        <div id="videoProcessingContainer"></div>

        <div class="result hidden" id="result">
            <h3>‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h3>
            <div class="result-files" id="resultFiles"></div>
        </div>

        <div class="download-section hidden" id="downloadSection">
            <button class="download-all-btn" id="downloadAllBtn">
                üíæ –°–∫–∞—á–∞—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã (ZIP)
            </button>
            <p style="text-align: center; margin-top: 10px; color: #666;">
                –ë—É–¥–µ—Ç —Å–∫–∞—á–∞–Ω ZIP-–∞—Ä—Ö–∏–≤ —Å–æ –≤—Å–µ–º–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
            </p>
        </div>
    </div>

    <script>
        // ===============================
        // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò –ö–û–ù–°–¢–ê–ù–¢–´
        // ===============================
        class Config {
            static get defaults() {
                return {
                    maxFileSize: 100 * 1024 * 1024,
                    batchSize: 2,
                    timeout: 30000,
                    retryAttempts: 3,
                    maxFiles: 50,
                    imageQualities: {
                        png: 1,
                        jpg: 0.9,
                        webp: 0.8
                    }
                };
            }

            static get presets() {
                return {
                    'creatives': { sizes: ['1200x600', '800x400', '400x200'], formats: ['jpg', 'png'] },
                    'vertical': { sizes: ['1080x1920', '1080x1350', '800x1200'], formats: ['jpg'] },
                    'logos': { sizes: ['800x800', '400x400', '200x200'], formats: ['png'] },
                    'icons': { sizes: ['512x512', '256x256', '128x128', '64x64', '32x32'], formats: ['png'] }
                };
            }

            static get supportedFormats() {
                return {
                    image: ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'],
                    audio: ['mp3', 'wav', 'flac', 'aac', 'ogg'],
                    video: ['mp4', 'mov', 'avi', 'mkv', 'webm', 'ogg']
                };
            }
        }

        // ===============================
        // EVENT BUS –î–õ–Ø –ö–û–ú–ú–£–ù–ò–ö–ê–¶–ò–ò
        // ===============================
        class EventBus {
            constructor() {
                this.events = {};
            }

            on(event, callback) {
                if (!this.events[event]) this.events[event] = [];
                this.events[event].push(callback);
            }

            off(event, callback) {
                if (!this.events[event]) return;
                this.events[event] = this.events[event].filter(cb => cb !== callback);
            }

            emit(event, data) {
                (this.events[event] || []).forEach(callback => callback(data));
            }

            once(event, callback) {
                const onceCallback = (data) => {
                    callback(data);
                    this.off(event, onceCallback);
                };
                this.on(event, onceCallback);
            }
        }

        // ===============================
        // –†–ê–°–®–ò–†–ï–ù–ù–ê–Ø –°–ò–°–¢–ï–ú–ê –õ–û–ì–ì–ò–†–û–í–ê–ù–ò–Ø
        // ===============================
        class AdvancedLogger {
            static levels = { ERROR: 0, WARN: 1, INFO: 2, DEBUG: 3 };
            static currentLevel = this.levels.INFO;
            static sessionId = this.generateSessionId();

            static generateSessionId() {
                return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            static log(level, message, data = {}) {
                if (level > this.currentLevel) return;

                const logEntry = {
                    level: Object.keys(this.levels).find(key => this.levels[key] === level),
                    message,
                    data,
                    timestamp: new Date().toISOString(),
                    sessionId: this.sessionId,
                    performance: performance.now()
                };

                const consoleMethod = this.getConsoleMethod(level);
                console[consoleMethod]('üìù', logEntry);

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                this.saveToStorage(logEntry);
            }

            static getConsoleMethod(level) {
                const methods = {
                    [this.levels.ERROR]: 'error',
                    [this.levels.WARN]: 'warn',
                    [this.levels.INFO]: 'info',
                    [this.levels.DEBUG]: 'log'
                };
                return methods[level] || 'log';
            }

            static saveToStorage(entry) {
                try {
                    const logs = JSON.parse(localStorage.getItem('app_logs') || '[]');
                    logs.push(entry);
                    if (logs.length > 1000) logs.shift(); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä
                    localStorage.setItem('app_logs', JSON.stringify(logs));
                } catch (e) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–≥:', e);
                }
            }

            static error(message, data) { this.log(this.levels.ERROR, message, data); }
            static warn(message, data) { this.log(this.levels.WARN, message, data); }
            static info(message, data) { this.log(this.levels.INFO, message, data); }
            static debug(message, data) { this.log(this.levels.DEBUG, message, data); }
        }

        // ===============================
        // –û–ë–†–ê–ë–û–¢–ß–ò–ö –û–®–ò–ë–û–ö
        // ===============================
        class ErrorHandler {
            static handle(error, context = {}) {
                const errorInfo = {
                    name: error.name,
                    message: error.message,
                    stack: error.stack,
                    context,
                    timestamp: Date.now(),
                    userAgent: navigator.userAgent,
                    url: window.location.href
                };

                AdvancedLogger.error('Application Error', errorInfo);

                const userMessage = this.getUserFriendlyMessage(error, context);
                UIManager.showError(userMessage);

                // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –∞–Ω–∞–ª–∏—Ç–∏–∫—É
                this.reportToAnalytics(errorInfo);
            }

            static getUserFriendlyMessage(error, context) {
                const messages = {
                    'NetworkError': '–ü—Ä–æ–±–ª–µ–º—ã —Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.',
                    'QuotaExceededError': '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤. –û—á–∏—Å—Ç–∏—Ç–µ –∫–µ—à –±—Ä–∞—É–∑–µ—Ä–∞.',
                    'SecurityError': '–û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞.',
                    'TypeError': '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–∏–µ —Ñ–∞–π–ª—ã.',
                    'RangeError': '–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.',
                    'InvalidFileType': `–§–∞–π–ª "${context.fileName}" –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.`,
                    'FileTooLarge': `–§–∞–π–ª "${context.fileName}" —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 100MB.`
                };

                return messages[error.name] || messages[error.message] || 
                       '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
            }

            static reportToAnalytics(errorInfo) {
                // –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π
                if (typeof gtag !== 'undefined') {
                    gtag('event', 'exception', {
                        description: errorInfo.message,
                        fatal: false
                    });
                }
            }
        }

        // ===============================
        // –ú–ï–ù–ï–î–ñ–ï–† –¢–ï–ú
        // ===============================
        class ThemeManager {
            static themes = {
                light: {
                    '--bg-primary': '#ffffff',
                    '--text-primary': '#333333',
                    '--accent-color': '#667eea',
                    '--success-color': '#27ae60',
                    '--error-color': '#e74c3c',
                    '--warning-color': '#e67e22'
                },
                dark: {
                    '--bg-primary': '#1a1a1a',
                    '--text-primary': '#ffffff',
                    '--accent-color': '#764ba2',
                    '--success-color': '#2ecc71',
                    '--error-color': '#e74c3c',
                    '--warning-color': '#f39c12'
                }
            };

            static init() {
                const savedTheme = localStorage.getItem('app-theme') || 'light';
                this.applyTheme(savedTheme);
                
                document.getElementById('themeToggle').addEventListener('click', () => {
                    this.toggleTheme();
                });
            }

            static applyTheme(themeName) {
                const theme = this.themes[themeName];
                if (!theme) return;

                const root = document.documentElement;
                Object.entries(theme).forEach(([property, value]) => {
                    root.style.setProperty(property, value);
                });
                
                root.setAttribute('data-theme', themeName);
                localStorage.setItem('app-theme', themeName);
                
                AdvancedLogger.info(`Theme changed to: ${themeName}`);
            }

            static toggleTheme() {
                const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                this.applyTheme(newTheme);
            }

            static getCurrentTheme() {
                return document.documentElement.getAttribute('data-theme') || 'light';
            }
        }

        // ===============================
        // –ö–ï–® –ú–ï–ù–ï–î–ñ–ï–†
        // ===============================
        class CacheManager {
            constructor() {
                this.cache = new Map();
                this.maxSize = 50; // –ú–∞–∫—Å–∏–º—É–º 50 —Ñ–∞–π–ª–æ–≤ –≤ –∫–µ—à–µ
                this.ttl = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç
            }

            set(key, value) {
                // –û—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∑–∞–ø–∏—Å–µ–π
                this.cleanup();
                
                if (this.cache.size >= this.maxSize) {
                    const firstKey = this.cache.keys().next().value;
                    this.cache.delete(firstKey);
                }
                
                this.cache.set(key, {
                    value,
                    timestamp: Date.now(),
                    size: this.calculateSize(value)
                });
                
                AdvancedLogger.debug(`Cache set: ${key}`);
            }

            get(key) {
                const item = this.cache.get(key);
                if (!item) {
                    AdvancedLogger.debug(`Cache miss: ${key}`);
                    return null;
                }

                if (Date.now() - item.timestamp > this.ttl) {
                    this.cache.delete(key);
                    AdvancedLogger.debug(`Cache expired: ${key}`);
                    return null;
                }

                AdvancedLogger.debug(`Cache hit: ${key}`);
                return item.value;
            }

            delete(key) {
                this.cache.delete(key);
            }

            clear() {
                this.cache.clear();
                AdvancedLogger.info('Cache cleared');
            }

            cleanup() {
                const now = Date.now();
                for (const [key, item] of this.cache.entries()) {
                    if (now - item.timestamp > this.ttl) {
                        this.cache.delete(key);
                    }
                }
            }

            calculateSize(value) {
                // –ü—Ä–æ—Å—Ç–∞—è –æ—Ü–µ–Ω–∫–∞ —Ä–∞–∑–º–µ—Ä–∞
                return JSON.stringify(value).length;
            }

            getStats() {
                return {
                    size: this.cache.size,
                    maxSize: this.maxSize,
                    memoryUsage: Array.from(this.cache.values()).reduce((sum, item) => sum + item.size, 0)
                };
            }
        }

        // ===============================
        // –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –ö–õ–ê–°–° APPSTATE
        // ===============================
        class AppState {
            constructor() {
                this.uploadedFiles = [];
                this.processedFilesStorage = [];
                this.isProcessing = false;
                this.currentProcessor = null;
                this.settings = this.loadSettings();
                this.eventBus = new EventBus();
                this.cacheManager = new CacheManager();
                
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.setupEventBus();
                this.updateStats();
                this.updateFileList();
                this.updateNamingExample();
                
                AdvancedLogger.info('AppState initialized');
            }

            setupEventBus() {
                this.eventBus.on('file.added', (file) => {
                    AdvancedLogger.info('File added', { name: file.name, size: file.size });
                });

                this.eventBus.on('file.removed', (file) => {
                    AdvancedLogger.info('File removed', { name: file.name });
                });

                this.eventBus.on('processing.started', () => {
                    AdvancedLogger.info('Processing started');
                    MetricsCollector.trackEvent('processing', 'started');
                });

                this.eventBus.on('processing.completed', (results) => {
                    AdvancedLogger.info('Processing completed', { fileCount: results.length });
                    MetricsCollector.trackEvent('processing', 'completed', `files:${results.length}`);
                });

                this.eventBus.on('error.occurred', (error) => {
                    ErrorHandler.handle(error);
                });
            }

            // –û—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –∫–ª–∞—Å—Å–∞ AppState –æ—Å—Ç–∞—é—Ç—Å—è, –Ω–æ —Å —É–ª—É—á—à–µ–Ω–∏—è–º–∏:
            
            async addFiles(newFiles) {
                if (this.uploadedFiles.length + newFiles.length > Config.defaults.maxFiles) {
                    const error = new Error(`–ú–∞–∫—Å–∏–º—É–º ${Config.defaults.maxFiles} —Ñ–∞–π–ª–æ–≤`);
                    error.name = 'TooManyFiles';
                    this.eventBus.emit('error.occurred', error);
                    return;
                }

                const validatedFiles = [];
                
                for (const file of newFiles) {
                    try {
                        FileValidator.validateFile(file);
                        file.customName = file.name.replace(/\.[^/.]+$/, "");
                        file.id = this.generateFileId();
                        
                        // –ö–µ—à–∏—Ä—É–µ–º –ø—Ä–µ–≤—å—é
                        const cachedThumbnail = this.cacheManager.get(`thumb_${file.id}`);
                        if (cachedThumbnail) {
                            file.thumbnail = cachedThumbnail;
                        } else {
                            file.thumbnail = await ThumbnailGenerator.createThumbnail(file);
                            this.cacheManager.set(`thumb_${file.id}`, file.thumbnail);
                        }
                        
                        validatedFiles.push(file);
                        this.eventBus.emit('file.added', file);
                        
                    } catch (error) {
                        ErrorHandler.handle(error, { fileName: file.name });
                    }
                }

                if (validatedFiles.length > 0) {
                    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤
                }
            }

            generateFileId() {
                return 'file_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            async startProcessing() {
                if (this.uploadedFiles.length === 0) {
                    const error = new Error('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã!');
                    this.eventBus.emit('error.occurred', error);
                    return;
                }

                if (this.isProcessing) {
                    const error = new Error('–û–±—Ä–∞–±–æ—Ç–∫–∞ —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è!');
                    this.eventBus.emit('error.occurred', error);
                    return;
                }

                this.isProcessing = true;
                this.currentProcessor = new MediaProcessor();
                this.processedFilesStorage = [];

                this.eventBus.emit('processing.started');
                MetricsCollector.trackPerformance('processing_start', performance.now());

                try {
                    await this.currentProcessor.processFiles(
                        this.uploadedFiles,
                        this.settings,
                        (progress) => {
                            UIManager.updateProgress(progress);
                            this.eventBus.emit('processing.progress', progress);
                        },
                        (processedFiles) => {
                            this.processedFilesStorage.push(...processedFiles);
                        }
                    );

                    this.eventBus.emit('processing.completed', this.processedFilesStorage);
                    UIManager.showResults(this.processedFilesStorage);
                    
                    MetricsCollector.trackPerformance('processing_end', performance.now());
                    MetricsCollector.trackEvent('processing', 'success', `files:${this.processedFilesStorage.length}`);

                } catch (error) {
                    ErrorHandler.handle(error, { context: 'file_processing' });
                    MetricsCollector.trackEvent('processing', 'failed', error.message);
                } finally {
                    this.isProcessing = false;
                    this.currentProcessor = null;
                    UIManager.showProcessingState(false);
                }
            }

            // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –∫–ª–∞—Å—Å–∞ AppState
        }

        // ===============================
        // –°–ò–°–¢–ï–ú–ê –ú–ï–¢–†–ò–ö
        // ===============================
        class MetricsCollector {
            static trackEvent(category, action, label = '') {
                const event = {
                    category,
                    action, 
                    label,
                    timestamp: Date.now(),
                    sessionId: AdvancedLogger.sessionId,
                    userAgent: navigator.userAgent
                };

                AdvancedLogger.info(`Event: ${category}.${action}`, event);

                // Google Analytics
                if (typeof gtag !== 'undefined') {
                    gtag('event', action, {
                        event_category: category,
                        event_label: label
                    });
                }

                // –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
                this.saveToStorage(event);
            }

            static trackPerformance(operation, startTime) {
                const duration = performance.now() - startTime;
                const event = {
                    category: 'performance',
                    action: operation,
                    label: `${duration.toFixed(2)}ms`,
                    duration: duration,
                    timestamp: Date.now()
                };

                AdvancedLogger.info(`Performance: ${operation}`, event);

                if (duration > 1000) { // –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
                    this.trackEvent('performance.slow', operation, duration);
                }
            }

            static saveToStorage(event) {
                try {
                    const metrics = JSON.parse(localStorage.getItem('app_metrics') || '[]');
                    metrics.push(event);
                    if (metrics.length > 500) metrics.shift();
                    localStorage.setItem('app_metrics', JSON.stringify(metrics));
                } catch (e) {
                    AdvancedLogger.warn('Failed to save metric', { error: e.message });
                }
            }
        }

        // ===============================
        // –û–ë–ù–û–í–õ–ï–ù–ù–´–ô UIMANAGER
        // ===============================
        class UIManager {
            static showProcessingState(isProcessing) {
                const processBtn = document.getElementById('processBtn');
                const progressContainer = document.getElementById('progressContainer');
                
                if (isProcessing) {
                    processBtn.disabled = true;
                    processBtn.innerHTML = '<div class="loading-spinner"></div> –û–±—Ä–∞–±–æ—Ç–∫–∞...';
                    processBtn.onclick = () => appState.cancelProcessing();
                    progressContainer.classList.remove('hidden');
                    progressContainer.classList.add('slide-in');
                } else {
                    processBtn.disabled = false;
                    processBtn.innerHTML = 'üöÄ –ù–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É';
                    processBtn.onclick = () => appState.startProcessing();
                    progressContainer.classList.add('hidden');
                    document.getElementById('progressBar').style.width = '0%';
                    document.getElementById('progressText').textContent = '';
                }
            }

            static updateProgress(percent) {
                const progressBar = document.getElementById('progressBar');
                const progressText = document.getElementById('progressText');
                
                progressBar.style.width = `${percent}%`;
                progressText.textContent = `–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${Math.round(percent)}%`;
                
                if (percent >= 100) {
                    progressText.innerHTML = '‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!';
                }
            }

            static showResults(files) {
                const result = document.getElementById('result');
                const resultFiles = document.getElementById('resultFiles');
                const downloadSection = document.getElementById('downloadSection');
                
                resultFiles.innerHTML = '';
                
                files.forEach((file, index) => {
                    setTimeout(() => {
                        const fileElement = this.createResultFileElement(file);
                        resultFiles.appendChild(fileElement);
                        fileElement.classList.add('slide-in');
                    }, index * 100);
                });

                result.classList.remove('hidden');
                result.classList.add('slide-in');
                downloadSection.classList.remove('hidden');
                downloadSection.classList.add('slide-in');
            }

            static createResultFileElement(file) {
                const originalSize = file.originalSize ? (file.originalSize / 1024 / 1024).toFixed(2) : 'N/A';
                const compressedSize = (file.blob.size / 1024 / 1024).toFixed(2);
                const compressionRatio = file.originalSize ? 
                    ((1 - file.blob.size / file.originalSize) * 100).toFixed(1) : 0;
                
                let sizeInfo = '';
                if (file.originalSize && file.blob.size !== file.originalSize) {
                    sizeInfo = `<span class="file-size-compression">(${originalSize}–ú–ë ‚Üí ${compressedSize}–ú–ë, -${compressionRatio}%)</span>`;
                }
                
                const fileElement = document.createElement('div');
                fileElement.className = 'result-file';
                fileElement.innerHTML = `
                    <div>
                        <span>‚úÖ ${appState.escapeHtml(file.name)}</span>
                        ${sizeInfo}
                    </div>
                    <button class="download-btn" data-file="${appState.escapeHtml(file.name)}">
                        üì• –°–∫–∞—á–∞—Ç—å
                    </button>
                `;
                
                fileElement.querySelector('button').addEventListener('click', () => {
                    appState.downloadSingleFile(file.name);
                    MetricsCollector.trackEvent('download', 'single', file.name);
                });
                
                return fileElement;
            }

            static showSuccess(title, message) {
                this.showMessage('success', title, message);
                MetricsCollector.trackEvent('ui', 'success', title);
            }

            static showError(message) {
                this.showMessage('error', '–û—à–∏–±–∫–∞', message);
                MetricsCollector.trackEvent('ui', 'error', message);
            }

            static showMessage(type, title, message) {
                const oldMessages = document.querySelectorAll('.temp-message');
                oldMessages.forEach(msg => msg.remove());

                const messageDiv = document.createElement('div');
                messageDiv.className = `temp-message ${type}-message slide-in`;
                messageDiv.innerHTML = `
                    <strong>${title}</strong><br>
                    ${message}
                `;

                const container = document.querySelector('.container');
                container.insertBefore(messageDiv, container.firstChild);

                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.style.opacity = '0';
                        messageDiv.style.transition = 'opacity 0.3s ease';
                        setTimeout(() => messageDiv.remove(), 300);
                    }
                }, 5000);
            }
        }

        // ===============================
        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
        // ===============================
        let appState;

        document.addEventListener('DOMContentLoaded', () => {
            try {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–º
                ThemeManager.init();
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                appState = new AppState();
                
                // –¢—Ä–µ–∫–∏–Ω–≥ –Ω–∞—á–∞–ª–∞ —Å–µ—Å—Å–∏–∏
                MetricsCollector.trackEvent('session', 'started');
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ window
                window.addEventListener('error', (event) => {
                    ErrorHandler.handle(event.error, { context: 'window_error' });
                });
                
                window.addEventListener('unhandledrejection', (event) => {
                    ErrorHandler.handle(event.reason, { context: 'unhandled_promise' });
                });

                // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
                window.addEventListener('beforeunload', () => {
                    MetricsCollector.trackEvent('session', 'ended');
                    appState.uploadedFiles.forEach(file => {
                        if (file.objectURL) URL.revokeObjectURL(file.objectURL);
                        if (file.thumbnail?.startsWith('blob:')) URL.revokeObjectURL(file.thumbnail);
                    });
                });

                AdvancedLogger.info('Application initialized successfully');

            } catch (error) {
                console.error('Failed to initialize application:', error);
                ErrorHandler.handle(error, { context: 'app_initialization' });
            }
        });

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–ª–∞—Å—Å—ã (ImageProcessor, FileValidator –∏ —Ç.–¥.)
        // —Å –Ω–µ–±–æ–ª—å—à–∏–º–∏ —É–ª—É—á—à–µ–Ω–∏—è–º–∏...

        class ImageProcessor {
            static async fitImageWithBackground(file, targetWidth, targetHeight, format, backgroundColor) {
                const cacheKey = `img_${file.name}_${targetWidth}x${targetHeight}_${format}_${backgroundColor}`;
                const cached = appState.cacheManager.get(cacheKey);
                if (cached) {
                    AdvancedLogger.debug('Image from cache', { cacheKey });
                    return cached;
                }

                try {
                    const result = await this.processImageWithCanvas(file, targetWidth, targetHeight, format, backgroundColor);
                    appState.cacheManager.set(cacheKey, result);
                    return result;
                } catch (error) {
                    ErrorHandler.handle(error, { 
                        context: 'image_processing',
                        fileName: file.name,
                        dimensions: `${targetWidth}x${targetHeight}`,
                        format: format
                    });
                    throw error;
                }
            }

            static processImageWithCanvas(file, targetWidth, targetHeight, format, backgroundColor) {
                return new Promise((resolve, reject) => {
                    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
                });
            }
        }

        // –û—Å—Ç–∞–ª—å–Ω—ã–µ –∫–ª–∞—Å—Å—ã (FileValidator, ThumbnailGenerator, MediaProcessor, 
        // AIService, FileUtils, FileDownloader) –æ—Å—Ç–∞—é—Ç—Å—è —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏
    </script>
</body>
</html>
