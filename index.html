<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MediaProcessor | Relation-AI</title>

  <!-- ZIP -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <!-- FFmpeg (—Å–∞–º–æ—Ö–æ—Å—Ç–∏–Ω–≥ –∏–∑ /ffmpeg/) -->
  <script src="/ffmpeg/ffmpeg.min.js"></script>

  <style>
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    body{margin:0;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:26px 14px}
    .app{max-width:1200px;margin:0 auto;background:#fff;border-radius:18px;box-shadow:0 18px 55px rgba(0,0,0,.18);overflow:hidden}
    header{padding:18px 18px 14px;background:linear-gradient(135deg,#111827 0%,#1f2937 100%);color:#fff;display:flex;gap:12px;align-items:center;justify-content:space-between}
    header .t{font-weight:800;letter-spacing:.2px}
    header .s{opacity:.85;font-size:12.5px;margin-top:3px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:rgba(255,255,255,.12);font-size:12.5px;white-space:nowrap}
    .dot{width:10px;height:10px;border-radius:50%;background:#f59e0b}
    .dot.ok{background:#10b981}
    .dot.bad{background:#ef4444}

    .grid{display:grid;grid-template-columns:1.05fr .95fr;gap:14px;padding:16px}
    @media (max-width:1000px){.grid{grid-template-columns:1fr}}

    .card{border:1px solid #e5e7eb;border-radius:16px;padding:14px;background:#fff}
    .card h3{margin:0 0 10px;font-size:14px;color:#111827}
    .muted{color:#6b7280;font-size:12.5px;line-height:1.35}
    .hr{height:1px;background:#e5e7eb;margin:12px 0}

    .drop{border:2px dashed #c7d2fe;border-radius:16px;padding:16px;text-align:center;background:linear-gradient(180deg,#eef2ff 0%,#fff 100%);transition:.15s}
    .drop.drag{border-color:#6366f1;transform:scale(1.005)}
    .drop strong{display:block;margin-bottom:6px}

    label{display:block;font-size:12px;color:#374151;margin:10px 0 6px}
    input,select,textarea,button{width:100%;border:1px solid #e5e7eb;border-radius:12px;padding:10px 10px;font-size:13px;outline:none}
    input:focus,select:focus,textarea:focus{border-color:#818cf8;box-shadow:0 0 0 3px rgba(129,140,248,.18)}
    textarea{height:230px;resize:vertical;font-family:ui-monospace,Menlo,Monaco,Consolas,monospace;font-size:12px;background:#0b1020;color:#d1d5db;border:none}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .btns{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px}
    button{cursor:pointer;border:none;font-weight:700}
    .primary{background:#4f46e5;color:#fff}
    .ghost{background:#eef2ff;color:#111827}
    .danger{background:#fee2e2;color:#991b1b}
    button:disabled{opacity:.55;cursor:not-allowed}

    .files{margin-top:10px;max-height:230px;overflow:auto;border-top:1px dashed #e5e7eb;padding-top:10px}
    .file{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:8px 0;border-bottom:1px dashed #f1f5f9}
    .file b{font-size:13px}
    .tag{font-size:11px;color:#111827;background:#f3f4f6;padding:4px 8px;border-radius:999px}
    .warn{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;border-radius:12px;padding:10px;font-size:12px;line-height:1.35;margin-top:10px}
    .okbox{background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46;border-radius:12px;padding:10px;font-size:12px;line-height:1.35;margin-top:10px}
  </style>
</head>

<body>
  <div class="app">
    <header>
      <div>
        <div class="t">MediaProcessor | Relation-AI</div>
        <div class="s">–ö–∞—Ä—Ç–∏–Ω–∫–∏ (Canvas) ‚Ä¢ –í–∏–¥–µ–æ/–ê—É–¥–∏–æ (FFmpeg WASM) ‚Ä¢ ZIP</div>
      </div>
      <div class="pill" title="–°—Ç–∞—Ç—É—Å FFmpeg">
        <span id="ffDot" class="dot"></span>
        <span id="ffText">FFmpeg: –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</span>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <h3>–§–∞–π–ª—ã</h3>

        <div id="drop" class="drop">
          <strong>–ü–µ—Ä–µ—Ç–∞—â–∏ —Ñ–∞–π–ª—ã —Å—é–¥–∞</strong>
          <div class="muted">–∏–ª–∏ –≤—ã–±–µ—Ä–∏ –∫–Ω–æ–ø–∫–æ–π –Ω–∏–∂–µ</div>
          <div style="margin-top:10px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
            <label style="width:auto;margin:0">
              <span style="display:inline-block;background:#111827;color:#fff;padding:10px 12px;border-radius:12px;font-weight:700;cursor:pointer">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã</span>
              <input id="picker" type="file" multiple style="display:none">
            </label>
            <button id="btnClear" class="ghost" type="button" style="width:auto">–û—á–∏—Å—Ç–∏—Ç—å</button>
          </div>
          <div class="muted" style="margin-top:8px">
            –í–∞–∂–Ω–æ: –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–π –∫–∞–∫ <b>file://</b> ‚Äî —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Vercel (https://‚Ä¶)
          </div>
        </div>

        <div class="files" id="fileList"></div>

        <div class="hr"></div>

        <div class="btns">
          <button id="btnInit" class="ghost" type="button">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å FFmpeg</button>
          <button id="btnProcess" class="primary" type="button" disabled>–û–±—Ä–∞–±–æ—Ç–∞—Ç—å ‚Üí ZIP</button>
          <button id="btnDownload" class="ghost" type="button" disabled>–°–∫–∞—á–∞—Ç—å ZIP</button>
        </div>

        <div id="protoWarn" class="warn" style="display:none">
          –û—Ç–∫—Ä—ã—Ç–æ –∫–∞–∫ <b>file://</b>. FFmpeg –Ω–µ —Å–º–æ–∂–µ—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—å core/worker/wasm. –û—Ç–∫—Ä–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ Vercel (https://‚Ä¶).
        </div>

        <div id="readyOk" class="okbox" style="display:none">
          –ì–æ—Ç–æ–≤–æ. ZIP —Å–æ–±—Ä–∞–Ω ‚Äî –∂–º–∏ ¬´–°–∫–∞—á–∞—Ç—å ZIP¬ª.
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏</h3>

        <label>–†–µ–∂–∏–º</label>
        <select id="mode">
          <option value="auto" selected>–ê–≤—Ç–æ (–ø–æ —Ç–∏–ø—É —Ñ–∞–π–ª–∞)</option>
          <option value="image">–¢–æ–ª—å–∫–æ –∫–∞—Ä—Ç–∏–Ω–∫–∏</option>
          <option value="video">–¢–æ–ª—å–∫–æ –≤–∏–¥–µ–æ</option>
          <option value="audio">–¢–æ–ª—å–∫–æ –∞—É–¥–∏–æ</option>
        </select>

        <div class="hr"></div>

        <!-- Naming -->
        <h3 style="margin:0 0 8px;">–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</h3>

        <label>–ë–∞–∑–æ–≤–æ–µ –∏–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: logo –∏–ª–∏ audio_hook)</label>
        <input id="baseName" value="output" />

        <label>–°—Ö–µ–º–∞ –∏–º–µ–Ω–∏</label>
        <select id="nameMode">
          <option value="original">–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª</option>
          <option value="base_index" selected>base_1, base_2‚Ä¶</option>
          <option value="base_digits">base + —Ü–∏—Ñ—Ä—ã –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ (audio_hook333)</option>
        </select>

        <div class="row">
          <div>
            <label>–°—Ç–∞—Ä—Ç–æ–≤—ã–π –Ω–æ–º–µ—Ä (base_1‚Ä¶)</label>
            <input id="startN" type="number" min="1" value="1" />
          </div>
          <div>
            <label>–î–æ–±–∞–≤–ª—è—Ç—å —Ä–∞–∑–º–µ—Ä –≤ –∏–º—è</label>
            <select id="addSize">
              <option value="no" selected>–Ω–µ—Ç</option>
              <option value="yes">–¥–∞ (‚Ä¶_640x360)</option>
            </select>
          </div>
        </div>

        <div class="hr"></div>

        <!-- Image settings -->
        <h3 style="margin:0 0 8px;">–ö–∞—Ä—Ç–∏–Ω–∫–∏</h3>
        <div class="row">
          <div>
            <label>–†–∞–∑–º–µ—Ä—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
            <input id="imgSizes" value="1200x1200" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 200x150,300x250,1200x1200" />
            <div class="muted">–ú–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑–º–µ—Ä–æ–≤ –∑–∞ –æ–¥–∏–Ω –∑–∞–ø—É—Å–∫.</div>
          </div>
          <div>
            <label>–§–æ—Ä–º–∞—Ç</label>
            <select id="imgFmt">
              <option value="png" selected>png</option>
              <option value="jpg">jpg</option>
              <option value="webp">webp</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>–†–µ–∂–∏–º –ø–æ–¥–≥–æ–Ω–∫–∏</label>
            <select id="imgFit">
              <option value="contain" selected>Contain (–±–µ–∑ –æ–±—Ä–µ–∑–∫–∏, —Å –ø–æ–ª—è–º–∏)</option>
              <option value="cover">Cover (–æ–±—Ä–µ–∑–∫–∞ –ø–æ –∫—Ä–∞—è–º)</option>
              <option value="stretch">Stretch (—Ä–∞—Å—Ç—è–Ω—É—Ç—å)</option>
            </select>
          </div>
          <div>
            <label>–§–æ–Ω (–¥–ª—è JPG / –ø–æ–ª–µ–π)</label>
            <input id="imgBg" value="#ffffff" />
          </div>
        </div>

        <div class="hr"></div>

        <!-- Video settings -->
        <h3 style="margin:0 0 8px;">–í–∏–¥–µ–æ</h3>
        <div class="row">
          <div>
            <label>–†–∞–∑–º–µ—Ä—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
            <input id="vidSizes" value="640x360" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 640x360,1280x720" />
          </div>
          <div>
            <label>–§–æ—Ä–º–∞—Ç</label>
            <select id="vidFmt">
              <option value="mp4" selected>mp4</option>
              <option value="webm">webm</option>
            </select>
          </div>
        </div>

        <div class="row3">
          <div>
            <label>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏</label>
            <select id="keepAR">
              <option value="yes" selected>–¥–∞ (contain+pad)</option>
              <option value="no">–Ω–µ—Ç (stretch)</option>
            </select>
          </div>
          <div>
            <label>CRF (–∫–∞—á–µ—Å—Ç–≤–æ)</label>
            <select id="crf">
              <option value="18">18 (–≤—ã—Å–æ–∫–æ)</option>
              <option value="23" selected>23 (–Ω–æ—Ä–º–∞)</option>
              <option value="28">28 (—ç–∫–æ–Ω–æ–º)</option>
            </select>
          </div>
          <div>
            <label>FPS (0 = –Ω–µ –º–µ–Ω—è—Ç—å)</label>
            <input id="fps" type="number" min="0" value="0" />
          </div>
        </div>

        <div class="hr"></div>

        <!-- Audio settings -->
        <h3 style="margin:0 0 8px;">–ê—É–¥–∏–æ</h3>
        <div class="row">
          <div>
            <label>–§–æ—Ä–º–∞—Ç</label>
            <select id="audFmt">
              <option value="mp3" selected>mp3</option>
              <option value="ogg">ogg</option>
            </select>
          </div>
          <div>
            <label>–ë–∏—Ç—Ä–µ–π—Ç (–¥–ª—è mp3)</label>
            <select id="audBr">
              <option value="128k">128k</option>
              <option value="192k" selected>192k</option>
              <option value="256k">256k</option>
              <option value="320k">320k</option>
            </select>
          </div>
        </div>

        <label>Sample rate (0 = –Ω–µ –º–µ–Ω—è—Ç—å)</label>
        <input id="audSr" type="number" min="0" value="0" />

        <div class="hr"></div>

        <h3 style="margin:0 0 8px;">–õ–æ–≥–∏</h3>
        <textarea id="log" readonly></textarea>
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  const logEl = $("log");
  function log(msg){
    const line = `[${new Date().toLocaleTimeString()}] ${msg}`;
    logEl.value += line + "\\n";
    logEl.scrollTop = logEl.scrollHeight;
    console.log(line);
  }

  // ---------- helpers ----------
  function safeName(s){
    return (s || "output").trim().replace(/[\\/:*?"<>|]+/g,"_").replace(/\\s+/g,"_");
  }
  function stripExt(n){ return (n || "").replace(/\\.[^/.]+$/,""); }
  function firstDigits(n){
    const m = String(n).match(/(\\d+)/);
    return m ? m[1] : "";
  }
  function parseSizes(s){
    return String(s||"")
      .split(",")
      .map(x=>x.trim().toLowerCase())
      .filter(Boolean)
      .map(x=>{
        const m = x.match(/^(\\d+)\\s*x\\s*(\\d+)$/);
        if(!m) return null;
        const w = parseInt(m[1],10), h = parseInt(m[2],10);
        if(!w || !h) return null;
        return {w,h,label:`${w}x${h}`};
      })
      .filter(Boolean);
  }
  function kindOf(file){
    const t = (file.type||"").toLowerCase();
    const n = (file.name||"").toLowerCase();
    if(t.startsWith("image/") || /\\.(png|jpg|jpeg|webp|gif|bmp)$/i.test(n)) return "image";
    if(t.startsWith("video/") || /\\.(mp4|mov|mkv|webm|avi|m4v)$/i.test(n)) return "video";
    if(t.startsWith("audio/") || /\\.(mp3|wav|ogg|m4a|aac|flac)$/i.test(n)) return "audio";
    return "other";
  }
  function formatBytes(bytes){
    const u=["B","KB","MB","GB"]; let i=0,n=bytes;
    while(n>=1024 && i<u.length-1){ n/=1024; i++; }
    return `${n.toFixed(i?1:0)} ${u[i]}`;
  }
  function downloadBlob(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1500);
  }

  // ---------- file UI ----------
  const drop = $("drop");
  const picker = $("picker");
  const fileList = $("fileList");
  let files = [];
  let zipBlob = null;

  function renderFiles(){
    fileList.innerHTML = "";
    if(!files.length){
      fileList.innerHTML = `<div class="muted">–§–∞–π–ª—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.</div>`;
      $("btnProcess").disabled = true;
      return;
    }
    files.forEach((f,idx)=>{
      const row = document.createElement("div");
      row.className = "file";
      const k = kindOf(f);
      row.innerHTML = `
        <div style="min-width:0">
          <b style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="${f.name}">${f.name}</b>
          <div class="muted">${k} ‚Ä¢ ${formatBytes(f.size)} ‚Ä¢ ${f.type || "unknown"}</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <span class="tag">${k}</span>
          <button class="danger" style="width:auto;padding:8px 10px" type="button">‚úï</button>
        </div>
      `;
      row.querySelector("button").onclick = ()=>{
        files.splice(idx,1);
        renderFiles();
      };
      fileList.appendChild(row);
    });
    $("btnProcess").disabled = false;
  }

  function addFiles(list){
    if(!list.length) return;
    files.push(...list);
    renderFiles();
    log(`–î–æ–±–∞–≤–ª–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: ${list.length} (–≤—Å–µ–≥–æ: ${files.length})`);
  }

  drop.addEventListener("dragover",(e)=>{e.preventDefault(); drop.classList.add("drag");});
  drop.addEventListener("dragleave",()=>drop.classList.remove("drag"));
  drop.addEventListener("drop",(e)=>{
    e.preventDefault(); drop.classList.remove("drag");
    addFiles(Array.from(e.dataTransfer.files || []));
  });
  picker.addEventListener("change",(e)=>{
    addFiles(Array.from(e.target.files || []));
    picker.value = "";
  });

  $("btnClear").onclick = ()=>{
    files = [];
    zipBlob = null;
    $("btnDownload").disabled = true;
    $("readyOk").style.display = "none";
    logEl.value = "";
    log("–û—á–∏—â–µ–Ω–æ.");
    renderFiles();
  };

  // ---------- FFmpeg init ----------
  let ffmpeg = null;
  let ffReady = false;

  function setFF(state, text){
    const dot = $("ffDot");
    dot.classList.remove("ok","bad");
    if(state==="ok") dot.classList.add("ok");
    if(state==="bad") dot.classList.add("bad");
    $("ffText").textContent = text;
  }

  async function ensureFFmpeg(){
    if(ffReady) return true;

    if(location.protocol === "file:"){
      $("protoWarn").style.display = "block";
      setFF("bad","FFmpeg: file:// –Ω–µ–ª—å–∑—è");
      throw new Error("–û—Ç–∫—Ä—ã—Ç–æ –∫–∞–∫ file://");
    }

    if(!window.FFmpeg || typeof window.FFmpeg.createFFmpeg !== "function"){
      setFF("bad","FFmpeg: –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
      throw new Error("–ù–µ –Ω–∞–π–¥–µ–Ω FFmpeg.createFFmpeg (–ø—Ä–æ–≤–µ—Ä—å /ffmpeg/ffmpeg.min.js)");
    }

    const corePath = new URL("/ffmpeg/ffmpeg-core.js", location.origin).toString();

    setFF("", "FFmpeg: –∑–∞–≥—Ä—É–∂–∞—é‚Ä¶");
    log("–ó–∞–≥—Ä—É–∂–∞—é FFmpeg core: " + corePath);

    ffmpeg = window.FFmpeg.createFFmpeg({
      log: true,
      corePath
    });

    ffmpeg.setLogger(({ type, message }) => {
      if(type === "fferr") log("fferr: " + message);
    });

    await ffmpeg.load();
    ffReady = true;
    setFF("ok","FFmpeg: –≥–æ—Ç–æ–≤");
    log("FFmpeg –≥–æ—Ç–æ–≤ ‚úÖ");
    return true;
  }

  $("btnInit").onclick = async ()=>{
    try { await ensureFFmpeg(); }
    catch(e){ log("FFmpeg init error: " + (e?.message || e)); }
  };

  // ---------- naming ----------
  function outName(fileBase, idx1, ext, sizeLabel){
    const mode = $("nameMode").value;
    const base = safeName($("baseName").value);
    const startN = Math.max(1, parseInt($("startN").value || "1",10));
    const addSize = $("addSize").value === "yes";
    const order = startN + (idx1 - 1);

    let name;
    if(mode === "original"){
      name = safeName(fileBase);
    } else if(mode === "base_digits"){
      const d = firstDigits(fileBase);
      name = d ? `${base}${d}` : `${base}${order}`;
    } else {
      name = `${base}_${order}`;
    }

    if(addSize && sizeLabel) name += `_${sizeLabel}`;
    return `${name}.${ext}`;
  }

  // ---------- image: canvas ----------
  async function toImageBlob(file, w, h, fmt, fit, bg){
    const bmp = await createImageBitmap(file);
    const canvas = document.createElement("canvas");
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext("2d");

    // background
    if(fmt === "jpg" || fmt === "jpeg"){
      ctx.fillStyle = bg || "#ffffff";
      ctx.fillRect(0,0,w,h);
    } else {
      // –¥–ª—è contain/cover —Å –ø–æ–ª—è–º–∏ ‚Äî –º–æ–∂–Ω–æ —Ç–æ–∂–µ –∑–∞–ª–∏–≤–∞—Ç—å
      ctx.fillStyle = bg || "rgba(0,0,0,0)";
      ctx.fillRect(0,0,w,h);
    }

    const sw = bmp.width, sh = bmp.height;

    if(fit === "stretch"){
      ctx.drawImage(bmp, 0,0,w,h);
    } else {
      const scale = (fit === "cover") ? Math.max(w/sw, h/sh) : Math.min(w/sw, h/sh);
      const dw = Math.round(sw * scale);
      const dh = Math.round(sh * scale);
      const dx = Math.round((w - dw)/2);
      const dy = Math.round((h - dh)/2);
      ctx.drawImage(bmp, dx, dy, dw, dh);
    }

    const mime = fmt === "jpg" ? "image/jpeg" : fmt === "webp" ? "image/webp" : "image/png";
    const quality = (fmt === "jpg" || fmt === "webp") ? 0.92 : undefined;
    const blob = await new Promise(res => canvas.toBlob(res, mime, quality));
    if(!blob) throw new Error("Canvas toBlob –≤–µ—Ä–Ω—É–ª null");
    return blob;
  }

  // ---------- ffmpeg helpers ----------
  async function readAsUint8(file){
    const buf = await file.arrayBuffer();
    return new Uint8Array(buf);
  }
  function guessExt(name){
    const m = String(name||"").toLowerCase().match(/\\.([a-z0-9]+)$/);
    return m ? m[1] : "bin";
  }
  function safeUnlink(p){ try{ ffmpeg.FS("unlink", p); } catch(_){} }

  async function processVideoFF(file, w, h, fmt, keepAR, crf, fps){
    await ensureFFmpeg();

    const inExt = guessExt(file.name);
    const inName = `in_${Date.now()}_${Math.random().toString(16).slice(2)}.${inExt}`;
    const outName = `out_${Date.now()}_${Math.random().toString(16).slice(2)}.${fmt}`;

    ffmpeg.FS("writeFile", inName, await window.FFmpeg.fetchFile(file));

    const vf = keepAR
      ? `scale=${w}:${h}:force_original_aspect_ratio=decrease,pad=${w}:${h}:(ow-iw)/2:(oh-ih)/2,setsar=1`
      : `scale=${w}:${h},setsar=1`;

    const args = ["-i", inName, "-vf", vf];

    if(fps && fps > 0) args.push("-r", String(fps));

    if(fmt === "mp4"){
      args.push(
        "-pix_fmt","yuv420p",
        "-movflags","+faststart",
        "-c:v","libx264","-preset","veryfast","-crf", String(crf),
        "-c:a","aac","-b:a","128k",
        outName
      );
    } else {
      args.push(
        "-c:v","libvpx-vp9","-crf","33","-b:v","0",
        "-c:a","libopus","-b:a","96k",
        outName
      );
    }

    log("FFmpeg video cmd: ffmpeg " + args.join(" "));

    try{
      await ffmpeg.run(...args);
    } catch(e){
      // fallback (–µ—Å–ª–∏ –Ω–µ—Ç libx264/libvpx-vp9)
      log("‚ö†Ô∏è primary video –∫–æ–¥–µ–∫ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, fallback‚Ä¶ " + (e?.message || e));
      safeUnlink(outName);
      const fb = ["-i", inName, "-vf", vf];
      if(fps && fps > 0) fb.push("-r", String(fps));
      if(fmt === "mp4"){
        fb.push("-c:v","mpeg4","-q:v","6","-c:a","aac","-b:a","128k", outName);
      } else {
        fb.push("-c:v","libvpx","-b:v","1200k","-c:a","libvorbis","-q:a","4", outName);
      }
      log("FFmpeg video fallback: ffmpeg " + fb.join(" "));
      await ffmpeg.run(...fb);
    }

    const data = ffmpeg.FS("readFile", outName);
    safeUnlink(inName);
    safeUnlink(outName);

    const mime = fmt === "mp4" ? "video/mp4" : "video/webm";
    return new Blob([data.buffer], { type: mime });
  }

  async function processAudioFF(file, fmt, br, sr){
    await ensureFFmpeg();

    const inExt = guessExt(file.name);
    const inName = `in_${Date.now()}_${Math.random().toString(16).slice(2)}.${inExt}`;
    const outName = `out_${Date.now()}_${Math.random().toString(16).slice(2)}.${fmt}`;

    ffmpeg.FS("writeFile", inName, await window.FFmpeg.fetchFile(file));

    const args = ["-i", inName, "-vn"];
    if(sr && sr > 0) args.push("-ar", String(sr));

    if(fmt === "mp3"){
      args.push("-c:a","libmp3lame","-b:a", br, outName);
    } else {
      args.push("-c:a","libvorbis","-q:a","4", outName);
    }

    log("FFmpeg audio cmd: ffmpeg " + args.join(" "));

    try{
      await ffmpeg.run(...args);
    } catch(e){
      log("‚ö†Ô∏è primary audio –∫–æ–¥–µ–∫ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, fallback‚Ä¶ " + (e?.message || e));
      safeUnlink(outName);
      const fb = ["-i", inName, "-vn"];
      if(sr && sr > 0) fb.push("-ar", String(sr));
      if(fmt === "mp3"){
        fb.push("-b:a", br, outName);
      } else {
        fb.push(outName);
      }
      log("FFmpeg audio fallback: ffmpeg " + fb.join(" "));
      await ffmpeg.run(...fb);
    }

    const data = ffmpeg.FS("readFile", outName);
    safeUnlink(inName);
    safeUnlink(outName);

    const mime = fmt === "mp3" ? "audio/mpeg" : "audio/ogg";
    return new Blob([data.buffer], { type: mime });
  }

  // ---------- main process ----------
  $("btnProcess").onclick = async ()=>{
    if(!files.length) return;

    $("readyOk").style.display = "none";
    $("btnDownload").disabled = true;
    zipBlob = null;

    const mode = $("mode").value;
    const imgSizes = parseSizes($("imgSizes").value);
    const imgFmt = $("imgFmt").value;
    const imgFit = $("imgFit").value;
    const imgBg = $("imgBg").value;

    const vidSizes = parseSizes($("vidSizes").value);
    const vidFmt = $("vidFmt").value;
    const keepAR = $("keepAR").value === "yes";
    const crf = parseInt($("crf").value,10);
    const fps = parseInt($("fps").value || "0",10);

    const audFmt = $("audFmt").value;
    const audBr = $("audBr").value;
    const audSr = parseInt($("audSr").value || "0",10);

    // –í–∞–ª–∏–¥–∞—Ü–∏–∏
    if(mode === "image" || mode === "auto"){
      if(imgSizes.length === 0){
        log("‚ö†Ô∏è –£–∫–∞–∂–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ä–∞–∑–º–µ—Ä –∫–∞—Ä—Ç–∏–Ω–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä 1200x1200).");
      }
    }
    if(mode === "video" || mode === "auto"){
      if(vidSizes.length === 0){
        log("‚ö†Ô∏è –£–∫–∞–∂–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ä–∞–∑–º–µ—Ä –≤–∏–¥–µ–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä 640x360).");
      }
    }

    log("‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏‚Ä¶");
    const zip = new JSZip();

    let outIndex = 1;

    // –∑–∞—Ä–∞–Ω–µ–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º FFmpeg, –µ—Å–ª–∏ —Ä–µ–∞–ª—å–Ω–æ –µ—Å—Ç—å –≤–∏–¥–µ–æ/–∞—É–¥–∏–æ –≤ –ø–∞—á–∫–µ
    const needsFF = files.some(f => {
      const k = kindOf(f);
      if(mode === "image") return false;
      if(mode === "video") return k === "video";
      if(mode === "audio") return k === "audio";
      return (k === "video" || k === "audio");
    });

    if(needsFF){
      try { await ensureFFmpeg(); }
      catch(e){
        log("‚ùå FFmpeg –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: " + (e?.message || e));
        log("   –í–∏–¥–µ–æ/–∞—É–¥–∏–æ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ ZIP –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.");
      }
    }

    for(const f of files){
      const k = kindOf(f);
      const fileBase = safeName(stripExt(f.name));

      // —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ä–µ–∂–∏–º—É
      if(mode !== "auto" && k !== mode) continue;

      try{
        if(k === "image"){
          for(const sz of imgSizes){
            const blob = await toImageBlob(f, sz.w, sz.h, imgFmt, imgFit, imgBg);
            const name = outName(fileBase, outIndex++, imgFmt, sz.label);
            zip.file(name, blob);
            log(`‚úÖ IMG ${f.name} ‚Üí ${name}`);
          }
        }
        else if(k === "video"){
          if(!ffReady){
            const name = outName(fileBase, outIndex++, guessExt(f.name), null);
            zip.file(name, f);
            log(`‚ö†Ô∏è VID –±–µ–∑ FFmpeg ‚Üí –æ—Ä–∏–≥–∏–Ω–∞–ª: ${name}`);
          } else {
            for(const sz of vidSizes){
              const blob = await processVideoFF(f, sz.w, sz.h, vidFmt, keepAR, crf, fps);
              const name = outName(fileBase, outIndex++, vidFmt, sz.label);
              zip.file(name, blob);
              log(`‚úÖ VID ${f.name} ‚Üí ${name}`);
            }
          }
        }
        else if(k === "audio"){
          if(!ffReady){
            const name = outName(fileBase, outIndex++, guessExt(f.name), null);
            zip.file(name, f);
            log(`‚ö†Ô∏è AUD –±–µ–∑ FFmpeg ‚Üí –æ—Ä–∏–≥–∏–Ω–∞–ª: ${name}`);
          } else {
            const blob = await processAudioFF(f, audFmt, audBr, audSr);
            const name = outName(fileBase, outIndex++, audFmt, null);
            zip.file(name, blob);
            log(`‚úÖ AUD ${f.name} ‚Üí ${name}`);
          }
        }
        else {
          const name = outName(fileBase, outIndex++, guessExt(f.name), null);
          zip.file(name, f);
          log(`‚ÑπÔ∏è OTHER ‚Üí –∫–∞–∫ –µ—Å—Ç—å: ${name}`);
        }
      } catch(e){
        log(`‚ùå –û—à–∏–±–∫–∞ –Ω–∞ ${f.name}: ${e?.message || e}`);
        const name = outName(fileBase, outIndex++, guessExt(f.name), null);
        zip.file(name, f);
        log(`‚Ü©Ô∏è –î–æ–±–∞–≤–∏–ª –æ—Ä–∏–≥–∏–Ω–∞–ª: ${name}`);
      }
    }

    log("üì¶ –°–æ–±–∏—Ä–∞—é ZIP‚Ä¶");
    zipBlob = await zip.generateAsync({ type:"blob" });
    $("btnDownload").disabled = false;
    $("readyOk").style.display = "block";
    log("‚úÖ ZIP –≥–æ—Ç–æ–≤.");
  };

  $("btnDownload").onclick = ()=>{
    if(!zipBlob) return;
    downloadBlob(zipBlob, `MediaProcessor_${Date.now()}.zip`);
  };

  // ---------- init ----------
  function init(){
    if(location.protocol === "file:"){
      $("protoWarn").style.display = "block";
      setFF("bad","FFmpeg: file:// –Ω–µ–ª—å–∑—è");
    } else {
      setFF("", "FFmpeg: –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω");
    }
    renderFiles();
  }
  init();
</script>
</body>
</html>
