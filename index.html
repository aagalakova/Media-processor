<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediaProcessor | Relation-AI</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* –í—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è */
        
        .resize-mode-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .resize-mode-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .resize-mode-option:hover {
            border-color: #3498db;
            background: #e3f2fd;
        }

        .resize-mode-option.selected {
            border-color: #27ae60;
            background: #d4edda;
        }

        .mode-description {
            font-size: 0.8em;
            color: #666;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –û—Å—Ç–∞–ª—å–Ω–∞—è —Ä–∞–∑–º–µ—Ç–∫–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
        
        <div class="settings">
            <div class="naming-section">
                <h3>üè∑Ô∏è –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤</h3>
                <p style="color: #666; margin-bottom: 10px;">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞ –≤ —Å–ø–∏—Å–∫–µ –≤—ã—à–µ</p>
                <div class="naming-example">
                    –ü—Ä–∏–º–µ—Ä –∏–º–µ–Ω –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏: <strong>logo.png</strong>, <strong>banner.jpg</strong>, <strong>image2.png</strong>
                </div>
            </div>

            <!-- AI –°–µ–∫—Ü–∏—è -->
            <div class="ai-section">
                <h3>üß† AI-–ê–Ω–∞–ª–∏–∑ –±—Ä–µ–Ω–¥–∞</h3>
                <div class="ai-feature">
                    <input type="checkbox" id="aiAnalysis">
                    <label for="aiAnalysis">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ü–≤–µ—Ç–∞ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</label>
                </div>
                <div class="ai-feature">
                    <input type="checkbox" id="smartRenaming">
                    <label for="smartRenaming">–£–º–Ω–æ–µ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ</label>
                </div>
                <button class="upload-btn" onclick="analyzeBrandAssets()" style="background: #9b59b6;">
                    üîç –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –±—Ä–µ–Ω–¥
                </button>
            </div>

            <div class="settings-section">
                <h3>üì∑ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</h3>
                <input type="text" class="size-input" id="imageSizes" 
                       value="1200x600, 800x400, 400x200" 
                       placeholder="–í–≤–µ–¥–∏—Ç–µ —Ä–∞–∑–º–µ—Ä—ã —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é">
                
                <div class="preset-buttons">
                    <button class="preset-btn" onclick="loadPreset('creatives')">–ö—Ä–µ–∞—Ç–∏–≤—ã</button>
                    <button class="preset-btn" onclick="loadPreset('vertical')">–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ</button>
                    <button class="preset-btn" onclick="loadPreset('logos')">–õ–æ–≥–æ—Ç–∏–ø—ã</button>
                    <button class="preset-btn" onclick="loadPreset('icons')">–ò–∫–æ–Ω–∫–∏</button>
                </div>

                <!-- –ù–û–í–ê–Ø –°–ï–ö–¶–ò–Ø: –†–µ–∂–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ -->
                <h4 style="margin: 20px 0 10px 0;">üîß –†–µ–∂–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞:</h4>
                <div class="resize-mode-options">
                    <div class="resize-mode-option selected" onclick="selectResizeMode('fit')">
                        <span>–í–ø–∏—Å–∞—Ç—å –≤ —Ä–∞–º–∫—É</span>
                        <span class="mode-description">+ –ø–æ–¥–ª–æ–∂–∫–∞</span>
                    </div>
                    <div class="resize-mode-option" onclick="selectResizeMode('resize')">
                        <span>–ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä</span>
                        <span class="mode-description">–±–µ–∑ –ø–æ–¥–ª–æ–∂–∫–∏</span>
                    </div>
                    <div class="resize-mode-option" onclick="selectResizeMode('crop')">
                        <span>–û–±—Ä–µ–∑–∞—Ç—å</span>
                        <span class="mode-description">—Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ</span>
                    </div>
                </div>

                <h4 style="margin: 20px 0 10px 0;">üé® –§–æ–Ω –ø–æ–¥–ª–æ–∂–∫–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–µ–∂–∏–º–∞ "–í–ø–∏—Å–∞—Ç—å –≤ —Ä–∞–º–∫—É"):</h4>
                <div class="background-options">
                    <div class="background-option selected" onclick="selectBackground('transparent')">
                        <div class="background-preview" style="background: conic-gradient(#eee 25%, white 0 50%, #eee 0 75%, white 0);"></div>
                        <span>–ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π</span>
                    </div>
                    <div class="background-option" onclick="selectBackground('white')">
                        <div class="background-preview" style="background: white; border: 2px solid #ddd;"></div>
                        <span>–ë–µ–ª—ã–π</span>
                    </div>
                    <div class="background-option" onclick="selectBackground('gray')">
                        <div class="background-preview" style="background: #f0f0f0;"></div>
                        <span>–°–µ—Ä—ã–π</span>
                    </div>
                </div>
                
                <div class="format-options">
                    <label class="format-option">
                        <input type="checkbox" id="formatPNG"> PNG
                    </label>
                    <label class="format-option">
                        <input type="checkbox" id="formatJPG"> JPG
                    </label>
                </div>
            </div>

            <!-- –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å–µ–∫—Ü–∏–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
        </div>

        <!-- –û—Å—Ç–∞–ª—å–Ω–∞—è —Ä–∞–∑–º–µ—Ç–∫–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
    </div>

    <script>
        // –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö - –î–û–ë–ê–í–õ–Ø–ï–ú –ù–û–í–£–Æ –ü–ï–†–ï–ú–ï–ù–ù–£–Æ
        let uploadedFiles = [];
        let processedFilesStorage = [];
        let isProcessing = false;
        let selectedBackground = 'transparent';
        let selectedVideoResolution = '640x360';
        let selectedVideoQuality = 'medium';
        let selectedVideoFormat = 'mp4';
        let selectedResizeMode = 'fit'; // 'fit', 'resize', 'crop'
        let ffmpeg = null;
        let isFFmpegLoading = false;
        let ffmpegLoadPromise = null;

        // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
        function selectResizeMode(mode) {
            selectedResizeMode = mode;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π –≤—ã–±–æ—Ä
            document.querySelectorAll('.resize-mode-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–æ–Ω–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
            const backgroundSection = document.querySelector('.background-options').parentElement;
            if (mode === 'fit') {
                backgroundSection.style.display = 'block';
            } else {
                backgroundSection.style.display = 'none';
            }
        }

        // –û–ë–ù–û–í–õ–Ø–ï–ú —Ñ—É–Ω–∫—Ü–∏—é –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        async function processFile(file, fileType, index) {
            const baseName = file.customName || file.name.replace(/\.[^/.]+$/, "");
            const processedFiles = [];

            if (fileType === '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ') {
                const sizes = document.getElementById('imageSizes').value.split(',').map(s => s.trim());
                const formats = [];
                
                if (document.getElementById('formatPNG').checked) formats.push('png');
                if (document.getElementById('formatJPG').checked) formats.push('jpg');

                for (const size of sizes) {
                    const [width, height] = size.split('x').map(Number);
                    
                    for (const format of formats) {
                        try {
                            let processedBlob;
                            
                            // –í–´–ë–ò–†–ê–ï–ú –°–ü–û–°–û–ë –û–ë–†–ê–ë–û–¢–ö–ò –í –ó–ê–í–ò–°–ò–ú–û–°–¢–ò –û–¢ –†–ï–ñ–ò–ú–ê
                            switch (selectedResizeMode) {
                                case 'resize':
                                    processedBlob = await resizeImageDirect(file, width, height, format);
                                    break;
                                case 'crop':
                                    processedBlob = await cropImage(file, width, height, format);
                                    break;
                                case 'fit':
                                default:
                                    processedBlob = await resizeImageOnCanvas(file, width, height, format);
                                    break;
                            }
                            
                            const fileName = `${baseName}.${format}`;
                            saveProcessedFile(processedBlob, fileName);
                            processedFiles.push({name: fileName, type: 'image'});
                            
                        } catch (error) {
                            console.error(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:`, error);
                            // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª
                            const fileName = `${baseName}.${format}`;
                            saveProcessedFile(file, fileName);
                            processedFiles.push({name: fileName, type: 'image'});
                        }
                    }
                }
            }
            else if (fileType === '–ê—É–¥–∏–æ') {
                // –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
            }
            else if (fileType === '–í–∏–¥–µ–æ') {
                // –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
            }

            return processedFiles;
        }

        // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –±–µ–∑ –ø–æ–¥–ª–æ–∂–∫–∏
        async function resizeImageDirect(file, width, height, format) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = width;
                canvas.height = height;
                
                const img = new Image();
                img.onload = function() {
                    // –ü—Ä–æ—Å—Ç–æ —Ä–∏—Å—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –Ω–æ–≤—ã–º —Ä–∞–∑–º–µ—Ä–æ–º - –ë–ï–ó –ü–û–î–õ–û–ñ–ö–ò
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    canvas.toBlob((blob) => {
                        if (blob) {
                            resolve(blob);
                        } else {
                            reject(new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'));
                        }
                    }, `image/${format === 'jpg' ? 'jpeg' : format}`, format === 'png' ? 1 : 0.9);
                };
                
                img.onerror = () => reject(new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è'));
                img.src = URL.createObjectURL(file);
            });
        }

        // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–±—Ä–µ–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        async function cropImage(file, width, height, format) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = width;
                canvas.height = height;
                
                const img = new Image();
                img.onload = function() {
                    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –º–∞—Å—à—Ç–∞–± –¥–ª—è –æ–±—Ä–µ–∑–∫–∏ –ø–æ —Ü–µ–Ω—Ç—Ä—É
                    const scale = Math.max(width / img.width, height / img.height);
                    const scaledWidth = img.width * scale;
                    const scaledHeight = img.height * scale;
                    
                    // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∏ –æ–±—Ä–µ–∑–∞–µ–º
                    const x = (scaledWidth - width) / 2 / scale;
                    const y = (scaledHeight - height) / 2 / scale;
                    
                    ctx.drawImage(
                        img, 
                        x, y, 
                        width / scale, height / scale,
                        0, 0,
                        width, height
                    );
                    
                    canvas.toBlob((blob) => {
                        if (blob) {
                            resolve(blob);
                        } else {
                            reject(new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'));
                        }
                    }, `image/${format === 'jpg' ? 'jpeg' : format}`, format === 'png' ? 1 : 0.9);
                };
                
                img.onerror = () => reject(new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è'));
                img.src = URL.createObjectURL(file);
            });
        }

        // –°–¢–ê–†–ê–Ø –§–£–ù–ö–¶–ò–Ø (–æ—Å—Ç–∞–µ—Ç—Å—è –¥–ª—è —Ä–µ–∂–∏–º–∞ "–í–ø–∏—Å–∞—Ç—å –≤ —Ä–∞–º–∫—É")
        async function resizeImageOnCanvas(file, width, height, format) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = width;
                canvas.height = height;
                
                const img = new Image();
                img.onload = function() {
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ–Ω (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–µ–∂–∏–º–∞ "–í–ø–∏—Å–∞—Ç—å –≤ —Ä–∞–º–∫—É")
                    ctx.fillStyle = getBackgroundColor();
                    ctx.fillRect(0, 0, width, height);
                    
                    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è –≤–ø–∏—Å—ã–≤–∞–Ω–∏—è —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–π
                    const scale = Math.min(width / img.width, height / img.height) * 0.8;
                    const newWidth = img.width * scale;
                    const newHeight = img.height * scale;
                    const x = (width - newWidth) / 2;
                    const y = (height - newHeight) / 2;                    
                    // –†–∏—Å—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ —Ü–µ–Ω—Ç—Ä—É
                    ctx.drawImage(img, x, y, newWidth, newHeight);
                    
                    canvas.toBlob((blob) => {
                        if (blob) {
                            resolve(blob);
                        } else {
                            reject(new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'));
                        }
                    }, `image/${format === 'jpg' ? 'jpeg' : format}`, format === 'png' ? 1 : 0.9);
                };
                
                img.onerror = () => reject(new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è'));
                img.src = URL.createObjectURL(file);
            });
        }

        // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π...
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è - —Å–∫—Ä—ã–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–æ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        document.addEventListener('DOMContentLoaded', function() {
            // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–±—Ä–∞–Ω —Ä–µ–∂–∏–º "–í–ø–∏—Å–∞—Ç—å –≤ —Ä–∞–º–∫—É", –ø–æ—ç—Ç–æ–º—É —Ñ–æ–Ω –≤–∏–¥–µ–Ω
            // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Å–∫—Ä—ã—Ç—å –ø—Ä–∏ –¥—Ä—É–≥–∏—Ö —Ä–µ–∂–∏–º–∞—Ö, —ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è –≤ selectResizeMode
        });

        // –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π...
    </script>
</body>
</html>
