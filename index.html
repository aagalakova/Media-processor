<!DOCTYPE html>

<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>MediaProcessor | Relation-AI</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<!--
    FFmpeg WASM (v0.11.x):
    1) —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ (—Å–∞–º–æ—Ö–æ—Å—Ç–∏–Ω–≥): /ffmpeg/ffmpeg.min.js –∏ /ffmpeg/ffmpeg-core.js (+ wasm/worker —Ä—è–¥–æ–º)
    2) –µ—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ –Ω–µ—Ç ‚Äî –ø—Ä–æ–±—É–µ–º CDN:
       - @ffmpeg/ffmpeg@0.11.6
       - @ffmpeg/core@0.11.0 (worker –±—É–¥–µ—Ç: https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.11.0/dist/ffmpeg-core.worker.js)
    –ï—Å–ª–∏ SharedArrayBuffer –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (COOP/COEP –Ω–µ –≤–∫–ª—é—á–µ–Ω—ã) ‚Äî fallback –Ω–∞ core-st.
  -->
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 40px 20px; }
    .container { max-width: 1000px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
    .header { background: linear-gradient(135deg, #2c3e50, #34495e); color: white; padding: 30px; text-align: center; }
    .header h1 { font-size: 2.5em; margin-bottom: 10px; }
    .header p { opacity: 0.9; font-size: 1.1em; }

    /* –°—Ç–∞—Ç—É—Å FFmpeg */
    .ffmpeg-status { margin-top: 12px; display: inline-block; padding: 8px 12px; border-radius: 999px; font-size: 0.9em; background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.25); }
    .ffmpeg-status.ok { background: rgba(46, 204, 113, 0.22); border-color: rgba(46, 204, 113, 0.35); }
    .ffmpeg-status.warn { background: rgba(241, 196, 15, 0.22); border-color: rgba(241, 196, 15, 0.35); }
    .ffmpeg-status.err { background: rgba(231, 76, 60, 0.22); border-color: rgba(231, 76, 60, 0.35); }

    .upload-zone { border: 3px dashed #3498db; border-radius: 15px; padding: 60px 40px; text-align: center; margin: 30px; background: #f8f9fa; transition: all 0.3s ease; cursor: pointer; }
    .upload-zone:hover { border-color: #2980b9; background: #e3f2fd; }
    .upload-zone.dragover { border-color: #27ae60; background: #d4edda; }
    .upload-icon { font-size: 4em; margin-bottom: 20px; color: #3498db; }
    .file-input { display: none; }

    .upload-btn { background: #3498db; color: white; padding: 12px 30px; border: none; border-radius: 25px; cursor: pointer; font-size: 1.1em; transition: background 0.3s ease; margin: 5px; }
    .upload-btn:hover { background: #2980b9; }

    .file-list { margin: 20px 30px; max-height: 400px; overflow-y: auto; }
    .file-list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .file-list-header h3 { color: #2c3e50; }
    .clear-all-btn { background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 0.9em; transition: background 0.3s ease; }
    .clear-all-btn:hover { background: #c0392b; }

    .file-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #3498db; }
    .file-info { display: flex; align-items: center; gap: 10px; flex: 1; }
    .file-icon { font-size: 1.5em; }
    .file-size { color: #7f8c8d; font-size: 0.9em; }
    .file-rename { display: flex; align-items: center; gap: 10px; margin-left: 15px; }
    .rename-input { padding: 8px 12px; border: 2px solid #bdc3c7; border-radius: 8px; font-size: 0.9em; width: 200px; transition: border-color 0.3s ease; }
    .rename-input:focus { border-color: #3498db; outline: none; }

    .settings { background: #f8f9fa; padding: 30px; margin: 20px 30px; border-radius: 15px; }
    .settings-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e3f2fd; }
    .settings-header h2 { color: #2c3e50; display: flex; align-items: center; gap: 10px; }
    .settings-controls { display: flex; gap: 10px; }
    .settings-btn { background: #95a5a6; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 0.9em; transition: background 0.3s ease; }
    .settings-btn:hover { background: #7f8c8d; }
    .settings-btn.reset { background: #e67e22; }
    .settings-btn.reset:hover { background: #d35400; }
    .settings-btn.clear { background: #e74c3c; }
    .settings-btn.clear:hover { background: #c0392b; }

    .settings-section { margin-bottom: 25px; background: white; padding: 20px; border-radius: 10px; border: 2px solid #e3f2fd; }
    .settings-section h3 { color: #2c3e50; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
    .size-input { width: 100%; padding: 12px; border: 2px solid #bdc3c7; border-radius: 8px; font-size: 1em; margin-bottom: 15px; }

    .naming-section { background: white; padding: 20px; border-radius: 10px; border: 2px solid #e3f2fd; margin: 20px 0; }
    .naming-example { color: #7f8c8d; font-size: 0.9em; margin-top: 5px; }
    .naming-options { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0; }
    .naming-option { display: flex; align-items: center; gap: 8px; margin: 8px 0; }

    .format-options { display: flex; gap: 20px; flex-wrap: wrap; margin-top: 15px; }
    .format-option { display: flex; align-items: center; gap: 8px; }
    .format-option input[type="checkbox"] { width: 18px; height: 18px; }

    .video-quality-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px; }
    .video-quality-option { display: flex; align-items: center; gap: 8px; padding: 12px; border: 2px solid #bdc3c7; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
    .video-quality-option:hover { border-color: #3498db; background: #e3f2fd; }
    .video-quality-option.selected { border-color: #27ae60; background: #d4edda; }
    .quality-info { font-size: 0.8em; color: #666; margin-left: auto; }

    .preset-buttons { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
    .preset-btn { background: #95a5a6; color: white; border: none; padding: 8px 16px; border-radius: 15px; cursor: pointer; font-size: 0.9em; transition: background 0.3s ease; }
    .preset-btn:hover { background: #7f8c8d; }

    .ai-section { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 10px; margin: 20px 0; position: relative; }
    .ai-feature { display: flex; align-items: center; gap: 10px; margin: 10px 0; }

    .ai-advisor-section { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin: 20px 0; }
    .ai-advisor-card { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 10px; padding: 20px; border: 1px solid rgba(255, 255, 255, 0.2); }
    .ai-tip { background: rgba(255, 255, 255, 0.15); border-radius: 8px; padding: 15px; margin-bottom: 15px; border-left: 4px solid #27ae60; }
    .ai-tip-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    .ai-tip-content { font-size: 0.95em; opacity: 0.9; }
    .ai-actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .ai-btn { background: rgba(255, 255, 255, 0.2); color: white; border: 1px solid rgba(255, 255, 255, 0.3); padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 0.9em; transition: all 0.3s ease; flex: 1; min-width: 120px; }
    .ai-btn:hover { background: rgba(255, 255, 255, 0.3); transform: translateY(-1px); }
    .ai-btn.secondary { background: rgba(39, 174, 96, 0.3); border-color: rgba(39, 174, 96, 0.5); }

    .ai-results { margin-top: 20px; animation: fadeIn 0.5s ease; }
    .ai-stats { background: rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 15px; margin-bottom: 15px; font-size: 0.9em; }
    .ai-tips-list { display: flex; flex-direction: column; gap: 10px; }
    .ai-tip-item { background: rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 12px 15px; border-left: 3px solid #3498db; animation: slideIn 0.3s ease; }
    .ai-tip-item:nth-child(2n) { border-left-color: #9b59b6; }
    .ai-tip-item:nth-child(3n) { border-left-color: #e74c3c; }

    .color-palette { display: flex; gap: 5px; margin: 10px 0; }
    .color-swatch { width: 30px; height: 30px; border-radius: 6px; border: 2px solid rgba(255, 255, 255, 0.3); position: relative; cursor: pointer; transition: transform 0.2s ease; }
    .color-swatch:hover { transform: scale(1.1); }
    .color-swatch::after { content: attr(data-hex); position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.8); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7em; white-space: nowrap; opacity: 0; transition: opacity 0.3s ease; }
    .color-swatch:hover::after { opacity: 1; }

    .brand-analysis-results { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 10px; padding: 15px; margin-top: 15px; border: 1px solid rgba(255, 255, 255, 0.2); animation: fadeIn 0.5s ease; }
    .brand-analysis-results .color-swatch { width: 25px; height: 25px; border-radius: 4px; border: 2px solid rgba(255, 255, 255, 0.5); }
    .brand-analysis-results .color-swatch::after { bottom: -30px; z-index: 10; }

    .process-btn { background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; border: none; padding: 15px 40px; font-size: 1.2em; border-radius: 25px; cursor: pointer; display: block; margin: 30px auto; transition: transform 0.2s ease; }
    .process-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(39, 174, 96, 0.3); }
    .process-btn:active { transform: translateY(0); }
    .process-btn:disabled { background: #bdc3c7; cursor: not-allowed; transform: none; }

    .result { margin: 20px 30px; padding: 25px; background: #e8f5e8; border-radius: 15px; border-left: 4px solid #27ae60; }
    .result-files { margin-top: 15px; }
    .result-file { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #27ae60; }
    .file-size-compression { font-size: 0.8em; color: #27ae60; margin-left: 10px; }
    .download-btn { background: #3498db; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 0.8em; }
    .download-btn:hover { background: #2980b9; }
    .hidden { display: none; }

    .progress-bar { width: 100%; height: 6px; background: #ecf0f1; border-radius: 3px; margin: 20px 0; overflow: hidden; }
    .progress { height: 100%; background: linear-gradient(135deg, #3498db, #2980b9); width: 0%; transition: width 0.3s ease; }

    .download-section { text-align: center; padding: 20px; background: #f0f8ff; margin: 20px 30px; border-radius: 15px; border: 2px dashed #9b59b6; }
    .download-all-btn { background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; border: none; padding: 15px 40px; font-size: 1.2em; border-radius: 25px; cursor: pointer; transition: transform 0.2s ease; }
    .download-all-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(155, 89, 182, 0.3); }

    .stats { text-align: center; margin: 10px 0; color: #7f8c8d; font-size: 0.9em; }

    .resolution-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 10px; }
    .resolution-option { display: flex; align-items: center; gap: 8px; padding: 10px; border: 2px solid #bdc3c7; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
    .resolution-option:hover { border-color: #3498db; background: #e3f2fd; }
    .resolution-option.selected { border-color: #27ae60; background: #d4edda; }

    .checkbox-controls { display: flex; gap: 10px; margin: 10px 0; flex-wrap: wrap; }
    .checkbox-btn { background: #3498db; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 0.8em; transition: background 0.3s ease; }
    .checkbox-btn:hover { background: #2980b9; }
    .checkbox-btn.select-all { background: #27ae60; }
    .checkbox-btn.select-all:hover { background: #219a52; }
    .checkbox-btn.clear-all { background: #e74c3c; }
    .checkbox-btn.clear-all:hover { background: #c0392b; }

    .empty-state { text-align: center; padding: 40px; color: #7f8c8d; }
    .empty-state .upload-icon { font-size: 3em; margin-bottom: 10px; }

    .cancel-btn { background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin-left: 10px; }
    .cancel-btn:hover { background: #c0392b; }

    .temp-message { border-radius: 8px; padding: 15px; margin: 15px 30px; }
    .error-message { background: #f8d7da; border: 2px solid #e74c3c; color: #721c24; }

    .background-color-section { background: white; padding: 20px; border-radius: 10px; border: 2px solid #e3f2fd; margin: 20px 0; }
    .background-color-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-top: 15px; }
    .background-color-option { display: flex; align-items: center; gap: 12px; padding: 15px; border: 2px solid #bdc3c7; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; }
    .background-color-option:hover { border-color: #3498db; background: #f0f8ff; transform: translateY(-2px); }
    .background-color-option.selected { border-color: #27ae60; background: #e8f5e8; box-shadow: 0 4px 12px rgba(39, 174, 96, 0.2); }
    .background-color-preview { width: 40px; height: 40px; border-radius: 8px; border: 2px solid #ddd; display: flex; align-items: center; justify-content: center; font-size: 1.2em; }
    .background-color-info { display: flex; flex-direction: column; gap: 3px; }
    .background-color-name { font-weight: 600; color: #2c3e50; }
    .background-color-description { font-size: 0.85em; color: #7f8c8d; }

    .custom-color-picker { display: flex; align-items: center; gap: 10px; margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px; border: 1px dashed #bdc3c7; }
    .color-input { width: 60px; height: 40px; border: 2px solid #bdc3c7; border-radius: 6px; cursor: pointer; padding: 2px; }
    .color-input::-webkit-color-swatch-wrapper { padding: 0; }
    .color-input::-webkit-color-swatch { border: none; border-radius: 4px; }
    .color-hex-input { flex: 1; padding: 8px 12px; border: 2px solid #bdc3c7; border-radius: 6px; font-size: 0.9em; font-family: monospace; }

    .transparent-grid {
      background-image:
        linear-gradient(45deg, #ccc 25%, transparent 25%),
        linear-gradient(-45deg, #ccc 25%, transparent 25%),
        linear-gradient(45deg, transparent 75%, #ccc 75%),
        linear-gradient(-45deg, transparent 75%, #ccc 75%);
      background-size: 20px 20px;
      background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
    }

    .video-processing-info { background: #e3f2fd; border-radius: 8px; padding: 15px; margin: 15px 0; border-left: 4px solid #3498db; }
    .video-processing-info h4 { margin-bottom: 10px; color: #2c3e50; }

    .video-format-options { display: flex; gap: 15px; margin: 10px 0; }
    .video-format-option { display: flex; align-items: center; gap: 8px; padding: 10px 15px; border: 2px solid #bdc3c7; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
    .video-format-option:hover { border-color: #3498db; background: #e3f2fd; }
    .video-format-option.selected { border-color: #27ae60; background: #d4edda; }

    .video-processing-status { background: #e3f2fd; border-radius: 8px; padding: 10px; margin: 10px 0; border-left: 4px solid #3498db; font-size: 0.9em; }
    .video-processing-status.success { background: #d4edda; border-left-color: #27ae60; }
    .video-processing-status.error { background: #f8d7da; border-left-color: #e74c3c; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }

    @media (max-width: 768px) {
      .ai-actions { flex-direction: column; }
      .ai-btn { flex: none; }
      .file-item { flex-direction: column; align-items: flex-start; gap: 10px; }
      .file-rename { margin-left: 0; width: 100%; }
      .rename-input { width: 100%; }
      .background-color-options { grid-template-columns: 1fr; }
      .video-format-options { flex-wrap: wrap; }
    }
  
/* Note for preview / WIP blocks */
.coming-soon{margin:8px 0 12px;padding:8px 10px;border-radius:10px;background:rgba(241,196,15,.16);font-size:13px;line-height:1.35}
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1>üöÄ MediaProcessor</h1>
<p>–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤ | Relation-AI Module</p>
<div class="ffmpeg-status" id="ffmpegStatus">FFmpeg: –ø—Ä–æ–≤–µ—Ä–∫–∞‚Ä¶</div>
</div>
<div class="upload-zone" id="dropZone">
<div class="upload-icon">üìÅ</div>
<h3>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞</h3>
<p>–∏–ª–∏</p>
<button class="upload-btn" onclick="document.getElementById('fileInput').click()">
      –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã
    </button>
<input accept="image/*,.mp3,.mp4,.mov,.avi,.ogg,.wav,.flac,.aac,.mkv,.webm,.wmv,.flv" class="file-input" id="fileInput" multiple="" type="file"/>
</div>
<div class="file-list" id="fileList">
<div class="empty-state" id="emptyState">
<div class="upload-icon">üìÑ</div>
<h3>–ù–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤</h3>
<p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É</p>
</div>
</div>
<div class="settings">
<div class="settings-header">
<h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏</h2>
<div class="settings-controls">
<button class="settings-btn reset" onclick="appState.resetAllSettings()">üîÑ –°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë</button>
<button class="settings-btn clear" onclick="appState.clearAllCheckboxes()">‚ùå –£–±—Ä–∞—Ç—å –≥–∞–ª–æ—á–∫–∏</button>
</div>
</div>
<div class="naming-section">
<h3>üè∑Ô∏è –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤</h3>
<p style="color:#666;margin-bottom:10px;">
        –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞ –≤ —Å–ø–∏—Å–∫–µ –≤—ã—à–µ –∏–ª–∏ —É–∫–∞–∂–∏—Ç–µ –æ–±—â–µ–µ –∏–º—è –¥–ª—è —É–º–Ω–æ–≥–æ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è
      </p>
<div class="naming-options">
<div class="naming-option">
<input id="useOriginalNames" type="checkbox"/>
<label for="useOriginalNames">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤</label>
</div>
<div class="naming-option">
<input id="smartRenaming" type="checkbox"/>
<label for="smartRenaming">–£–º–Ω–æ–µ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ (–µ–¥–∏–Ω–∞—è –±–∞–∑–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä: logo, banner, audio_hook)</label>
</div>
<div class="naming-option" style="flex-direction:column;align-items:flex-start;">
<label for="globalBaseName">–û–±—â–µ–µ –∏–º—è –¥–ª—è –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ (–ø—Ä–∏ —É–º–Ω–æ–º –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–∏):</label>
<input class="rename-input" id="globalBaseName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: logo, banner, audio_hook" type="text"/>
</div>
</div>
<div class="naming-example">
        –ü—Ä–∏–º–µ—Ä –∏–º–µ–Ω –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏:
        <strong id="namingExample">banner.png, banner_2.png, banner_3.png</strong>
</div>
</div>
<!-- AI-—Å–æ–≤–µ—Ç–Ω–∏–∫ -->

<!-- AI-–∞–Ω–∞–ª–∏–∑ –±—Ä–µ–Ω–¥–∞ -->

<!-- –¶–≤–µ—Ç –ø–æ–¥–ª–æ–∂–∫–∏ -->
<div class="background-color-section">
<h3>üé® –¶–≤–µ—Ç –ø–æ–¥–ª–æ–∂–∫–∏ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</h3>
<p style="color:#666;margin-bottom:15px;">–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç —Ñ–æ–Ω–∞ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–∞–∫—Ç—É–∞–ª—å–Ω–æ –¥–ª—è JPG –∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–æ–≤)</p>
<div class="background-color-options">
<div class="background-color-option selected" data-background="white">
<div class="background-color-preview" style="background:white;border:2px solid #ddd;"><span style="color:#666;">‚¨ú</span></div>
<div class="background-color-info">
<div class="background-color-name">–ë–µ–ª—ã–π</div>
<div class="background-color-description">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –±–µ–ª—ã–π —Ñ–æ–Ω</div>
</div>
</div>
<div class="background-color-option" data-background="lightgray">
<div class="background-color-preview" style="background:#f0f0f0;"><span style="color:#666;">‚¨ú</span></div>
<div class="background-color-info">
<div class="background-color-name">–°–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π</div>
<div class="background-color-description">–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π —Å–µ—Ä—ã–π —Ñ–æ–Ω</div>
</div>
</div>
<div class="background-color-option" data-background="transparent">
<div class="background-color-preview transparent-grid" style="background:rgba(0,0,0,0);"><span>‚óªÔ∏è</span></div>
<div class="background-color-info">
<div class="background-color-name">–ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π</div>
<div class="background-color-description">–î–ª—è PNG —Å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é</div>
</div>
</div>
<div class="background-color-option" data-background="black">
<div class="background-color-preview" style="background:#000;"><span style="color:white;">‚¨õ</span></div>
<div class="background-color-info">
<div class="background-color-name">–ß–µ—Ä–Ω—ã–π</div>
<div class="background-color-description">–¢–µ–º–Ω—ã–π —Ñ–æ–Ω –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞</div>
</div>
</div>
<div class="background-color-option" data-background="custom" id="customBgOption">
<div class="background-color-preview" id="customBgPreview" style="background:#ffffff;">
<span style="color:#666;">üé®</span>
</div>
<div class="background-color-info">
<div class="background-color-name">–°–≤–æ–π —Ü–≤–µ—Ç</div>
<div class="background-color-description">–ò–∑ hex / picker</div>
</div>
</div>
</div>
<div class="custom-color-picker">
<label style="font-weight:600;color:#2c3e50;">–°–≤–æ–π —Ü–≤–µ—Ç:</label>
<input class="color-input" id="customColorPicker" type="color" value="#ffffff"/>
<input class="color-hex-input" id="customColorHex" placeholder="#RRGGBB" type="text" value="#ffffff"/>
<button class="upload-btn" onclick="appState.applyCustomColor()" style="padding:8px 15px;font-size:0.9em;background:#9b59b6;">
          –ü—Ä–∏–º–µ–Ω–∏—Ç—å
        </button>
</div>
<p style="margin-top:10px;font-size:0.9em;color:#7f8c8d;">
<strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong> –î–ª—è PNG-—Ñ–∞–π–ª–æ–≤ —Å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤—ã–±–∏—Ä–∞—Ç—å "–ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π" —Ñ–æ–Ω.
      </p>
</div>
<div class="settings-section">
<h3>üì∑ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</h3>
<input class="size-input" id="imageSizes" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ä–∞–∑–º–µ—Ä—ã —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é" type="text" value="1200x600, 800x400, 400x200"/>
<div class="preset-buttons">
<button class="preset-btn" onclick="appState.loadPreset('creatives')">–ö—Ä–µ–∞—Ç–∏–≤—ã</button>
<button class="preset-btn" onclick="appState.loadPreset('vertical')">–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ</button>
<button class="preset-btn" onclick="appState.loadPreset('logos')">–õ–æ–≥–æ—Ç–∏–ø—ã</button>
<button class="preset-btn" onclick="appState.loadPreset('icons')">–ò–∫–æ–Ω–∫–∏</button>
</div>
<div class="checkbox-controls">
<button class="checkbox-btn select-all" onclick="appState.selectAllCheckboxes('image')">‚úÖ –í—ã–±—Ä–∞—Ç—å –≤—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã</button>
<button class="checkbox-btn clear-all" onclick="appState.clearCheckboxes('image')">‚ùå –£–±—Ä–∞—Ç—å –≤—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã</button>
</div>
<div class="format-options">
<label class="format-option"><input id="formatPNG" type="checkbox"/> PNG</label>
<label class="format-option"><input id="formatJPG" type="checkbox"/> JPG</label>
</div>
</div>
<div class="settings-section">
<h3>üéµ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞—É–¥–∏–æ</h3>
<div class="checkbox-controls">
<button class="checkbox-btn select-all" onclick="appState.selectAllCheckboxes('audio')">‚úÖ –í—ã–±—Ä–∞—Ç—å –≤—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã</button>
<button class="checkbox-btn clear-all" onclick="appState.clearCheckboxes('audio')">‚ùå –£–±—Ä–∞—Ç—å –≤—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã</button>
</div>
<div class="format-options">
<label class="format-option"><input id="audioMP3" type="checkbox"/> MP3</label>
<label class="format-option"><input id="audioOGG" type="checkbox"/> OGG</label>
</div>
<select class="size-input" id="audioBitrate" style="margin-top:10px;">
<option value="128">128 kbps (—Å—Ç–∞–Ω–¥–∞—Ä—Ç)</option>
<option value="192">192 kbps (–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ)</option>
<option value="256">256 kbps (–ø—Ä–µ–º–∏—É–º)</option>
<option value="320">320 kbps (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ)</option>
</select>
</div>
<div class="settings-section">
<h3>üé¨ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–¥–µ–æ</h3>
<div class="video-processing-info">
<h4>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∏–¥–µ–æ</h4>
<p>–í–∏–¥–µ–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —Å –ø–æ–º–æ—â—å—é FFmpeg –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –î–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –æ–≥—Ä–∞–Ω–∏—á—å—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã—Ö –≤–∏–¥–µ–æ.</p>
<p><strong>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</strong> –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –Ω–µ –±–æ–ª–µ–µ 1-2 –≤–∏–¥–µ–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.</p>
</div>
<h4 style="margin:10px 0 5px 0;">üìê –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ:</h4>
<div class="resolution-options">
<div class="resolution-option selected" data-resolution="640x360"><span>640√ó360px</span></div>
<div class="resolution-option" data-resolution="854x480"><span>854√ó480px</span></div>
<div class="resolution-option" data-resolution="1280x720"><span>1280√ó720px (HD)</span></div>
<div class="resolution-option" data-resolution="1920x1080"><span>1920√ó1080px (Full HD)</span></div>
</div>
<h4 style="margin:10px 0 5px 0;">üì¶ –§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞:</h4>
<div class="video-format-options">
<div class="video-format-option selected" data-format="mp4"><span>MP4</span><span style="font-size:0.8em;color:#666;">(–ª—É—á—à–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)</span></div>
</div>
<h4 style="margin:15px 0 5px 0;">üéØ –ö–∞—á–µ—Å—Ç–≤–æ —Å–∂–∞—Ç–∏—è:</h4>
<div class="video-quality-options">
<div class="video-quality-option" data-quality="high"><span>–í—ã—Å–æ–∫–æ–µ (CRF 18)</span><span class="quality-info">~60% –æ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª–∞</span></div>
<div class="video-quality-option selected" data-quality="medium"><span>–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ (CRF 23)</span><span class="quality-info">~40% –æ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª–∞</span></div>
<div class="video-quality-option" data-quality="low"><span>–≠–∫–æ–Ω–æ–º–Ω–æ–µ (CRF 28)</span><span class="quality-info">~25% –æ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª–∞</span></div>
</div>
</div><div class="ai-advisor-section">
<h3>üß† AI-–°–æ–≤–µ—Ç–Ω–∏–∫</h3><div class="coming-soon">‚ö†Ô∏è –ß–µ—Ä–Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è: —Ñ—É–Ω–∫—Ü–∏–∏ –±—É–¥—É—Ç –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω—ã. –°–µ–π—á–∞—Å –¥–æ—Å—Ç—É–ø–Ω–∞ –±–∞–∑–æ–≤–∞—è –ª–æ–≥–∏–∫–∞.</div>
<div class="ai-advisor-card">
<div class="ai-tip" id="aiTip">
<div class="ai-tip-header">
<span class="ai-icon">üí°</span>
<strong>–°–æ–≤–µ—Ç–Ω–∏–∫ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</strong>
</div>
<div class="ai-tip-content">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏</div>
</div>
<div class="ai-actions">
<button class="ai-btn" id="aiAdviceBtn" onclick="appState.getAIAdvice()">ü§ñ –ü–æ–ª—É—á–∏—Ç—å —Å–æ–≤–µ—Ç—ã</button>
<button class="ai-btn secondary" id="analyzeImagesBtn" onclick="appState.analyzeAllImages()">üé® –ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</button>
</div>
<div class="ai-results hidden" id="aiResults">
<div class="ai-stats" id="aiStats"></div>
<div class="ai-tips-list" id="aiTipsList"></div>
</div>
</div>
</div><div class="ai-section">
<h3>üß† AI-–ê–Ω–∞–ª–∏–∑ –±—Ä–µ–Ω–¥–∞</h3><div class="coming-soon">‚ö†Ô∏è –ß–µ—Ä–Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è: —Ñ—É–Ω–∫—Ü–∏–∏ –±—É–¥—É—Ç –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω—ã. –°–µ–π—á–∞—Å –¥–æ—Å—Ç—É–ø–Ω–∞ –±–∞–∑–æ–≤–∞—è –ª–æ–≥–∏–∫–∞.</div>
<div class="checkbox-controls">
<button class="checkbox-btn select-all" onclick="appState.selectAllCheckboxes('ai')">‚úÖ –í—ã–±—Ä–∞—Ç—å –≤—Å–µ AI</button>
<button class="checkbox-btn clear-all" onclick="appState.clearCheckboxes('ai')">‚ùå –£–±—Ä–∞—Ç—å –≤—Å–µ AI</button>
</div>
<div class="ai-feature">
<input id="aiAnalysis" type="checkbox"/>
<label for="aiAnalysis">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ü–≤–µ—Ç–∞ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</label>
</div>
<button class="upload-btn" onclick="appState.analyzeBrandAssets()" style="background:#9b59b6;">
        üîç –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –±—Ä–µ–Ω–¥
      </button>
<div class="brand-analysis-results hidden" id="brandAnalysisResults"></div>
</div>
</div>
<div class="stats" id="statsInfo"></div>
<button class="process-btn" id="processBtn">üöÄ –ù–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É</button>
<div class="progress-bar hidden" id="progressBar">
<div class="progress" id="progress"></div>
</div>
<div class="result hidden" id="result">
<h3>‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h3>
<div class="result-files" id="resultFiles"></div>
</div>
<div class="download-section hidden" id="downloadSection">
<button class="download-all-btn" id="downloadAllBtn">üíæ –°–∫–∞—á–∞—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã (ZIP)</button>
<p style="text-align:center;margin-top:10px;color:#666;">–ë—É–¥–µ—Ç —Å–∫–∞—á–∞–Ω ZIP-–∞—Ä—Ö–∏–≤ —Å–æ –≤—Å–µ–º–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏</p>
</div>
</div>
<script>
/* =======================
   Status helper
======================= */
function setFFmpegStatus(text, level = 'warn') {
  const el = document.getElementById('ffmpegStatus');
  if (!el) return;
  el.textContent = text;
  el.classList.remove('ok', 'warn', 'err');
  el.classList.add(level);
}

/* =======================
   Helpers: load scripts
======================= */
function loadScript(src) {
  return new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = src;
    s.async = true;
    s.onload = () => resolve(src);
    s.onerror = () => reject(new Error('Failed to load: ' + src));
    document.head.appendChild(s);
  });
}

async function ensureFFmpegLibLoaded() {
  if (window.FFmpeg && typeof window.FFmpeg.createFFmpeg === 'function') return true;

  const candidates = [];
  if (location.protocol !== 'file:') candidates.push('/ffmpeg/ffmpeg.min.js');
  candidates.push('https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js');

  for (const url of candidates) {
    try {
      await loadScript(url);
      if (window.FFmpeg && typeof window.FFmpeg.createFFmpeg === 'function') return true;
    } catch (e) {
      console.warn('FFmpeg lib load failed:', url, e);
    }
  }
  return false;
}

/* =======================
   Video+Audio Processor
======================= */
class VideoProcessor {
  constructor() {
    this.ffmpeg = null;
    this.isFFmpegReady = false;
    this.loadedCorePath = null;
    this.coreMode = '‚Äî';
    this.initFFmpeg();
  }

  async initFFmpeg() {
    if (location.protocol === 'file:') {
      setFFmpegStatus('FFmpeg: –æ—Ç–∫—Ä—ã—Ç –∫–∞–∫ file:// ‚Äî –æ—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ Vercel (https://...)', 'err');
      console.warn('–û—Ç–∫—Ä—ã—Ç–æ –∫–∞–∫ file://. FFmpeg core/wasm –Ω–µ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è. –û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ https.');
      return;
    }

    setFFmpegStatus('FFmpeg: –∑–∞–≥—Ä—É–∂–∞—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É‚Ä¶', 'warn');

    const ok = await ensureFFmpegLibLoaded();
    if (!ok) {
      setFFmpegStatus('FFmpeg: –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å (–ø—Ä–æ–≤–µ—Ä—å –ø—É—Ç—å/CORS)', 'err');
      console.warn('FFmpeg –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω. –í–∏–¥–µ–æ/–∞—É–¥–∏–æ –±—É–¥—É—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è –±–µ–∑ –ø–µ—Ä–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è.');
      return;
    }

    try {
      const { createFFmpeg } = window.FFmpeg;

      const hasSAB = (typeof SharedArrayBuffer !== 'undefined');
      const isolated = (self.crossOriginIsolated === true);
      const canUseMT = hasSAB && isolated;

      const mtCoreCandidates = [
        '/ffmpeg/ffmpeg-core.js',
        'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.11.0/dist/ffmpeg-core.js'
      ];

      const stCoreCandidates = [
        'https://cdn.jsdelivr.net/npm/@ffmpeg/core-st@0.11.1/dist/ffmpeg-core.js',
        'https://cdn.jsdelivr.net/npm/@ffmpeg/core-st@0.11.0/dist/ffmpeg-core.js'
      ];

      const coreCandidates = canUseMT ? mtCoreCandidates : stCoreCandidates;

      if (!canUseMT) {
        setFFmpegStatus('FFmpeg: –Ω–µ—Ç SharedArrayBuffer ‚Üí –≤–∫–ª—é—á–∏ COOP/COEP. –°–µ–π—á–∞—Å fallback (slow).', 'warn');
        console.warn('SharedArrayBuffer –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ù—É–∂–Ω—ã COOP/COEP –∑–∞–≥–æ–ª–æ–≤–∫–∏ –Ω–∞ Vercel.');
      }

      for (const corePath of coreCandidates) {
        try {
          this.ffmpeg = createFFmpeg({ log: true, corePath });
          console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º FFmpeg core:', corePath);
          await this.ffmpeg.load();

          this.isFFmpegReady = true;
          this.loadedCorePath = corePath;
          this.coreMode = canUseMT ? 'multi-thread' : 'single-thread';

          const where = corePath.includes('http') ? 'CDN' : 'local';
          setFFmpegStatus(`FFmpeg: –≥–æ—Ç–æ–≤ ‚úÖ (${where}, ${this.coreMode})`, 'ok');

          console.log('‚úÖ FFmpeg —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω (corePath):', corePath, 'mode:', this.coreMode);
          return;
        } catch (e) {
          console.warn('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å corePath:', corePath, e);
          this.ffmpeg = null;
          this.isFFmpegReady = false;
        }
      }

      setFFmpegStatus('FFmpeg: core –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å (local/CDN)', 'err');
      console.error('‚ùå FFmpeg core –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∏ –ª–æ–∫–∞–ª—å–Ω–æ, –Ω–∏ —Å CDN.');
    } catch (e) {
      setFFmpegStatus('FFmpeg: –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏', 'err');
      console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ FFmpeg:', e);
    }
  }

  safeUnlink(path) { try { this.ffmpeg && this.ffmpeg.FS('unlink', path); } catch (e) {} }

  getVideoExtension(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    const map = { mp4:'mp4', mov:'mov', avi:'avi', mkv:'mkv', webm:'webm', ogg:'ogg', wmv:'wmv', flv:'flv', m4v:'m4v', '3gp':'3gp' };
    return map[ext] || 'mp4';
  }

  getAudioExtension(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    const map = { mp3:'mp3', wav:'wav', ogg:'ogg', flac:'flac', aac:'aac', m4a:'m4a' };
    return map[ext] || 'mp3';
  }

  /* ===== VIDEO ===== */
  async processVideo(file, settings) {
    const { resolution='640x360', quality='medium', format='mp4' } = settings;

    if (!this.isFFmpegReady || !this.ffmpeg) {
      console.warn('‚ö†Ô∏è FFmpeg –Ω–µ –≥–æ—Ç–æ–≤/–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞—é –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ');
      return file;
    }

    try {
      return await this.processVideoWithFFmpeg(file, resolution, quality, format);
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ FFmpeg –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∏–¥–µ–æ, –≤–æ–∑–≤—Ä–∞—â–∞—é –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª:', error);
      return file;
    }
  }

  async processVideoWithFFmpeg(file, resolution, quality, format) {
    const { ffmpeg } = this;
    const [width, height] = resolution.split('x').map(Number);

    const crfValues = { high: 18, medium: 23, low: 28 };
    const crf = crfValues[quality] || 23;

    const bitrateValues = { high: '1500k', medium: '1000k', low: '500k' };
    const videoBitrate = bitrateValues[quality] || '1000k';

    const inputData = await file.arrayBuffer();
    const inputName = `vinput.${this.getVideoExtension(file.name)}`;
    const outputName = `voutput.${format}`;

    ffmpeg.FS('writeFile', inputName, new Uint8Array(inputData));

    const command = [
      '-i', inputName,
      '-vf', `scale=${width}:${height}:force_original_aspect_ratio=decrease,pad=${width}:${height}:(ow-iw)/2:(oh-ih)/2`,
      '-c:v', 'libx264',
      '-b:v', videoBitrate,
      '-crf', String(crf),
      '-preset', 'fast',
      '-c:a', 'aac',
      '-b:a', '128k',
      '-movflags', '+faststart',
      '-y',
      outputName
    ];

    await ffmpeg.run(...command);

    const out = ffmpeg.FS('readFile', outputName);
    this.safeUnlink(inputName);
    this.safeUnlink(outputName);

    return new Blob([out], { type: 'video/mp4' });
  }

  /* ===== AUDIO (—Ä–µ–∞–ª—å–Ω–æ–µ –ø–µ—Ä–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ) ===== */
  async processAudio(file, settings) {
    const { format='mp3', bitrate=192 } = settings;

    if (!this.isFFmpegReady || !this.ffmpeg) {
      console.warn('‚ö†Ô∏è FFmpeg –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞—é –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∞—É–¥–∏–æ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π');
      return file;
    }

    try {
      return await this.processAudioWithFFmpeg(file, format, bitrate);
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ FFmpeg –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—É–¥–∏–æ, –≤–æ–∑–≤—Ä–∞—â–∞—é –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª:', error);
      return file;
    }
  }

  async processAudioWithFFmpeg(file, format, bitrate) {
    const { ffmpeg } = this;

    const inputData = await file.arrayBuffer();
    const inputExt = this.getAudioExtension(file.name);
    const inputName = `ainput.${inputExt}`;
    const outputName = `aoutput.${format}`;

    ffmpeg.FS('writeFile', inputName, new Uint8Array(inputData));

    const bps = `${Math.max(32, Math.min(320, Number(bitrate) || 192))}k`;

    const mp3Primary = ['-i', inputName, '-vn', '-c:a', 'libmp3lame', '-b:a', bps, '-ar', '44100', '-ac', '2', '-y', outputName];
    const mp3Fallback = ['-i', inputName, '-vn', '-c:a', 'mp3',       '-b:a', bps, '-ar', '44100', '-ac', '2', '-y', outputName];

    const oggPrimary = ['-i', inputName, '-vn', '-c:a', 'libvorbis',  '-b:a', bps, '-ar', '44100', '-ac', '2', '-y', outputName];
    const oggFallback = ['-i', inputName, '-vn', '-c:a', 'vorbis',    '-b:a', bps, '-ar', '44100', '-ac', '2', '-y', outputName];

    const runWithFallback = async (primary, fallback) => {
      try { await ffmpeg.run(...primary); }
      catch (e) { console.warn('‚ö†Ô∏è primary codec failed, trying fallback', e); await ffmpeg.run(...fallback); }
    };

    if (format === 'ogg') await runWithFallback(oggPrimary, oggFallback);
    else await runWithFallback(mp3Primary, mp3Fallback);

    const out = ffmpeg.FS('readFile', outputName);
    this.safeUnlink(inputName);
    this.safeUnlink(outputName);

    const mime = (format === 'ogg') ? 'audio/ogg' : 'audio/mpeg';
    return new Blob([out], { type: mime });
  }

  cancel() {
    if (!this.ffmpeg) return;
    try {
      const files = this.ffmpeg.FS('readdir', '/');
      files.forEach(f => {
        if (f !== '.' && f !== '..') {
          try { this.ffmpeg.FS('unlink', `/${f}`); } catch (e) {}
        }
      });
    } catch (e) {}
  }
}

/* =======================
   Utils
======================= */
class FileUtils {
  static getFileType(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    const imageExts = ['jpg','jpeg','png','gif','webp','bmp','svg'];
    const audioExts = ['mp3','wav','ogg','flac','aac','m4a'];
    const videoExts = ['mp4','mov','avi','mkv','webm','wmv','flv','m4v','3gp'];
    if (imageExts.includes(ext)) return '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
    if (audioExts.includes(ext)) return '–ê—É–¥–∏–æ';
    if (videoExts.includes(ext)) return '–í–∏–¥–µ–æ';
    return '–î—Ä—É–≥–æ–π';
  }

  static formatFileSize(bytes) {
    if (bytes === 0) return '0 –ë';
    const k = 1024;
    const sizes = ['–ë','–ö–ë','–ú–ë','–ì–ë'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  static inferImageFormatFromFile(file) {
    const ext = (file.name.split('.').pop() || '').toLowerCase();
    if (ext === 'png') return 'png';
    if (ext === 'jpg' || ext === 'jpeg') return 'jpg';
    const t = (file.type || '').toLowerCase();
    if (t.includes('png')) return 'png';
    return 'jpg';
  }

  static parseSizes(raw) {
    const out = [];
    const parts = String(raw || '')
      .split(',')
      .map(s => s.trim())
      .filter(Boolean);

    for (const p of parts) {
      const m = p.toLowerCase().match(/^(\d+)\s*x\s*(\d+)$/);
      if (!m) continue;
      const w = Math.max(1, parseInt(m[1], 10));
      const h = Math.max(1, parseInt(m[2], 10));
      if (Number.isFinite(w) && Number.isFinite(h) && w > 0 && h > 0) out.push({ w, h });
    }
    return out;
  }

  static escapeHtmlAttr(str) {
    return String(str ?? '')
      .replaceAll('&', '&amp;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#39;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;');
  }
}

class MediaProcessor {
  constructor() {
    this.isCancelled = false;
    this.videoProcessor = new VideoProcessor();
    this.initVideoProcessor();
  }

  async initVideoProcessor() {
    setTimeout(() => {
      if (!this.videoProcessor.isFFmpegReady) {
        console.log('‚è≥ FFmpeg –≤—Å–µ –µ—â–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω...');
      }
    }, 1200);
  }

  cancel() {
    this.isCancelled = true;
    this.videoProcessor && this.videoProcessor.cancel();
  }

  async processFiles(files, settings, onProgress, onFileProcessed) {
    this.isCancelled = false;
    const totalFiles = files.length;
    let processedCount = 0;

    // –°–Ω–∞—á–∞–ª–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è/–∞—É–¥–∏–æ
    for (let i = 0; i < files.length; i++) {
      if (this.isCancelled) break;

      const file = files[i];
      const type = FileUtils.getFileType(file.name);
      if (type === '–í–∏–¥–µ–æ') continue;

      try {
        const processed = await this.processSingleFile(file, settings, i);
        if (processed && processed.length) onFileProcessed(processed);

        processedCount++;
        onProgress((processedCount / totalFiles) * 100);
        await new Promise(r => setTimeout(r, 50));
      } catch (e) {
        console.error(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞ ${file.name}:`, e);
        this.handleFallback(file, i, onFileProcessed);
        processedCount++;
        onProgress((processedCount / totalFiles) * 100);
      }
    }

    // –ü–æ—Ç–æ–º –≤–∏–¥–µ–æ
    const videoFiles = files.filter(f => FileUtils.getFileType(f.name) === '–í–∏–¥–µ–æ');
    for (let i = 0; i < videoFiles.length; i++) {
      if (this.isCancelled) break;

      const file = videoFiles[i];
      const originalIndex = files.indexOf(file);

      try {
        const videoProgress = document.createElement('div');
        videoProgress.className = 'video-processing-status';
        videoProgress.textContent = `üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–µ–æ: ${file.name} (${i+1}/${videoFiles.length})`;
        document.querySelector('.settings').appendChild(videoProgress);

        const processed = await this.processSingleFile(file, settings, originalIndex);
        if (processed && processed.length) {
          onFileProcessed(processed);
          videoProgress.className = 'video-processing-status success';
          videoProgress.textContent = `‚úÖ –í–∏–¥–µ–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${file.name}`;
        }

        processedCount++;
        onProgress((processedCount / totalFiles) * 100);

        await new Promise(r => setTimeout(r, 300));
        setTimeout(() => videoProgress.remove(), 2500);
      } catch (e) {
        console.error(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∏–¥–µ–æ ${file.name}:`, e);

        const errorStatus = document.createElement('div');
        errorStatus.className = 'video-processing-status error';
        errorStatus.textContent = `‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∏–¥–µ–æ: ${file.name}`;
        document.querySelector('.settings').appendChild(errorStatus);

        this.handleFallback(file, originalIndex, onFileProcessed);
        processedCount++;
        onProgress((processedCount / totalFiles) * 100);

        setTimeout(() => errorStatus.remove(), 2500);
      }
    }
  }

  handleFallback(file, index, onFileProcessed) {
    const fallbackName = appState.generateFileName(
      file.customName || file.name.replace(/\.[^/.]+$/, ''),
      (file.name.split('.').pop() || '').toLowerCase(),
      FileUtils.getFileType(file.name),
      file.name,
      1,
      index,
      1
    );

    onFileProcessed([{
      blob: file,
      name: fallbackName,
      type: FileUtils.getFileType(file.name),
      originalSize: file.size,
      compressedSize: file.size,
      note: '–û—Ä–∏–≥–∏–Ω–∞–ª (fallback)'
    }]);
  }

  async processSingleFile(file, settings, fileIndex) {
    const type = FileUtils.getFileType(file.name);
    const processed = [];

    if (type === '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ') {
      await this.processImage(file, settings, processed, fileIndex);
    } else if (type === '–ê—É–¥–∏–æ') {
      await this.processAudio(file, settings, processed, fileIndex);
    } else if (type === '–í–∏–¥–µ–æ') {
      await this.processVideo(file, settings, processed, fileIndex);
    } else {
      const name = appState.generateFileName(
        file.customName || file.name.replace(/\.[^/.]+$/, ''),
        (file.name.split('.').pop() || '').toLowerCase(),
        type,
        file.name,
        1,
        fileIndex,
        1
      );
      processed.push({ blob: file, name, type, originalSize: file.size, compressedSize: file.size });
    }

    return processed;
  }

  /* =======================
     IMAGE (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ):
     - –≤—Å–µ–≥–¥–∞ –¥–µ–ª–∞–µ—Ç –ø–æ–¥–ª–æ–∂–∫—É + —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ—Ç
     - —Ä–µ—Å–∞–π–∑ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –µ—Å–ª–∏ PNG/JPG –Ω–µ –≤—ã–±—Ä–∞–Ω—ã (–±–µ—Ä—ë–º —Ñ–æ—Ä–º–∞—Ç –∏—Å—Ö–æ–¥–Ω–∏–∫–∞)
     - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è (–±–µ–∑ Promise.all)
  ======================= */
  async processImage(file, settings, processed, fileIndex) {
    return new Promise((resolve) => {
      const reader = new FileReader();

      reader.onload = (e) => {
        const img = new Image();

        img.onload = async () => {
          try {
            // sizes
            let sizes = FileUtils.parseSizes(settings.imageSizes);
            if (!sizes.length) sizes = [{ w: img.width, h: img.height }];

            // formats
            const formats = [];
            if (document.getElementById('formatPNG').checked) formats.push('png');
            if (document.getElementById('formatJPG').checked) formats.push('jpg');
            if (!formats.length) formats.push(FileUtils.inferImageFormatFromFile(file)); // –≤–∞–∂–Ω–∞—è –ø—Ä–∞–≤–∫–∞

            const totalVariants = sizes.length * formats.length;
            let counter = 1;

            // –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ (–ø—Ä–∞–≤–∫–∞ D)
            for (const s of sizes) {
              for (const format of formats) {
                if (this.isCancelled) { resolve(); return; }
                await this.createImageVersion(
                  img, s.w, s.h, format, file, processed,
                  counter, totalVariants, fileIndex, settings
                );
                counter++;
              }
            }

            resolve();
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);

            const name = appState.generateFileName(
              file.customName || file.name.replace(/\.[^/.]+$/, ''),
              FileUtils.inferImageFormatFromFile(file),
              '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ',
              file.name,
              1,
              fileIndex,
              1
            );
            processed.push({ blob: file, name, type: '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', originalSize: file.size, compressedSize: file.size, note: '–û—Ä–∏–≥–∏–Ω–∞–ª (–æ—à–∏–±–∫–∞)' });
            resolve();
          }
        };

        img.onerror = () => {
          const name = appState.generateFileName(
            file.customName || file.name.replace(/\.[^/.]+$/, ''),
            FileUtils.inferImageFormatFromFile(file),
            '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ',
            file.name,
            1,
            fileIndex,
            1
          );
          processed.push({ blob: file, name, type: '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', originalSize: file.size, compressedSize: file.size, note: '–û—Ä–∏–≥–∏–Ω–∞–ª (–Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∫–∞–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ)' });
          resolve();
        };

        img.src = e.target.result;
      };

      reader.onerror = () => resolve();
      reader.readAsDataURL(file);
    });
  }

  async createImageVersion(img, width, height, format, file, processed, counter, totalVariants, fileIndex, settings) {
    return new Promise((resolveVersion) => {
      width = Math.max(1, Math.round(Number(width) || 1));
      height = Math.max(1, Math.round(Number(height) || 1));

      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      canvas.width = width;
      canvas.height = height;

      const backgroundColor = this.getBackgroundColor(settings.selectedBackground);

      // –ø–æ–¥–ª–æ–∂–∫–∞
      if (backgroundColor === 'transparent' && format === 'png') {
        ctx.clearRect(0, 0, width, height);
      } else if (backgroundColor === 'transparent') {
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, width, height);
      } else {
        ctx.fillStyle = backgroundColor;
        ctx.fillRect(0, 0, width, height);
      }

      // –º–∞—Å—à—Ç–∞–± —Å –∑–∞–ø—Ä–µ—Ç–æ–º –∞–ø—Å–∫–µ–π–ª–∞ (–∫–∞–∫ –≤ "–Ω–æ—Ä–º–∞–ª—å–Ω—ã—Ö" –∫–∞—Ä—Ç–æ—á–∫–∞—Ö)
      const scale = Math.min(width / img.width, height / img.height, 1);
      const scaledWidth = img.width * scale;
      const scaledHeight = img.height * scale;
      const offsetX = (width - scaledWidth) / 2;
      const offsetY = (height - scaledHeight) / 2;

      ctx.drawImage(img, offsetX, offsetY, scaledWidth, scaledHeight);

      const finalName = appState.generateFileName(
        file.customName || file.name.replace(/\.[^/.]+$/, ''),
        format,
        '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ',
        file.name,
        counter,
        fileIndex,
        totalVariants
      );

      const mimeType = format === 'png' ? 'image/png' : 'image/jpeg';
      const quality = format === 'png' ? 0.9 : 0.85;

      canvas.toBlob((blob) => {
        if (blob) {
          processed.push({
            blob,
            name: finalName,
            type: '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ',
            originalSize: file.size,
            compressedSize: blob.size,
            format,
            resolution: `${width}x${height}`,
            background: settings.selectedBackground,
            backgroundColor
          });
        }
        resolveVersion();
      }, mimeType, quality);
    });
  }

  getBackgroundColor(backgroundType) {
    switch (backgroundType) {
      case 'white': return '#ffffff';
      case 'lightgray': return '#f0f0f0';
      case 'transparent': return 'transparent';
      case 'black': return '#000000';
      case 'custom': {
        const hexColor = document.getElementById('customColorHex')?.value || '#ffffff';
        return this.validateColor(hexColor) ? hexColor : '#ffffff';
      }
      default: return '#ffffff';
    }
  }

  validateColor(color) {
    const hexRegex = /^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/;
    return hexRegex.test(color);
  }

  /* ===== AUDIO: –†–ï–ê–õ–¨–ù–û–ï –ü–ï–†–ï–ö–û–î–ò–†–û–í–ê–ù–ò–ï ===== */
  async processAudio(file, settings, processed, fileIndex) {
    try {
      const formats = [];
      if (document.getElementById('audioMP3').checked) formats.push('mp3');
      if (document.getElementById('audioOGG').checked) formats.push('ogg');

      const bitrate = parseInt(document.getElementById('audioBitrate').value) || 128;

      if (!formats.length) {
        const name = appState.generateFileName(
          file.customName || file.name.replace(/\.[^/.]+$/, ''),
          (file.name.split('.').pop() || '').toLowerCase(),
          '–ê—É–¥–∏–æ',
          file.name,
          1,
          fileIndex,
          1
        );
        processed.push({ blob: file, name, type: '–ê—É–¥–∏–æ', originalSize: file.size, compressedSize: file.size });
        return;
      }

      for (let i = 0; i < formats.length; i++) {
        const format = formats[i];

        const status = document.createElement('div');
        status.className = 'video-processing-status';
        status.textContent = `üîÑ –ü–µ—Ä–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—É–¥–∏–æ: ${file.name} ‚Üí ${format.toUpperCase()} (${bitrate} kbps)`;
        document.querySelector('.settings').appendChild(status);

        const outBlob = await this.videoProcessor.processAudio(file, { format, bitrate });

        status.className = 'video-processing-status success';
        status.textContent = `‚úÖ –ê—É–¥–∏–æ –≥–æ—Ç–æ–≤–æ: ${file.name} ‚Üí ${format.toUpperCase()} (${bitrate} kbps)`;
        setTimeout(() => status.remove(), 2500);

        const outName = appState.generateFileName(
          file.customName || file.name.replace(/\.[^/.]+$/, ''),
          format,
          '–ê—É–¥–∏–æ',
          file.name,
          i + 1,
          fileIndex,
          formats.length
        );

        processed.push({
          blob: outBlob,
          name: outName,
          type: '–ê—É–¥–∏–æ',
          originalSize: file.size,
          compressedSize: outBlob.size,
          format,
          bitrate: `${bitrate}kbps`,
          note: (outBlob === file) ? '–û—Ä–∏–≥–∏–Ω–∞–ª (FFmpeg –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω/–æ—à–∏–±–∫–∞)' : ''
        });
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—É–¥–∏–æ:', error);
      const name = appState.generateFileName(
        file.customName || file.name.replace(/\.[^/.]+$/, ''),
        (file.name.split('.').pop() || '').toLowerCase(),
        '–ê—É–¥–∏–æ',
        file.name,
        1,
        fileIndex,
        1
      );
      processed.push({ blob: file, name, type: '–ê—É–¥–∏–æ', originalSize: file.size, compressedSize: file.size, note: '–û—Ä–∏–≥–∏–Ω–∞–ª (–æ—à–∏–±–∫–∞)' });
    }
  }

  async processVideo(file, settings, processed, fileIndex) {
    try {
      const resolution = settings.selectedVideoResolution || '640x360';
      const quality = settings.selectedVideoQuality || 'medium';
      const format = settings.selectedVideoFormat || 'mp4';

      const videoStatus = document.createElement('div');
      videoStatus.className = 'video-processing-status';
      videoStatus.textContent = `üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–µ–æ: ${file.name} (–º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è)`;
      document.querySelector('.settings').appendChild(videoStatus);

      const processedBlob = await this.videoProcessor.processVideo(file, { resolution, quality, format });

      videoStatus.className = 'video-processing-status success';
      videoStatus.textContent = `‚úÖ –í–∏–¥–µ–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${file.name}`;
      setTimeout(() => videoStatus.remove(), 2500);

      const fileName = appState.generateFileName(
        file.customName || file.name.replace(/\.[^/.]+$/, ''),
        format,
        '–í–∏–¥–µ–æ',
        file.name,
        1,
        fileIndex,
        1
      );

      processed.push({
        blob: processedBlob,
        name: fileName,
        type: '–í–∏–¥–µ–æ',
        originalSize: file.size,
        compressedSize: processedBlob.size,
        resolution,
        quality,
        format
      });
    } catch (error) {
      console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∏–¥–µ–æ:', error);

      const errorStatus = document.createElement('div');
      errorStatus.className = 'video-processing-status error';
      errorStatus.textContent = `‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤–∏–¥–µ–æ: ${file.name}`;
      document.querySelector('.settings').appendChild(errorStatus);

      const name = appState.generateFileName(
        file.customName || file.name.replace(/\.[^/.]+$/, ''),
        (file.name.split('.').pop() || '').toLowerCase(),
        '–í–∏–¥–µ–æ',
        file.name,
        1,
        fileIndex,
        1
      );

      processed.push({ blob: file, name, type: '–í–∏–¥–µ–æ', originalSize: file.size, compressedSize: file.size, note: '–û—Ä–∏–≥–∏–Ω–∞–ª (–æ—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏)' });
      setTimeout(() => errorStatus.remove(), 2500);
    }
  }
}

/* =======================
   App State
======================= */
class AppState {
  constructor() {
    this.files = [];
    this.processedFiles = [];
    this.currentSettings = this.getDefaultSettings();
    this.mediaProcessor = new MediaProcessor();
    this.lastBrandRecommendations = null;

    // === smart naming plan (–ø—Ä–∞–≤–∫–∞ C/E) ===
    this.smartPlanCounts = null;   // { key: number }
    this.smartCounters = null;     // { key: number }

    this.initEventListeners();
    this.updateUI();
  }

  getDefaultSettings() {
    return {
      imageSizes: '1200x600, 800x400, 400x200',
      selectedBackground: 'white',
      selectedVideoResolution: '640x360',
      selectedVideoQuality: 'medium',
      selectedVideoFormat: 'mp4'
    };
  }

  initEventListeners() {
    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('dropZone');
    const processBtn = document.getElementById('processBtn');

    fileInput.addEventListener('change', (e) => this.handleFiles(e.target.files));

    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      this.handleFiles(e.dataTransfer.files);
    });

    this.initVideoSettingsListeners();
    this.initBackgroundColorListeners();

    processBtn.addEventListener('click', () => this.startProcessing());

    const smartRenamingCheckbox = document.getElementById('smartRenaming');
    const useOriginalNamesCheckbox = document.getElementById('useOriginalNames');
    const globalBaseInput = document.getElementById('globalBaseName');

    smartRenamingCheckbox && smartRenamingCheckbox.addEventListener('change', () => this.updateNamingExample());
    useOriginalNamesCheckbox && useOriginalNamesCheckbox.addEventListener('change', () => this.updateNamingExample());
    globalBaseInput && globalBaseInput.addEventListener('input', () => this.updateNamingExample());
  }

  initVideoSettingsListeners() {
    document.querySelectorAll('.resolution-option').forEach(option => {
      option.addEventListener('click', (e) => {
        document.querySelectorAll('.resolution-option').forEach(opt => opt.classList.remove('selected'));
        e.currentTarget.classList.add('selected');
        this.currentSettings.selectedVideoResolution = e.currentTarget.dataset.resolution;
      });
    });

    document.querySelectorAll('.video-format-option').forEach(option => {
      option.addEventListener('click', (e) => {
        document.querySelectorAll('.video-format-option').forEach(opt => opt.classList.remove('selected'));
        e.currentTarget.classList.add('selected');
        this.currentSettings.selectedVideoFormat = e.currentTarget.dataset.format;
      });
    });

    document.querySelectorAll('.video-quality-option').forEach(option => {
      option.addEventListener('click', (e) => {
        document.querySelectorAll('.video-quality-option').forEach(opt => opt.classList.remove('selected'));
        e.currentTarget.classList.add('selected');
        this.currentSettings.selectedVideoQuality = e.currentTarget.dataset.quality;
      });
    });
  }

  initBackgroundColorListeners() {
    document.querySelectorAll('.background-color-option').forEach(option => {
      option.addEventListener('click', (e) => {
        const selected = e.currentTarget.dataset.background;
        this.setBackgroundSelection(selected);
      });
    });

    const picker = document.getElementById('customColorPicker');
    const hex = document.getElementById('customColorHex');

    picker.addEventListener('input', (e) => {
      hex.value = e.target.value;
      this.updateCustomPreview();
    });

    hex.addEventListener('input', (e) => {
      const value = e.target.value;
      if (value.startsWith('#') && (value.length === 4 || value.length === 7)) {
        picker.value = value;
        this.updateCustomPreview();
      }
    });

    this.updateCustomPreview();
  }

  updateCustomPreview() {
    const hex = document.getElementById('customColorHex').value;
    const preview = document.getElementById('customBgPreview');
    if (preview) preview.style.background = (this.isValidHex(hex) ? hex : '#ffffff');
  }

  isValidHex(color) {
    return /^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(color);
  }

  setBackgroundSelection(selected) {
    document.querySelectorAll('.background-color-option').forEach(opt => opt.classList.remove('selected'));
    const opt = document.querySelector(`.background-color-option[data-background="${selected}"]`);
    if (opt) opt.classList.add('selected');
    this.currentSettings.selectedBackground = selected;
  }

  applyCustomColor() {
    this.setBackgroundSelection('custom');
  }

  handleFiles(fileList) {
    const files = Array.from(fileList);
    files.forEach(file => {
      file.customName = file.name.replace(/\.[^/.]+$/, '');
      this.files.push(file);
    });
    this.updateUI();
  }

  updateUI() {
    const fileList = document.getElementById('fileList');
    let emptyState = document.getElementById('emptyState');
    const statsInfo = document.getElementById('statsInfo');

    if (!fileList) return;

    // –ï—Å–ª–∏ emptyState –±—ã–ª —É–¥–∞–ª—ë–Ω –ø—Ä–∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–µ —Å–ø–∏—Å–∫–∞ ‚Äî –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë–º –µ–≥–æ
    if (!emptyState) {
      emptyState = document.createElement('div');
      emptyState.className = 'empty-state hidden';
      emptyState.id = 'emptyState';
      emptyState.innerHTML = `
        <div class="upload-icon">üìÑ</div>
        <h3>–ù–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤</h3>
        <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É</p>
      `;
      fileList.prepend(emptyState);
    }

    // –í—Å–µ–≥–¥–∞ –¥–µ—Ä–∂–∏–º emptyState –≤ DOM (–∏–Ω–∞—á–µ getElementById –≤–µ—Ä–Ω—ë—Ç null –ø–æ—Å–ª–µ fileList.innerHTML = ...)
    const emptyStateHTML = emptyState.outerHTML;

    if (this.files.length === 0) {
      emptyState.classList.remove('hidden');
      if (statsInfo) statsInfo.textContent = '';
      fileList.innerHTML = emptyStateHTML;
      this.updateNamingExample();
      return;
    }

    emptyState.classList.add('hidden');

    let html = '';
    let totalSize = 0;
    let imageCount = 0;
    let audioCount = 0;
    let videoCount = 0;

    this.files.forEach((file, index) => {
      totalSize += file.size;
      const type = FileUtils.getFileType(file.name);
      if (type === '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ') imageCount++;
      if (type === '–ê—É–¥–∏–æ') audioCount++;
      if (type === '–í–∏–¥–µ–æ') videoCount++;

      html += `
        <div class="file-item" data-index="${index}">
          <div class="file-info">
            <span class="file-icon">${this.getFileIcon(type)}</span>
            <div>
              <input type="text"
                class="rename-input"
                value="${FileUtils.escapeHtmlAttr(file.customName)}"
                onchange="appState.updateFileName(${index}, this.value)"
                placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ñ–∞–π–ª–∞">
              <div class="file-size">${FileUtils.formatFileSize(file.size)} ‚Ä¢ ${type}</div>
            </div>
          </div>
          <button class="cancel-btn" onclick="appState.removeFile(${index})">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      `;
    });

    fileList.innerHTML = emptyStateHTML + html;

    let stats = `${this.files.length} —Ñ–∞–π–ª–æ–≤ ‚Ä¢ ${FileUtils.formatFileSize(totalSize)}`;
    if (imageCount > 0) stats += ` ‚Ä¢ ${imageCount} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π`;
    if (audioCount > 0) stats += ` ‚Ä¢ ${audioCount} –∞—É–¥–∏–æ`;
    if (videoCount > 0) stats += ` ‚Ä¢ ${videoCount} –≤–∏–¥–µ–æ`;

    if (statsInfo) statsInfo.textContent = stats;
    this.updateNamingExample();
  }

  getFileIcon(type) {
    switch (type) {
      case '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ': return 'üñºÔ∏è';
      case '–ê—É–¥–∏–æ': return 'üéµ';
      case '–í–∏–¥–µ–æ': return 'üé¨';
      default: return 'üìÑ';
    }
  }

  updateFileName(index, newName) {
    if (index >= 0 && index < this.files.length) {
      this.files[index].customName = newName || this.files[index].name.replace(/\.[^/.]+$/, '');
      this.updateNamingExample();
    }
  }

  removeFile(index) {
    if (index >= 0 && index < this.files.length) {
      this.files.splice(index, 1);
      this.updateUI();
    }
  }

  getGlobalBaseName() {
    const input = document.getElementById('globalBaseName');
    if (!input) return '';
    return input.value.trim() || '';
  }

  extractNumberFromName(name) {
    const match = name.match(/(\d+)/);
    return match ? match[1] : '';
  }

  updateNamingExample() {
    const exampleEl = document.getElementById('namingExample');
    if (!exampleEl) return;

    if (this.files.length === 0) {
      exampleEl.textContent = 'logo.png –∏–ª–∏ logo_1.png, logo_2.png';
      return;
    }

    const useSmart = document.getElementById('smartRenaming')?.checked || false;
    const useOriginal = document.getElementById('useOriginalNames')?.checked || false;
    const globalBase = this.getGlobalBaseName();

    const firstFile = this.files[0];
    const type = FileUtils.getFileType(firstFile.name);

    if (useOriginal) {
      const ext = (firstFile.name.split('.').pop() || '').toLowerCase();
      const base = firstFile.name.replace(/\.[^/.]+$/, '');
      exampleEl.textContent = `${base}.${ext}, ${base}_2.${ext}, ${base}_3.${ext}`;
      return;
    }

    if (useSmart && globalBase && type === '–ê—É–¥–∏–æ') {
      const nums = this.files.slice(0, 3).map(f => this.extractNumberFromName(f.name)).filter(Boolean);
      if (nums.length) {
        exampleEl.textContent = nums.map(n => `${globalBase}${n}.mp3`).join(', ');
        return;
      }
    }

    const baseName = useSmart ? (globalBase || this.getSmartPrefix(type)) : (firstFile.customName || firstFile.name.replace(/\.[^/.]+$/, '') || 'file');

    // –ø—Ä–∏ useSmart –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–º–µ—Ä–∞—Ü–∏—é, —á—Ç–æ–±—ã –±—ã–ª–æ –ø–æ–Ω—è—Ç–Ω–æ —á—Ç–æ –±—É–¥–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω–æ
    if (useSmart) {
      if (type === '–í–∏–¥–µ–æ') exampleEl.textContent = `${baseName}_1.mp4, ${baseName}_2.mp4, ${baseName}_3.mp4`;
      else if (type === '–ê—É–¥–∏–æ') exampleEl.textContent = `${baseName}_1.mp3, ${baseName}_2.mp3, ${baseName}_3.mp3`;
      else exampleEl.textContent = `${baseName}_1.png, ${baseName}_2.png, ${baseName}_3.png`;
      return;
    }

    if (type === '–ê—É–¥–∏–æ') exampleEl.textContent = `${baseName}.mp3, ${baseName}_2.mp3, ${baseName}_3.mp3`;
    else if (type === '–í–∏–¥–µ–æ') exampleEl.textContent = `${baseName}.mp4, ${baseName}_2.mp4, ${baseName}_3.mp4`;
    else exampleEl.textContent = `${baseName}.png, ${baseName}_2.png, ${baseName}_3.png`;
  }

  /* =======================
     SMART PLAN (–ø—Ä–∞–≤–∫–∞ C):
     —Å—á–∏—Ç–∞–µ–º, —Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤ –≤—ã–π–¥–µ—Ç –≤ –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø–µ (type+base+ext),
     —á—Ç–æ–±—ã:
       - –µ—Å–ª–∏ –≤—Å–µ–≥–æ 1 ‚Üí base.ext
       - –µ—Å–ª–∏ >1 ‚Üí base_1.ext, base_2.ext ...
  ======================= */
  prepareSmartNamingPlan(settings) {
    const useSmart = document.getElementById('smartRenaming')?.checked || false;
    if (!useSmart) {
      this.smartPlanCounts = null;
      this.smartCounters = null;
      return;
    }

    const globalBase = this.getGlobalBaseName();

    const baseForType = (type) => (globalBase || this.getSmartPrefix(type));

    const sizes = FileUtils.parseSizes(document.getElementById('imageSizes')?.value || '');
    const sizeCount = sizes.length ? sizes.length : 1;

    const selectedFormats = [];
    if (document.getElementById('formatPNG')?.checked) selectedFormats.push('png');
    if (document.getElementById('formatJPG')?.checked) selectedFormats.push('jpg');

    const plan = {};

    const add = (key, n) => {
      plan[key] = (plan[key] || 0) + n;
    };

    for (const file of this.files) {
      const type = FileUtils.getFileType(file.name);

      if (type === '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ') {
        const base = baseForType(type);

        const formats = selectedFormats.length
          ? selectedFormats
          : [FileUtils.inferImageFormatFromFile(file)];

        for (const fmt of formats) {
          add(`${type}:${base}:${fmt}`, sizeCount);
        }
      }

      if (type === '–í–∏–¥–µ–æ') {
        const base = baseForType(type);
        const fmt = (settings.selectedVideoFormat || 'mp4').toLowerCase();
        add(`${type}:${base}:${fmt}`, 1);
      }

      // –ê—É–¥–∏–æ –≤ smart —Ä–µ–∂–∏–º–µ —É —Ç–µ–±—è –æ—Ç–¥–µ–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–æ–π base+digits,
      // –µ–≥–æ –≤ —ç—Ç–æ—Ç –ø–ª–∞–Ω –Ω–µ –≤–∫–ª—é—á–∞–µ–º.
    }

    this.smartPlanCounts = plan;
    this.smartCounters = {};
  }

  /* =======================
     generateFileName (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ C + E):
     - useOriginalNames: –ø—Ä–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤–∞—Ä–∏–∞–Ω—Ç–∞—Ö –¥–æ–±–∞–≤–ª—è–µ—Ç —Å—É—Ñ—Ñ–∏–∫—Å
     - useSmart: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Å—á—ë—Ç—á–∏–∫–∏ (—É–Ω–∏–∫–∞–ª—å–Ω–æ –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤)
     - audio smart base+digits –æ—Å—Ç–∞–≤–ª–µ–Ω –∫–∞–∫ –±—ã–ª–æ
  ======================= */
  generateFileName(baseName, format, type, originalName, index, fileIndex, totalVariants) {
    const useSmart = document.getElementById('smartRenaming')?.checked || false;
    const useOriginal = document.getElementById('useOriginalNames')?.checked || false;
    const globalBase = this.getGlobalBaseName();

    const originalExt = (originalName.split('.').pop() || '').toLowerCase();
    const ext = (format || originalExt || '').toLowerCase() || 'dat';
    const originalBase = originalName.replace(/\.[^/.]+$/, '') || baseName || 'file';

    // E) useOriginalNames + multiple variants
    if (useOriginal) {
      if (totalVariants && totalVariants > 1) {
        if (index === 1) return `${originalBase}.${ext}`;
        return `${originalBase}_${index}.${ext}`;
      }
      return `${originalBase}.${ext}`;
    }

    // –∞—É–¥–∏–æ: base + number –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞
    if (useSmart && globalBase && type === '–ê—É–¥–∏–æ') {
      const num = this.extractNumberFromName(originalName);
      if (num) return `${globalBase}${num}.${ext}`;
      // –µ—Å–ª–∏ —á–∏—Å–ª–∞ –Ω–µ—Ç ‚Äî –ø–∞–¥–∞–µ–º –Ω–∞ –æ–±—â–∏–π smart-—Å—á—ë—Ç—á–∏–∫ –Ω–∏–∂–µ
    }

    let nameBase = useSmart ? (globalBase || this.getSmartPrefix(type)) : (baseName || originalBase || 'file');

    // C) smart naming: —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞ –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤/–≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
    if (useSmart) {
      const key = `${type}:${nameBase}:${ext}`;
      const total = this.smartPlanCounts ? (this.smartPlanCounts[key] || 0) : 0;

      if (total <= 1) {
        return `${nameBase}.${ext}`;
      }

      const next = (this.smartCounters[key] || 0) + 1;
      this.smartCounters[key] = next;
      return `${nameBase}_${next}.${ext}`;
    }

    // –æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º (–Ω–µ smart)
    if (index === 1) return `${nameBase}.${ext}`;
    return `${nameBase}_${index}.${ext}`;
  }

  getSmartPrefix(type) {
    switch (type) {
      case '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ': return 'image';
      case '–ê—É–¥–∏–æ': return 'audio';
      case '–í–∏–¥–µ–æ': return 'video';
      default: return 'file';
    }
  }

  async startProcessing() {
    if (this.files.length === 0) {
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏');
      return;
    }

    const processBtn = document.getElementById('processBtn');
    const progressBar = document.getElementById('progressBar');
    const progress = document.getElementById('progress');
    const result = document.getElementById('result');
    const downloadSection = document.getElementById('downloadSection');

    processBtn.disabled = true;
    processBtn.textContent = 'üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞...';

    progressBar.classList.remove('hidden');
    progress.style.width = '0%';

    result.classList.add('hidden');
    downloadSection.classList.add('hidden');
    this.processedFiles = [];

    const settings = {
      imageSizes: document.getElementById('imageSizes').value,
      selectedBackground: this.currentSettings.selectedBackground,
      selectedVideoResolution: this.currentSettings.selectedVideoResolution,
      selectedVideoQuality: this.currentSettings.selectedVideoQuality,
      selectedVideoFormat: this.currentSettings.selectedVideoFormat
    };

    // === –≤–∞–∂–Ω–∞—è –ø—Ä–∞–≤–∫–∞: —Å—Ç—Ä–æ–∏–º smart-–ø–ª–∞–Ω –î–û –æ–±—Ä–∞–±–æ—Ç–∫–∏ ===
    this.prepareSmartNamingPlan(settings);

    try {
      await this.mediaProcessor.processFiles(
        this.files,
        settings,
        (percent) => { progress.style.width = `${percent}%`; },
        (processedBatch) => {
          this.processedFiles.push(...processedBatch);
          this.updateResultsUI();
        }
      );

      progress.style.width = '100%';
      result.classList.remove('hidden');
      downloadSection.classList.remove('hidden');
      document.getElementById('downloadAllBtn').onclick = () => this.downloadAllAsZip();

    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏:', error);
      this.showError('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: ' + error.message);
    } finally {
      processBtn.disabled = false;
      processBtn.textContent = 'üöÄ –ù–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É';
    }
  }

  updateResultsUI() {
    const resultFiles = document.getElementById('resultFiles');
    let html = '';
    let totalOriginal = 0;
    let totalCompressed = 0;

    this.processedFiles.forEach((file, index) => {
      totalOriginal += file.originalSize;
      totalCompressed += file.compressedSize;

      const compression = file.originalSize > 0 ? Math.round((1 - file.compressedSize / file.originalSize) * 100) : 0;
      const compressionText = compression > 0 ? ` (—Å–∂–∞—Ç–∏–µ: ${compression}%)` : '';
      const note = file.note ? `<div style="font-size:0.8em;color:#666;">${file.note}</div>` : '';

      html += `
        <div class="result-file">
          <div>
            <strong>${FileUtils.escapeHtmlAttr(file.name)}</strong>
            <div class="file-size-compression">
              ${FileUtils.formatFileSize(file.originalSize)} ‚Üí
              ${FileUtils.formatFileSize(file.compressedSize)}${compressionText}
              ${file.resolution ? ` ‚Ä¢ ${file.resolution}` : ''}
              ${file.format ? ` ‚Ä¢ ${String(file.format).toUpperCase()}` : ''}
              ${file.bitrate ? ` ‚Ä¢ ${file.bitrate}` : ''}
            </div>
            ${note}
          </div>
          <button class="download-btn" onclick="appState.downloadSingleFile(${index})">üì• –°–∫–∞—á–∞—Ç—å</button>
        </div>
      `;
    });

    const totalCompression = totalOriginal > 0 ? Math.round((1 - totalCompressed / totalOriginal) * 100) : 0;

    const statsHtml = `
      <div style="margin-bottom:15px;padding:10px;background:#d4edda;border-radius:8px;">
        <strong>üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</strong><br>
        –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: ${this.processedFiles.length}<br>
        –û–±—â–∏–π —Ä–∞–∑–º–µ—Ä: ${FileUtils.formatFileSize(totalOriginal)} ‚Üí ${FileUtils.formatFileSize(totalCompressed)}<br>
        –û–±—â–µ–µ —Å–∂–∞—Ç–∏–µ: ${totalCompression}%
      </div>
    `;

    resultFiles.innerHTML = statsHtml + html;
  }

  downloadSingleFile(index) {
    if (index >= 0 && index < this.processedFiles.length) {
      const file = this.processedFiles[index];
      const url = URL.createObjectURL(file.blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = file.name;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  }

  async downloadAllAsZip() {
    try {
      const zip = new JSZip();
      const folder = zip.folder("processed_files");

      this.processedFiles.forEach(file => folder.file(file.name, file.blob));

      const readme = `
–û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –º–µ–¥–∏–∞—Ñ–∞–π–ª—ã
–î–∞—Ç–∞: ${new Date().toLocaleDateString()}
–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤: ${this.processedFiles.length}

–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏:
- –§–æ–Ω –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: ${this.currentSettings.selectedBackground}
- –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –≤–∏–¥–µ–æ: ${this.currentSettings.selectedVideoResolution}
- –ö–∞—á–µ—Å—Ç–≤–æ –≤–∏–¥–µ–æ: ${this.currentSettings.selectedVideoQuality}
- –§–æ—Ä–º–∞—Ç –≤–∏–¥–µ–æ: ${this.currentSettings.selectedVideoFormat}

–°–æ–∑–¥–∞–Ω–æ —Å –ø–æ–º–æ—â—å—é MediaProcessor | Relation-AI
      `.trim();

      folder.file("README.txt", readme);

      const content = await zip.generateAsync({ type: "blob" });
      const url = URL.createObjectURL(content);
      const a = document.createElement('a');
      a.href = url;
      a.download = `processed_files_${Date.now()}.zip`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è ZIP:', error);
      this.showError('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞—Ä—Ö–∏–≤–∞: ' + error.message);
    }
  }

  showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'temp-message error-message';
    errorDiv.innerHTML = `<strong>‚ùå –û—à–∏–±–∫–∞:</strong> ${FileUtils.escapeHtmlAttr(message)}`;

    const container = document.querySelector('.container');
    container.insertBefore(errorDiv, container.children[1]);

    setTimeout(() => errorDiv.remove(), 6000);
  }

  /* =======================
     AI: —Å–æ–≤–µ—Ç–Ω–∏–∫ (—Ä–µ–∞–ª—å–Ω—ã–π)
  ======================= */
  getAIAdvice() {
    const aiTip = document.getElementById('aiTip');
    const aiResults = document.getElementById('aiResults');
    const aiStats = document.getElementById('aiStats');
    const aiTipsList = document.getElementById('aiTipsList');

    const total = this.files.length;
    const images = this.files.filter(f => FileUtils.getFileType(f.name) === '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
    const audios = this.files.filter(f => FileUtils.getFileType(f.name) === '–ê—É–¥–∏–æ');
    const videos = this.files.filter(f => FileUtils.getFileType(f.name) === '–í–∏–¥–µ–æ');
    const totalSize = this.files.reduce((s, f) => s + f.size, 0);

    const tips = [];

    const ffmpegReady = this.mediaProcessor?.videoProcessor?.isFFmpegReady;
    const corePath = this.mediaProcessor?.videoProcessor?.loadedCorePath || '‚Äî';
    const coreMode = this.mediaProcessor?.videoProcessor?.coreMode || '‚Äî';

    if (!ffmpegReady) {
      tips.push('FFmpeg WASM —Å–µ–π—á–∞—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí –≤–∏–¥–µ–æ/–∞—É–¥–∏–æ –º–æ–≥—É—Ç –≤—ã—Ö–æ–¥–∏—Ç—å ‚Äú–∫–∞–∫ –æ—Ä–∏–≥–∏–Ω–∞–ª‚Äù. –ï—Å–ª–∏ –≤–∏–¥–∏—à—å SharedArrayBuffer/CORS ‚Äî –¥–æ–±–∞–≤—å COOP/COEP —á–µ—Ä–µ–∑ vercel.json –∏/–∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å –ø—É—Ç–∏ /ffmpeg/*.');
    } else {
      tips.push(`FFmpeg –≥–æ—Ç–æ–≤ ‚úÖ (${coreMode}, corePath: ${corePath.includes('http') ? 'CDN' : 'local'})`);
    }

    const png = document.getElementById('formatPNG').checked;
    const jpg = document.getElementById('formatJPG').checked;
    if (images.length && !png && !jpg) tips.push('–î–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–µ –≤—ã–±—Ä–∞–Ω—ã —Ñ–æ—Ä–º–∞—Ç—ã –≤—ã–≤–æ–¥–∞ (PNG/JPG). –°–µ–π—á–∞—Å –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω —Ñ–æ—Ä–º–∞—Ç –∏—Å—Ö–æ–¥–Ω–∏–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.');

    const mp3 = document.getElementById('audioMP3').checked;
    const ogg = document.getElementById('audioOGG').checked;
    if (audios.length && !mp3 && !ogg) tips.push('–î–ª—è –∞—É–¥–∏–æ –Ω–µ –≤—ã–±—Ä–∞–Ω —Ñ–æ—Ä–º–∞—Ç (MP3/OGG). –ò–Ω–∞—á–µ –∞—É–¥–∏–æ –≤—ã–π–¥–µ—Ç ‚Äú–∫–∞–∫ –µ—Å—Ç—å‚Äù.');

    const useSmart = document.getElementById('smartRenaming').checked;
    const base = this.getGlobalBaseName();
    if (useSmart && !base) tips.push('–£–º–Ω–æ–µ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ, –Ω–æ ‚Äú–æ–±—â–µ–µ –∏–º—è‚Äù –ø—É—Å—Ç–æ–µ ‚Üí –∑–∞–ø–æ–ª–Ω–∏, –∏–Ω–∞—á–µ –±—É–¥–µ—Ç image/audio/video.');
    if (useSmart && base && audios.length) tips.push('–î–ª—è –∞—É–¥–∏–æ —É–º–Ω–æ–µ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ü–∏—Ñ—Ä—ã –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∏–º–µ–Ω–∏: base+—á–∏—Å–ª–æ (–ø—Ä–∏–º–µ—Ä: audio_hook333.mp3).');

    if (videos.length > 2) tips.push('–í–∏–¥–µ–æ > 2 —à—Ç: –ª—É—á—à–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å 1‚Äì2 –≤–∏–¥–µ–æ –∑–∞ —Ä–∞–∑, –∏–Ω–∞—á–µ –≤–æ–∑–º–æ–∂–Ω—ã –≤—ã–ª–µ—Ç—ã –ø–æ –ø–∞–º—è—Ç–∏ (–æ—Å–æ–±–µ–Ω–Ω–æ –Ω–∞ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–∞—Ö).');

    const bg = this.currentSettings.selectedBackground;
    if (jpg && bg === 'transparent') tips.push('–í—ã–±—Ä–∞–Ω ‚Äú–ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π‚Äù —Ñ–æ–Ω, –Ω–æ JPG –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç ‚Üí –±—É–¥–µ—Ç –∑–∞–ª–∏–≤–∫–∞ –±–µ–ª—ã–º.');

    const sizesRaw = (document.getElementById('imageSizes').value || '').split(',').map(s => s.trim()).filter(Boolean);
    if (sizesRaw.length > 8) tips.push('–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–æ–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π ‚Üí —Å–∏–ª—å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –∏ –±–æ–ª—å—à–æ–π ZIP. –õ—É—á—à–µ 3‚Äì6 —Ä–∞–∑–º–µ—Ä–æ–≤ –∑–∞ —Ä–∞–∑.');

    if (aiTip) {
      aiTip.querySelector('.ai-tip-header strong').textContent = '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –≥–æ—Ç–æ–≤—ã';
      aiTip.querySelector('.ai-tip-content').textContent = tips[0] || '–ù–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π ‚Äî –≤—Å—ë –≤—ã–≥–ª—è–¥–∏—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ.';
    }

    aiStats.innerHTML = `
      <strong>üìå –°–≤–æ–¥–∫–∞:</strong><br>
      –§–∞–π–ª–æ–≤: ${total} ‚Ä¢ ${FileUtils.formatFileSize(totalSize)}<br>
      –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ${images.length} ‚Ä¢ –ê—É–¥–∏–æ: ${audios.length} ‚Ä¢ –í–∏–¥–µ–æ: ${videos.length}<br>
      –í–∏–¥–µ–æ: ${this.currentSettings.selectedVideoResolution}, –∫–∞—á–µ—Å—Ç–≤–æ: ${this.currentSettings.selectedVideoQuality}
    `;

    aiTipsList.innerHTML = tips.map(t => `<div class="ai-tip-item">${t}</div>`).join('');
    aiResults.classList.remove('hidden');
  }

  /* =======================
     AI: –∞–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
  ======================= */
  async analyzeAllImages() {
    const aiResults = document.getElementById('aiResults');
    const aiStats = document.getElementById('aiStats');
    const aiTipsList = document.getElementById('aiTipsList');

    const images = this.files.filter(f => FileUtils.getFileType(f.name) === '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
    if (!images.length) {
      this.showError('–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.');
      return;
    }

    const results = [];
    for (const file of images.slice(0, 30)) {
      const info = await this.getImageInfo(file);
      results.push(info);
    }

    const big = results.filter(r => r.megapixels >= 4).length;
    const small = results.filter(r => r.megapixels < 1).length;

    aiStats.innerHTML = `
      <strong>üé® –ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:</strong><br>
      –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ: ${results.length}<br>
      ‚â•4MP: ${big} ‚Ä¢ &lt;1MP: ${small}<br>
      –°–æ–≤–µ—Ç: –Ω–µ —É–≤–µ–ª–∏—á–∏–≤–∞–π —Ä–∞–∑–º–µ—Ä –±–æ–ª—å—à–µ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –º—ã–ª–∞.
    `;

    aiTipsList.innerHTML = results.map(r => {
      const warn = r.tooSmall ? ' ‚ö†Ô∏è –º–∞–ª–æ –ø–∏–∫—Å–µ–ª–µ–π' : '';
      return `<div class="ai-tip-item"><strong>${FileUtils.escapeHtmlAttr(r.name)}</strong><br>${r.w}√ó${r.h} (${r.megapixels.toFixed(2)} MP) ‚Ä¢ ${FileUtils.formatFileSize(r.size)}${warn}</div>`;
    }).join('');

    aiResults.classList.remove('hidden');
  }

  getImageInfo(file) {
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const w = img.width, h = img.height;
          const mp = (w * h) / 1_000_000;
          resolve({
            name: file.name,
            size: file.size,
            w, h,
            megapixels: mp,
            tooSmall: (w < 600 || h < 600)
          });
        };
        img.onerror = () => resolve({ name: file.name, size: file.size, w: 0, h: 0, megapixels: 0, tooSmall: true });
        img.src = e.target.result;
      };
      reader.onerror = () => resolve({ name: file.name, size: file.size, w: 0, h: 0, megapixels: 0, tooSmall: true });
      reader.readAsDataURL(file);
    });
  }

  /* =======================
     AI: –∞–Ω–∞–ª–∏–∑ –±—Ä–µ–Ω–¥–∞ (–ø–∞–ª–∏—Ç—Ä–∞ + —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏)
  ======================= */
  async analyzeBrandAssets() {
    const out = document.getElementById('brandAnalysisResults');
    out.classList.add('hidden');
    out.innerHTML = '';

    const images = this.files.filter(f => FileUtils.getFileType(f.name) === '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
    if (!images.length) {
      this.showError('–î–ª—è –∞–Ω–∞–ª–∏–∑–∞ –±—Ä–µ–Ω–¥–∞ –Ω—É–∂–Ω—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.');
      return;
    }

    const sample = images.slice(0, 6);
    const paletteMap = new Map();
    let brightnessSum = 0;
    let brightnessCount = 0;

    let squareish = 0;
    let wide = 0;
    let tall = 0;

    for (const file of sample) {
      const { colors, avgBrightness, ratio } = await this.sampleImageColors(file);
      brightnessSum += avgBrightness;
      brightnessCount++;

      if (ratio > 0.85 && ratio < 1.18) squareish++;
      else if (ratio >= 1.18) wide++;
      else tall++;

      for (const [hex, count] of colors.entries()) {
        paletteMap.set(hex, (paletteMap.get(hex) || 0) + count);
      }
    }

    const avgB = brightnessCount ? (brightnessSum / brightnessCount) : 0.6;

    const top = [...paletteMap.entries()]
      .sort((a, b) => b[1] - a[1])
      .slice(0, 6)
      .map(([hex]) => hex);

    const recommendedBg = (avgB < 0.45) ? 'white' : 'lightgray';
    const recommendedPreset = (squareish >= wide && squareish >= tall) ? 'logos' : (tall > wide ? 'vertical' : 'creatives');

    this.lastBrandRecommendations = { recommendedBg, recommendedPreset, palette: top };

    const paletteHtml = top.length
      ? `<div class="color-palette">${top.map(hex => `<div class="color-swatch" style="background:${hex}" data-hex="${hex}"></div>`).join('')}</div>`
      : `<div style="opacity:.9;">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –ø–∞–ª–∏—Ç—Ä—É (–ø–æ–ø—Ä–æ–±—É–π PNG/JPG –±–µ–∑ SVG).</div>`;

    out.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
        <div><strong>üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –±—Ä–µ–Ω–¥–∞</strong></div>
        <button class="ai-btn secondary" onclick="appState.applyBrandRecommendations()" style="flex:0 0 auto;">‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</button>
      </div>
      <div style="margin-top:10px;opacity:.95;">
        –°—Ä–µ–¥–Ω—è—è ‚Äú—Å–≤–µ—Ç–ª–æ—Ç–∞‚Äù –≤–∏–∑—É–∞–ª–∞: <strong>${Math.round(avgB * 100)}%</strong><br>
        –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ–Ω: <strong>${recommendedBg}</strong> ‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–µ—Å–µ—Ç: <strong>${recommendedPreset}</strong>
      </div>
      <div style="margin-top:10px;"><strong>–ü–∞–ª–∏—Ç—Ä–∞ (—Ç–æ–ø —Ü–≤–µ—Ç–æ–≤):</strong>${paletteHtml}</div>
      <div style="margin-top:10px;font-size:.92em;opacity:.9;">
        –°–æ–≤–µ—Ç: –∑–∞–∫—Ä–µ–ø–∏ –ø–∞–ª–∏—Ç—Ä—É (2 –Ω–µ–π—Ç—Ä–∞–ª–∞ + 1 –∞–∫—Ü–µ–Ω—Ç) –∏ –¥–µ–ª–∞–π –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –ø–æ–¥–ª–æ–∂–∫–∏ ‚Üí –∫–∞—Ä—Ç–æ—á–∫–∏ –±—É–¥—É—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å ‚Äú–±—Ä–µ–Ω–¥–æ–≤–æ‚Äù.
      </div>
    `;

    out.classList.remove('hidden');

    if (document.getElementById('aiAnalysis').checked) {
      this.applyBrandRecommendations();
    }
  }

  applyBrandRecommendations() {
    if (!this.lastBrandRecommendations) return;

    const { recommendedBg, recommendedPreset } = this.lastBrandRecommendations;
    this.setBackgroundSelection(recommendedBg);
    this.loadPreset(recommendedPreset);

    const aiTip = document.getElementById('aiTip');
    if (aiTip) {
      aiTip.querySelector('.ai-tip-header strong').textContent = '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã';
      aiTip.querySelector('.ai-tip-content').textContent = `–§–æ–Ω: ${recommendedBg}, –ø—Ä–µ—Å–µ—Ç —Ä–∞–∑–º–µ—Ä–æ–≤: ${recommendedPreset}.`;
    }
  }

  sampleImageColors(file) {
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');

          const max = 180;
          const scale = Math.min(max / img.width, max / img.height, 1);
          const w = Math.max(1, Math.floor(img.width * scale));
          const h = Math.max(1, Math.floor(img.height * scale));

          canvas.width = w;
          canvas.height = h;
          ctx.drawImage(img, 0, 0, w, h);

          const data = ctx.getImageData(0, 0, w, h).data;

          const colors = new Map();
          let bSum = 0;
          let bN = 0;

          const step = 6;
          for (let y = 0; y < h; y += step) {
            for (let x = 0; x < w; x += step) {
              const i = (y * w + x) * 4;
              const r = data[i], g = data[i + 1], b = data[i + 2], a = data[i + 3];
              if (a < 30) continue;

              const q = 32;
              const rq = Math.floor(r / q) * q;
              const gq = Math.floor(g / q) * q;
              const bq = Math.floor(b / q) * q;

              const hex = '#' + [rq, gq, bq].map(v => v.toString(16).padStart(2, '0')).join('');
              colors.set(hex, (colors.get(hex) || 0) + 1);

              const br = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
              bSum += br;
              bN++;
            }
          }

          const ratio = img.width / img.height;
          resolve({ colors, avgBrightness: bN ? bSum / bN : 0.6, ratio });
        };
        img.onerror = () => resolve({ colors: new Map(), avgBrightness: 0.6, ratio: 1 });
        img.src = e.target.result;
      };
      reader.onerror = () => resolve({ colors: new Map(), avgBrightness: 0.6, ratio: 1 });
      reader.readAsDataURL(file);
    });
  }

  /* =======================
     misc controls
  ======================= */
  resetAllSettings() {
    this.currentSettings = this.getDefaultSettings();
    document.getElementById('imageSizes').value = this.currentSettings.imageSizes;

    document.querySelectorAll('.resolution-option').forEach(opt => opt.classList.remove('selected'));
    document.querySelector('.resolution-option[data-resolution="640x360"]').classList.add('selected');

    document.querySelectorAll('.video-format-option').forEach(opt => opt.classList.remove('selected'));
    document.querySelector('.video-format-option[data-format="mp4"]').classList.add('selected');

    document.querySelectorAll('.video-quality-option').forEach(opt => opt.classList.remove('selected'));
    document.querySelector('.video-quality-option[data-quality="medium"]').classList.add('selected');

    this.setBackgroundSelection('white');

    alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–±—Ä–æ—à–µ–Ω—ã!');
    this.updateNamingExample();
  }

  clearAllCheckboxes() {
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = false);
    this.updateNamingExample();
    alert('–í—Å–µ –≥–∞–ª–æ—á–∫–∏ —É–±—Ä–∞–Ω—ã!');
  }

  selectAllCheckboxes(type) {
    let selector = '';
    switch (type) {
      case 'image': selector = '#formatPNG, #formatJPG'; break;
      case 'audio': selector = '#audioMP3, #audioOGG'; break;
      case 'ai': selector = '#aiAnalysis'; break;
    }
    if (selector) document.querySelectorAll(selector).forEach(cb => cb.checked = true);
    this.updateNamingExample();
  }

  clearCheckboxes(type) {
    let selector = '';
    switch (type) {
      case 'image': selector = '#formatPNG, #formatJPG'; break;
      case 'audio': selector = '#audioMP3, #audioOGG'; break;
      case 'ai': selector = '#aiAnalysis'; break;
    }
    if (selector) document.querySelectorAll(selector).forEach(cb => cb.checked = false);
    this.updateNamingExample();
  }

  loadPreset(preset) {
    switch (preset) {
      case 'creatives': document.getElementById('imageSizes').value = '1200x600, 800x400, 600x300'; break;
      case 'vertical': document.getElementById('imageSizes').value = '1080x1920, 800x1400, 400x700'; break;
      case 'logos': document.getElementById('imageSizes').value = '800x800, 400x400, 200x200'; break;
      case 'icons': document.getElementById('imageSizes').value = '256x256, 128x128, 64x64, 32x32'; break;
    }
    alert(`–ü—Ä–µ—Å–µ—Ç "${preset}" –∑–∞–≥—Ä—É–∂–µ–Ω!`);
    this.updateNamingExample();
  }
}

/* =======================
   Init
======================= */
let appState;
document.addEventListener('DOMContentLoaded', () => {
  appState = new AppState();

  document.getElementById('customColorHex').addEventListener('change', (e) => {
    let value = e.target.value.trim();
    if (!value.startsWith('#')) value = '#' + value;
    e.target.value = value;
    if (value.length === 4 || value.length === 7) {
      document.getElementById('customColorPicker').value = value;
      appState.updateCustomPreview();
    }
  });

  window.appState = appState;
});
</script>
</body>
</html>
