<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MediaProcessor | Relation-AI</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <style>
    *{box-sizing:border-box;font-family:Segoe UI,system-ui,Arial}
    body{margin:0;background:#f3f6ff;padding:24px}
    .card{max-width:980px;margin:0 auto;background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.08);overflow:hidden}
    header{padding:20px 24px;background:linear-gradient(135deg,#2c3e50,#34495e);color:#fff}
    header h1{margin:0;font-size:22px}
    header p{margin:6px 0 0;opacity:.9}
    .row{padding:18px 24px;border-top:1px solid #eef2ff}
    .zone{border:2px dashed #6b8cff;background:#f7f9ff;border-radius:14px;padding:24px;text-align:center;cursor:pointer}
    .zone:hover{background:#eef3ff}
    .small{color:#667; font-size:13px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:820px){.grid{grid-template-columns:1fr}}
    input[type="text"], select{
      width:100%;padding:10px 12px;border:1px solid #d7defc;border-radius:10px;outline:none
    }
    label{display:block;margin:0 0 6px;color:#2c3e50;font-weight:600;font-size:14px}
    .inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{border:0;border-radius:12px;padding:12px 16px;cursor:pointer;font-weight:700}
    .btn.primary{background:#27ae60;color:#fff}
    .btn.secondary{background:#6b8cff;color:#fff}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{display:flex;gap:12px;align-items:center;padding:10px 12px;border:1px solid #eef2ff;border-radius:12px}
    .item b{display:block}
    .item .meta{font-size:12px;color:#667}
    .grow{flex:1}
    .status{padding:10px 12px;border-radius:12px;background:#f7f9ff;border:1px solid #eef2ff;color:#2c3e50}
    .status.ok{background:#e8fff1;border-color:#b8f0cd}
    .status.err{background:#ffecec;border-color:#ffc2c2;color:#7a1a1a}
    .bar{height:8px;background:#eef2ff;border-radius:999px;overflow:hidden}
    .bar > div{height:100%;width:0;background:#6b8cff;transition:width .2s}
  </style>
</head>
<body>
  <div class="card">
    <header>
      <h1>üöÄ MediaProcessor</h1>
      <p>FFmpeg WASM: –≤–∏–¥–µ–æ/–∞—É–¥–∏–æ + —Ä–µ—Å–∞–π–∑ –∫–∞—Ä—Ç–∏–Ω–æ–∫ + ZIP</p>
    </header>

    <div class="row">
      <div id="ffStatus" class="status">FFmpeg: ‚è≥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
      <div class="small" style="margin-top:8px">
        –ï—Å–ª–∏ –≤–∏–¥–∏—à—å <code>file:///</code> –≤ –æ—à–∏–±–∫–∞—Ö ‚Äî —Ç—ã –æ—Ç–∫—Ä—ã–ª —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–∞–∫ —Ñ–∞–π–ª. –û—Ç–∫—Ä—ã–≤–∞–π —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Vercel (https).
      </div>
    </div>

    <div class="row">
      <div class="zone" id="dropZone">
        <b>–ü–µ—Ä–µ—Ç–∞—â–∏ —Ñ–∞–π–ª—ã —Å—é–¥–∞</b>
        <div class="small">–∏–ª–∏ –∫–ª–∏–∫–Ω–∏ —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å (–∫–∞—Ä—Ç–∏–Ω–∫–∏/–≤–∏–¥–µ–æ/–∞—É–¥–∏–æ)</div>
        <input id="fileInput" type="file" multiple hidden
          accept="image/*,.mp3,.wav,.ogg,.flac,.aac,.m4a,.mp4,.mov,.avi,.mkv,.webm,.wmv,.flv,.m4v,.3gp" />
      </div>
    </div>

    <div class="row">
      <div class="grid">
        <div>
          <label>üì∑ –†–∞–∑–º–µ—Ä—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
          <input id="imageSizes" type="text" value="1200x600, 800x400, 400x200">
          <div class="inline" style="margin-top:10px">
            <label class="inline" style="margin:0;font-weight:600">
              <input id="imgPNG" type="checkbox" checked> PNG
            </label>
            <label class="inline" style="margin:0;font-weight:600">
              <input id="imgJPG" type="checkbox"> JPG
            </label>
          </div>
        </div>

        <div>
          <label>üé¨ –í–∏–¥–µ–æ (—Ä–∞–∑–º–µ—Ä –∫–∞–¥—Ä–∞)</label>
          <select id="videoRes">
            <option value="640x360">640√ó360</option>
            <option value="854x480">854√ó480</option>
            <option value="1280x720" selected>1280√ó720 (HD)</option>
            <option value="1920x1080">1920√ó1080 (Full HD)</option>
          </select>

          <label style="margin-top:10px">–ö–∞—á–µ—Å—Ç–≤–æ (CRF)</label>
          <select id="videoCrf">
            <option value="18">–í—ã—Å–æ–∫–æ–µ (18)</option>
            <option value="23" selected>–°—Ç–∞–Ω–¥–∞—Ä—Ç (23)</option>
            <option value="28">–≠–∫–æ–Ω–æ–º (28)</option>
          </select>
        </div>

        <div>
          <label>üéµ –ê—É–¥–∏–æ</label>
          <div class="inline">
            <label class="inline" style="margin:0;font-weight:600">
              <input id="audMP3" type="checkbox" checked> MP3
            </label>
            <label class="inline" style="margin:0;font-weight:600">
              <input id="audOGG" type="checkbox"> OGG
            </label>
          </div>

          <label style="margin-top:10px">–ë–∏—Ç—Ä–µ–π—Ç</label>
          <select id="audBitrate">
            <option value="128">128 kbps</option>
            <option value="192" selected>192 kbps</option>
            <option value="256">256 kbps</option>
            <option value="320">320 kbps</option>
          </select>
        </div>

        <div>
          <label>üè∑Ô∏è –£–º–Ω–æ–µ –∏–º—è (base)</label>
          <input id="baseName" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: logo –∏–ª–∏ audio_hook">
          <div class="small" style="margin-top:6px">
            –í–∏–¥–µ–æ/–∫–∞—Ä—Ç–∏–Ω–∫–∏: base_1, base_2... ‚Ä¢ –ê—É–¥–∏–æ: –µ—Å–ª–∏ –≤ –∏—Å—Ö–æ–¥–Ω–æ–º –∏–º–µ–Ω–∏ –µ—Å—Ç—å —Ü–∏—Ñ—Ä—ã ‚Äî base+—Ü–∏—Ñ—Ä—ã (audio_hook333.mp3)
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div id="fileList" class="list"></div>
      <div class="small" id="stats"></div>
    </div>

    <div class="row">
      <div class="inline">
        <button id="processBtn" class="btn primary">üöÄ –ù–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É</button>
        <button id="zipBtn" class="btn secondary" disabled>üíæ –°–∫–∞—á–∞—Ç—å ZIP</button>
      </div>
      <div style="margin-top:12px" class="bar"><div id="prog"></div></div>
    </div>

    <div class="row">
      <div id="out" class="list"></div>
    </div>
  </div>

<script>
/* ---------------------------
   FFmpeg loader (LOCAL -> CDN)
---------------------------- */
function loadScript(src) {
  return new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = src;
    s.async = true;
    s.onload = () => resolve(src);
    s.onerror = () => reject(new Error('Failed to load: ' + src));
    document.head.appendChild(s);
  });
}

async function ensureFFmpegLibLoaded() {
  if (location.protocol === 'file:') {
    throw new Error('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –∫–∞–∫ file:///. FFmpeg WASM –Ω–µ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è. –û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ https (Vercel) –∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä.');
  }

  if (window.FFmpeg && typeof window.FFmpeg.createFFmpeg === 'function') return { ok: true, from: 'already' };

  const candidates = [
    // LOCAL (—Å–∞–º–æ—Ö–æ—Å—Ç–∏–Ω–≥)
    '/ffmpeg/ffmpeg.min.js',
    '/ffmpeg/ffmpeg.js',

    // CDN (–í–ê–ñ–ù–û: dist/umd)
    'https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.min.js',
    'https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.js',
  ];

  for (const url of candidates) {
    try {
      await loadScript(url);
      if (window.FFmpeg && typeof window.FFmpeg.createFFmpeg === 'function') return { ok: true, from: url };
    } catch (e) {
      console.warn('FFmpeg lib load failed:', url, e);
    }
  }
  return { ok: false, from: null };
}

class FFEngine {
  constructor() {
    this.ffmpeg = null;
    this.ready = false;
    this.coreFrom = null;
  }

  async init() {
    const st = document.getElementById('ffStatus');
    try {
      const lib = await ensureFFmpegLibLoaded();
      if (!lib.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å ffmpeg.js/ffmpeg.min.js (–Ω–∏ –ª–æ–∫–∞–ª—å–Ω–æ, –Ω–∏ —Å CDN).');

      const { createFFmpeg } = window.FFmpeg;

      const coreCandidates = [
        // LOCAL
        '/ffmpeg/ffmpeg-core.js',
        // CDN (umd)
        'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.10/dist/umd/ffmpeg-core.js',
      ];

      let lastErr = null;
      for (const corePath of coreCandidates) {
        try {
          this.ffmpeg = createFFmpeg({ log: true, corePath });
          await this.ffmpeg.load();
          this.ready = true;
          this.coreFrom = corePath;
          st.className = 'status ok';
          st.textContent = 'FFmpeg: ‚úÖ –≥–æ—Ç–æ–≤ (core: ' + (corePath.startsWith('http') ? 'CDN' : 'local') + ')';
          return;
        } catch (e) {
          lastErr = e;
          console.warn('Core load failed:', corePath, e);
          this.ffmpeg = null;
          this.ready = false;
        }
      }
      throw lastErr || new Error('FFmpeg core –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è.');
    } catch (e) {
      st.className = 'status err';
      st.textContent = 'FFmpeg: ‚ùå –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî –≤–∏–¥–µ–æ/–∞—É–¥–∏–æ –±—É–¥—É—Ç –±–µ–∑ –ø–µ—Ä–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è. ' + e.message;
    }
  }

  safeUnlink(p){ try{ this.ffmpeg && this.ffmpeg.FS('unlink', p); }catch(e){} }

  ext(name, fallback){
    const m = String(name||'').toLowerCase().match(/\.([a-z0-9]+)$/);
    return (m && m[1]) ? m[1] : fallback;
  }

  async transcodeVideo(file, resolution, crf) {
    if (!this.ready || !this.ffmpeg) return { blob: file, note: '–û—Ä–∏–≥–∏–Ω–∞–ª (FFmpeg –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)' };

    const [w,h] = resolution.split('x').map(n=>parseInt(n,10));
    const inputExt = this.ext(file.name,'mp4');
    const inName = `in.${inputExt}`;
    const outName = `out.mp4`;

    this.ffmpeg.FS('writeFile', inName, new Uint8Array(await file.arrayBuffer()));

    // –¢–æ—á–Ω—ã–π —Ä–µ—Å–∞–π–∑ (–±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–π) + —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Ñ–æ—Ä–º–∞—Ç
    const baseArgs = [
      '-i', inName,
      '-vf', `scale=${w}:${h},setsar=1`,
      '-pix_fmt','yuv420p',
      '-movflags','+faststart',
      '-y', outName
    ];

    // 1) –ø—Ä–æ–±—É–µ–º H.264
    try {
      await this.ffmpeg.run(
        ...baseArgs.slice(0,4),
        '-c:v','libx264','-crf', String(crf), '-preset','veryfast',
        '-c:a','aac','-b:a','128k',
        ...baseArgs.slice(4)
      );
    } catch (e) {
      // 2) fallback encoder (–µ—Å–ª–∏ libx264 –≤–¥—Ä—É–≥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
      console.warn('libx264 failed, fallback to mpeg4', e);
      await this.ffmpeg.run(
        ...baseArgs.slice(0,4),
        '-c:v','mpeg4','-q:v','5',
        '-c:a','aac','-b:a','128k',
        ...baseArgs.slice(4)
      );
    }

    const out = this.ffmpeg.FS('readFile', outName);
    this.safeUnlink(inName); this.safeUnlink(outName);

    return { blob: new Blob([out], { type:'video/mp4' }), note: `–†–µ—Å–∞–π–∑: ${w}x${h}` };
  }

  async transcodeAudio(file, format, bitrate) {
    if (!this.ready || !this.ffmpeg) return { blob: file, note: '–û—Ä–∏–≥–∏–Ω–∞–ª (FFmpeg –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)' };

    const inputExt = this.ext(file.name,'mp3');
    const inName = `ain.${inputExt}`;
    const outName = `aout.${format}`;
    const bps = `${Math.max(32, Math.min(320, Number(bitrate)||192))}k`;

    this.ffmpeg.FS('writeFile', inName, new Uint8Array(await file.arrayBuffer()));

    const runWithFallback = async (primary, fallback) => {
      try { await this.ffmpeg.run(...primary); }
      catch (e) { console.warn('audio primary failed, fallback', e); await this.ffmpeg.run(...fallback); }
    };

    if (format === 'ogg') {
      await runWithFallback(
        ['-i',inName,'-vn','-c:a','libvorbis','-b:a',bps,'-ar','44100','-ac','2','-y',outName],
        ['-i',inName,'-vn','-c:a','vorbis','-b:a',bps,'-ar','44100','-ac','2','-y',outName]
      );
    } else {
      await runWithFallback(
        ['-i',inName,'-vn','-c:a','libmp3lame','-b:a',bps,'-ar','44100','-ac','2','-y',outName],
        ['-i',inName,'-vn','-c:a','mp3','-b:a',bps,'-ar','44100','-ac','2','-y',outName]
      );
    }

    const out = this.ffmpeg.FS('readFile', outName);
    this.safeUnlink(inName); this.safeUnlink(outName);

    const mime = (format==='ogg') ? 'audio/ogg' : 'audio/mpeg';
    return { blob: new Blob([out], { type:mime }), note: `${format.toUpperCase()} ${bps}` };
  }
}

/* ---------------------------
   App
---------------------------- */
const files = [];
const processed = [];
const engine = new FFEngine();

function fsize(bytes){
  const u=['B','KB','MB','GB']; let i=0; let v=bytes;
  while(v>=1024 && i<u.length-1){ v/=1024; i++; }
  return v.toFixed(v>=10||i===0?0:1)+' '+u[i];
}

function fileType(f){
  const e = (f.name.split('.').pop()||'').toLowerCase();
  if (['png','jpg','jpeg','webp','bmp','gif'].includes(e)) return 'img';
  if (['mp3','wav','ogg','flac','aac','m4a'].includes(e)) return 'aud';
  if (['mp4','mov','avi','mkv','webm','wmv','flv','m4v','3gp'].includes(e)) return 'vid';
  return 'other';
}

function extractNum(name){
  const m = String(name||'').match(/(\d+)/);
  return m ? m[1] : '';
}

function smartName(base, originalName, idx, ext, type){
  const b = (base||'').trim();
  if (!b) return `file_${idx}.${ext}`;
  if (type==='aud') {
    const n = extractNum(originalName);
    if (n) return `${b}${n}.${ext}`;
    return idx===1 ? `${b}.${ext}` : `${b}_${idx}.${ext}`;
  }
  return idx===1 ? `${b}.${ext}` : `${b}_${idx}.${ext}`;
}

function renderList(){
  const list = document.getElementById('fileList');
  const st = document.getElementById('stats');
  list.innerHTML = '';
  let total = 0;

  files.forEach((f,i)=>{
    total += f.size;
    const t = fileType(f);
    const row = document.createElement('div');
    row.className = 'item';
    row.innerHTML = `
      <div class="grow">
        <b>${f.name}</b>
        <div class="meta">${t.toUpperCase()} ‚Ä¢ ${fsize(f.size)}</div>
      </div>
      <button class="btn" style="background:#ffecec;border:1px solid #ffc2c2" data-i="${i}">–£–¥–∞–ª–∏—Ç—å</button>
    `;
    row.querySelector('button').onclick = () => { files.splice(i,1); renderList(); };
    list.appendChild(row);
  });

  st.textContent = files.length ? `–§–∞–π–ª–æ–≤: ${files.length} ‚Ä¢ ${fsize(total)}` : '–§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã';
}

async function resizeImage(file, w, h, format){
  const img = await new Promise((res,rej)=>{
    const r = new FileReader();
    r.onload = ()=>{ const im=new Image(); im.onload=()=>res(im); im.onerror=rej; im.src=r.result; };
    r.onerror = rej;
    r.readAsDataURL(file);
  });

  const c = document.createElement('canvas');
  c.width = w; c.height = h;
  const ctx = c.getContext('2d');

  // –±–µ–ª—ã–π —Ñ–æ–Ω –¥–ª—è JPG, –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –¥–ª—è PNG
  if (format==='png') ctx.clearRect(0,0,w,h);
  else { ctx.fillStyle='#fff'; ctx.fillRect(0,0,w,h); }

  // –≤–ø–∏—Å—ã–≤–∞–µ–º —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–π
  const s = Math.min(w/img.width, h/img.height);
  const sw = img.width*s, sh = img.height*s;
  ctx.drawImage(img, (w-sw)/2, (h-sh)/2, sw, sh);

  const mime = format==='png'?'image/png':'image/jpeg';
  const quality = format==='png'?0.92:0.88;

  const blob = await new Promise((res)=>c.toBlob(res, mime, quality));
  return blob || file;
}

function downloadBlob(blob, name){
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = name;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

function renderOut(){
  const out = document.getElementById('out');
  out.innerHTML = '';
  processed.forEach((p)=>{
    const row = document.createElement('div');
    row.className = 'item';
    row.innerHTML = `
      <div class="grow">
        <b>${p.name}</b>
        <div class="meta">${p.note || ''} ‚Ä¢ ${fsize(p.size)}</div>
      </div>
      <button class="btn secondary">–°–∫–∞—á–∞—Ç—å</button>
    `;
    row.querySelector('button').onclick = ()=>downloadBlob(p.blob, p.name);
    out.appendChild(row);
  });
}

async function processAll(){
  if (!files.length) return;

  const btn = document.getElementById('processBtn');
  const zipBtn = document.getElementById('zipBtn');
  const prog = document.getElementById('prog');

  processed.length = 0;
  renderOut();
  zipBtn.disabled = true;

  btn.disabled = true;
  btn.textContent = '‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...';
  prog.style.width = '0%';

  const base = document.getElementById('baseName').value;
  const imageSizes = (document.getElementById('imageSizes').value||'')
    .split(',').map(s=>s.trim()).filter(Boolean);

  const imgFormats = [];
  if (document.getElementById('imgPNG').checked) imgFormats.push('png');
  if (document.getElementById('imgJPG').checked) imgFormats.push('jpg');

  const res = document.getElementById('videoRes').value;
  const crf = parseInt(document.getElementById('videoCrf').value,10);

  const audFormats = [];
  if (document.getElementById('audMP3').checked) audFormats.push('mp3');
  if (document.getElementById('audOGG').checked) audFormats.push('ogg');
  const abr = parseInt(document.getElementById('audBitrate').value,10);

  let done = 0;
  const total = files.length;

  // –ø–æ—Ä—è–¥–∫–æ–≤—ã–µ –∏–Ω–¥–µ–∫—Å—ã –ø–æ —Ç–∏–ø–∞–º
  let imgI=0, audI=0, vidI=0, othI=0;

  for (const f of files){
    const t = fileType(f);
    const ext0 = (f.name.split('.').pop()||'dat').toLowerCase();

    if (t==='img'){
      imgI++;
      if (!imageSizes.length || !imgFormats.length){
        const name = smartName(base||'image', f.name, imgI, ext0, 'img');
        processed.push({ blob:f, name, size:f.size, note:'–û—Ä–∏–≥–∏–Ω–∞–ª (—Ñ–æ—Ä–º–∞—Ç—ã/—Ä–∞–∑–º–µ—Ä—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã)' });
      } else {
        for (const sz of imageSizes){
          const [w,h] = sz.split('x').map(n=>parseInt(n,10));
          for (const fmt of imgFormats){
            const b = await resizeImage(f, w, h, fmt);
            const name = smartName(base||'image', f.name, imgI, fmt, 'img');
            processed.push({ blob:b, name, size:b.size||f.size, note:`IMG ${w}x${h} ${fmt.toUpperCase()}` });
          }
        }
      }
    }

    else if (t==='aud'){
      audI++;
      if (!audFormats.length){
        const name = smartName(base||'audio', f.name, audI, ext0, 'aud');
        processed.push({ blob:f, name, size:f.size, note:'–û—Ä–∏–≥–∏–Ω–∞–ª (—Ñ–æ—Ä–º–∞—Ç –∞—É–¥–∏–æ –Ω–µ –≤—ã–±—Ä–∞–Ω)' });
      } else {
        for (const fmt of audFormats){
          const r = await engine.transcodeAudio(f, fmt, abr);
          const name = smartName(base||'audio', f.name, audI, fmt, 'aud');
          processed.push({ blob:r.blob, name, size:r.blob.size||f.size, note:r.note });
        }
      }
    }

    else if (t==='vid'){
      vidI++;
      const r = await engine.transcodeVideo(f, res, crf);
      const name = smartName(base||'video', f.name, vidI, 'mp4', 'vid');
      processed.push({ blob:r.blob, name, size:r.blob.size||f.size, note:r.note });
    }

    else {
      othI++;
      const name = smartName(base||'file', f.name, othI, ext0, 'other');
      processed.push({ blob:f, name, size:f.size, note:'–û—Ä–∏–≥–∏–Ω–∞–ª' });
    }

    done++;
    prog.style.width = Math.round(done/total*100) + '%';
    renderOut();
  }

  btn.disabled = false;
  btn.textContent = 'üöÄ –ù–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É';
  zipBtn.disabled = !processed.length;
}

async function downloadZip(){
  const zip = new JSZip();
  const folder = zip.folder('processed_files');
  processed.forEach(p=>folder.file(p.name, p.blob));
  folder.file('README.txt', `Files: ${processed.length}\nCreated: ${new Date().toISOString()}\n`);
  const blob = await zip.generateAsync({ type:'blob' });
  downloadBlob(blob, 'processed_files.zip');
}

document.getElementById('dropZone').onclick = ()=>document.getElementById('fileInput').click();
document.getElementById('dropZone').ondragover = (e)=>{ e.preventDefault(); };
document.getElementById('dropZone').ondrop = (e)=>{
  e.preventDefault();
  const arr = Array.from(e.dataTransfer.files||[]);
  files.push(...arr);
  renderList();
};

document.getElementById('fileInput').onchange = (e)=>{
  const arr = Array.from(e.target.files||[]);
  files.push(...arr);
  e.target.value = '';
  renderList();
};

document.getElementById('processBtn').onclick = processAll;
document.getElementById('zipBtn').onclick = downloadZip;

// init
renderList();
engine.init();
</script>
</body>
</html>
