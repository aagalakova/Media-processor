<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MediaProcessor | Relation-AI</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <!-- FFmpeg —á–µ—Ä–µ–∑ jsDelivr -->
  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.4/dist/ffmpeg.min.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 40px 20px; }
    .container { max-width: 1000px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
    .header { background: linear-gradient(135deg, #2c3e50, #34495e); color: white; padding: 30px; text-align: center; }
    .header h1 { font-size: 2.5em; margin-bottom: 10px; }
    .header p { opacity: 0.9; font-size: 1.1em; }

    .upload-zone { border: 3px dashed #3498db; border-radius: 15px; padding: 60px 40px; text-align: center; margin: 30px; background: #f8f9fa; transition: all 0.3s ease; cursor: pointer; }
    .upload-zone:hover { border-color: #2980b9; background: #e3f2fd; }
    .upload-zone.dragover { border-color: #27ae60; background: #d4edda; }
    .upload-icon { font-size: 4em; margin-bottom: 20px; color: #3498db; }
    .file-input {display: none;}
    .upload-btn { background: #3498db; color: white; padding: 12px 30px; border: none; border-radius: 25px; cursor: pointer; font-size: 1.1em; transition: background 0.3s ease; margin: 5px; }
    .upload-btn:hover { background: #2980b9; }

    .file-list { margin: 20px 30px; max-height: 400px; overflow-y: auto; }
    .file-list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .file-list-header h3 {color: #2c3e50;}
    .clear-all-btn { background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 0.9em; transition: background 0.3s ease; }
    .clear-all-btn:hover {background: #c0392b;}

    .file-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #3498db; }
    .file-info { display: flex; align-items: center; gap: 10px; flex: 1; }
    .file-icon {font-size: 1.5em;}
    .file-size {color: #7f8c8d;font-size: 0.9em;}
    .file-rename { display: flex; align-items: center; gap: 10px; margin-left: 15px; }
    .rename-input { padding: 8px 12px; border: 2px solid #bdc3c7; border-radius: 8px; font-size: 0.9em; width: 200px; transition: border-color 0.3s ease; }
    .rename-input:focus { border-color: #3498db; outline: none; }

    .settings { background: #f8f9fa; padding: 30px; margin: 20px 30px; border-radius: 15px; }
    .settings-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e3f2fd; }
    .settings-header h2 { color: #2c3e50; display: flex; align-items: center; gap: 10px; }
    .settings-controls { display: flex; gap: 10px; }
    .settings-btn { background: #95a5a6; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 0.9em; transition: background 0.3s ease; }
    .settings-btn:hover {background: #7f8c8d;}
    .settings-btn.reset {background: #e67e22;}
    .settings-btn.reset:hover {background: #d35400;}
    .settings-btn.clear {background: #e74c3c;}
    .settings-btn.clear:hover {background: #c0392b;}

    .settings-section { margin-bottom: 25px; background: white; padding: 20px; border-radius: 10px; border: 2px solid #e3f2fd; }
    .settings-section h3 { color: #2c3e50; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
    .size-input { width: 100%; padding: 12px; border: 2px solid #bdc3c7; border-radius: 8px; font-size: 1em; margin-bottom: 15px; }

    .naming-section { background: white; padding: 20px; border-radius: 10px; border: 2px solid #e3f2fd; margin: 20px 0; }
    .naming-example { color: #7f8c8d; font-size: 0.9em; margin-top: 5px; }

    .format-options { display: flex; gap: 20px; flex-wrap: wrap; margin-top: 15px; }
    .format-option { display: flex; align-items: center; gap: 8px; }
    .format-option input[type="checkbox"] { width: 18px; height: 18px; }

    .video-quality-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px; }
    .video-quality-option { display: flex; align-items: center; gap: 8px; padding: 12px; border: 2px solid #bdc3c7; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
    .video-quality-option:hover { border-color: #3498db; background: #e3f2fd; }
    .video-quality-option.selected { border-color: #27ae60; background: #d4edda; }
    .quality-info { font-size: 0.8em; color: #666; margin-left: auto; }

    .preset-buttons { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
    .preset-btn { background: #95a5a6; color: white; border: none; padding: 8px 16px; border-radius: 15px; cursor: pointer; font-size: 0.9em; transition: background 0.3s ease; }
    .preset-btn:hover {background: #7f8c8d;}

    .ai-section { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 10px; margin: 20px 0; position: relative; }
    .ai-feature { display: flex; align-items: center; gap: 10px; margin: 10px 0; }

    .ai-advisor-section { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin: 20px 0; }
    .ai-advisor-card { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 10px; padding: 20px; border: 1px solid rgba(255, 255, 255, 0.2); }
    .ai-tip { background: rgba(255, 255, 255, 0.15); border-radius: 8px; padding: 15px; margin-bottom: 15px; border-left: 4px solid #27ae60; }
    .ai-tip-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    .ai-tip-content { font-size: 0.95em; opacity: 0.9; }
    .ai-actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .ai-btn { background: rgba(255, 255, 255, 0.2); color: white; border: 1px solid rgba(255, 255, 255, 0.3); padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 0.9em; transition: all 0.3s ease; flex: 1; min-width: 120px; }
    .ai-btn:hover { background: rgba(255, 255, 255, 0.3); transform: translateY(-1px); }
    .ai-btn.secondary { background: rgba(39, 174, 96, 0.3); border-color: rgba(39, 174, 96, 0.5); }

    .ai-results { margin-top: 20px; animation: fadeIn 0.5s ease; }
    .ai-stats { background: rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 15px; margin-bottom: 15px; font-size: 0.9em; }
    .ai-tips-list { display: flex; flex-direction: column; gap: 10px; }
    .ai-tip-item { background: rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 12px 15px; border-left: 3px solid #3498db; animation: slideIn 0.3s ease; }
    .ai-tip-item:nth-child(2n) {border-left-color: #9b59b6;}
    .ai-tip-item:nth-child(3n) {border-left-color: #e74c3c;}

    .color-palette { display: flex; gap: 5px; margin: 10px 0; }
    .color-swatch { width: 30px; height: 30px; border-radius: 6px; border: 2px solid rgba(255, 255, 255, 0.3); position: relative; cursor: pointer; transition: transform 0.2s ease; }
    .color-swatch:hover {transform: scale(1.1);}
    .color-swatch::after { content: attr(data-hex); position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.8); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7em; white-space: nowrap; opacity: 0; transition: opacity 0.3s ease; }
    .color-swatch:hover::after {opacity: 1;}

    .image-analysis-result { background: rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 15px; margin: 10px 0; }
    .analysis-technical { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin: 10px 0; }
    .tech-item { text-align: center; background: rgba(255, 255, 255, 0.05); padding: 8px; border-radius: 6px; }
    .tech-value { font-weight: bold; font-size: 1.1em; color: #27ae60; }

    .brand-analysis-results { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 10px; padding: 15px; margin-top: 15px; border: 1px solid rgba(255, 255, 255, 0.2); animation: fadeIn 0.5s ease; }
    .brand-analysis-results .color-palette { display: flex; gap: 5px; margin: 8px 0; }
    .brand-analysis-results .color-swatch { width: 25px; height: 25px; border-radius: 4px; border: 2px solid rgba(255, 255, 255, 0.5); position: relative; cursor: pointer; transition: transform 0.2s ease; }
    .brand-analysis-results .color-swatch:hover { transform: scale(1.1); }
    .brand-analysis-results .color-swatch::after { content: attr(data-hex); position: absolute; bottom: -30px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.8); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7em; white-space: nowrap; opacity: 0; transition: opacity 0.3s ease; z-index: 10; }
    .brand-analysis-results .color-swatch:hover::after {opacity: 1;}

    .process-btn { background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; border: none; padding: 15px 40px; font-size: 1.2em; border-radius: 25px; cursor: pointer; display: block; margin: 30px auto; transition: transform 0.2s ease; }
    .process-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(39, 174, 96, 0.3); }
    .process-btn:active {transform: translateY(0);}
    .process-btn:disabled { background: #bdc3c7; cursor: not-allowed; transform: none; }

    .result { margin: 20px 30px; padding: 25px; background: #e8f5e8; border-radius: 15px; border-left: 4px solid #27ae60; }
    .result-files {margin-top: 15px;}
    .result-file { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #27ae60; }
    .file-size-compression { font-size: 0.8em; color: #27ae60; margin-left: 10px; }
    .download-btn { background: #3498db; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 0.8em; }
    .download-btn:hover {background: #2980b9;}
    .hidden {display: none;}

    .progress-bar { width: 100%; height: 6px; background: #ecf0f1; border-radius: 3px; margin: 20px 0; overflow: hidden; }
    .progress { height: 100%; background: linear-gradient(135deg, #3498db, #2980b9); width: 0%; transition: width 0.3s ease; }

    .download-section { text-align: center; padding: 20px; background: #f0f8ff; margin: 20px 30px; border-radius: 15px; border: 2px dashed #9b59b6; }
    .download-all-btn { background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; border: none; padding: 15px 40px; font-size: 1.2em; border-radius: 25px; cursor: pointer; transition: transform 0.2s ease; }
    .download-all-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(155, 89, 182, 0.3); }

    .stats { text-align: center; margin: 10px 0; color: #7f8c8d; font-size: 0.9em; }

    .resolution-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 10px; }
    .resolution-option { display: flex; align-items: center; gap: 8px; padding: 10px; border: 2px solid #bdc3c7; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
    .resolution-option:hover { border-color: #3498db; background: #e3f2fd; }
    .resolution-option.selected { border-color: #27ae60; background: #d4edda; }

    .checkbox-controls { display: flex; gap: 10px; margin: 10px 0; flex-wrap: wrap; }
    .checkbox-btn { background: #3498db; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 0.8em; transition: background 0.3s ease; }
    .checkbox-btn:hover {background: #2980b9;}
    .checkbox-btn.select-all {background: #27ae60;}
    .checkbox-btn.select-all:hover {background: #219a52;}
    .checkbox-btn.clear-all {background: #e74c3c;}
    .checkbox-btn.clear-all:hover {background: #c0392b;}

    .naming-options { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0; }
    .naming-option { display: flex; align-items: center; gap: 8px; margin: 8px 0; }

    .empty-state { text-align: center; padding: 40px; color: #7f8c8d; }
    .empty-state .upload-icon { font-size: 3em; margin-bottom: 10px; }

    .cancel-btn { background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin-left: 10px; }
    .cancel-btn:hover {background: #c0392b;}

    .temp-message { border-radius: 8px; padding: 15px; margin: 15px 30px; }
    .error-message { background: #f8d7da; border: 2px solid #e74c3c; color: #721c24; }

    .background-color-section { background: white; padding: 20px; border-radius: 10px; border: 2px solid #e3f2fd; margin: 20px 0; }
    .background-color-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-top: 15px; }
    .background-color-option { display: flex; align-items: center; gap: 12px; padding: 15px; border: 2px solid #bdc3c7; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; }
    .background-color-option:hover { border-color: #3498db; background: #f0f8ff; transform: translateY(-2px); }
    .background-color-option.selected { border-color: #27ae60; background: #e8f5e8; box-shadow: 0 4px 12px rgba(39, 174, 96, 0.2); }
    .background-color-preview { width: 40px; height: 40px; border-radius: 8px; border: 2px solid #ddd; display: flex; align-items: center; justify-content: center; font-size: 1.2em; }
    .background-color-info { display: flex; flex-direction: column; gap: 3px; }
    .background-color-name { font-weight: 600; color: #2c3e50; }
    .background-color-description { font-size: 0.85em; color: #7f8c8d; }
    .custom-color-picker { display: flex; align-items: center; gap: 10px; margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px; border: 1px dashed #bdc3c7; }
    .color-input { width: 60px; height: 40px; border: 2px solid #bdc3c7; border-radius: 6px; cursor: pointer; padding: 2px; }
    .color-input::-webkit-color-swatch-wrapper {padding: 0;}
    .color-input::-webkit-color-swatch { border: none; border-radius: 4px; }
    .color-hex-input { flex: 1; padding: 8px 12px; border: 2px solid #bdc3c7; border-radius: 6px; font-size: 0.9em; font-family: monospace; }

    .transparent-grid {
      background-image:
        linear-gradient(45deg, #ccc 25%, transparent 25%),
        linear-gradient(-45deg, #ccc 25%, transparent 25%),
        linear-gradient(45deg, transparent 75%, #ccc 75%),
        linear-gradient(-45deg, transparent 75%, #ccc 75%);
      background-size: 20px 20px;
      background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
    }

    .video-processing-info { background: #e3f2fd; border-radius: 8px; padding: 15px; margin: 15px 0; border-left: 4px solid #3498db; }
    .video-processing-info h4 { margin-bottom: 10px; color: #2c3e50; }
    .video-format-options { display: flex; gap: 15px; margin: 10px 0; }
    .video-format-option { display: flex; align-items: center; gap: 8px; padding: 10px 15px; border: 2px solid #bdc3c7; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
    .video-format-option:hover { border-color: #3498db; background: #e3f2fd; }
    .video-format-option.selected { border-color: #27ae60; background: #d4edda; }

    .video-processing-status { background: #e3f2fd; border-radius: 8px; padding: 10px; margin: 10px 0; border-left: 4px solid #3498db; font-size: 0.9em; }
    .video-processing-status.success { background: #d4edda; border-left-color: #27ae60; }
    .video-processing-status.error { background: #f8d7da; border-left-color: #e74c3c; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }

    @media (max-width: 768px) {
      .ai-actions {flex-direction: column;}
      .ai-btn {flex: none;}
      .analysis-technical {grid-template-columns: 1fr 1fr;}
      .file-item { flex-direction: column; align-items: flex-start; gap: 10px; }
      .file-rename { margin-left: 0; width: 100%; }
      .rename-input {width: 100%;}
      .background-color-options {grid-template-columns: 1fr;}
      .video-format-options {flex-wrap: wrap;}
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>üöÄ MediaProcessor</h1>
    <p>–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤ | Relation-AI Module</p>
  </div>

  <div class="upload-zone" id="dropZone">
    <div class="upload-icon">üìÅ</div>
    <h3>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞</h3>
    <p>–∏–ª–∏</p>
    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
      –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã
    </button>
    <input type="file" id="fileInput" class="file-input" multiple
           accept="image/*,.mp3,.mp4,.mov,.avi,.ogg,.wav,.flac,.aac,.mkv,.webm,.wmv,.flv">
  </div>

  <div class="file-list" id="fileList">
    <div class="empty-state" id="emptyState">
      <div class="upload-icon">üìÑ</div>
      <h3>–ù–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤</h3>
      <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É</p>
    </div>
  </div>

  <div class="settings">
    <div class="settings-header">
      <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏</h2>
      <div class="settings-controls">
        <button class="settings-btn reset" onclick="appState.resetAllSettings()">üîÑ –°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë</button>
        <button class="settings-btn clear" onclick="appState.clearAllCheckboxes()">‚ùå –£–±—Ä–∞—Ç—å –≥–∞–ª–æ—á–∫–∏</button>
      </div>
    </div>

    <div class="naming-section">
      <h3>üè∑Ô∏è –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤</h3>
      <p style="color: #666; margin-bottom: 10px;">
        –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞ –≤ —Å–ø–∏—Å–∫–µ –≤—ã—à–µ –∏–ª–∏ —É–∫–∞–∂–∏—Ç–µ –æ–±—â–µ–µ –∏–º—è –¥–ª—è —É–º–Ω–æ–≥–æ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è
      </p>

      <div class="naming-options">
        <div class="naming-option">
          <input type="checkbox" id="useOriginalNames">
          <label for="useOriginalNames">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤</label>
        </div>
        <div class="naming-option">
          <input type="checkbox" id="smartRenaming">
          <label for="smartRenaming">–£–º–Ω–æ–µ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ (–µ–¥–∏–Ω–∞—è –±–∞–∑–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä: logo, banner, audio_hook)</label>
        </div>
        <div class="naming-option" style="flex-direction: column; align-items: flex-start;">
          <label for="globalBaseName">–û–±—â–µ–µ –∏–º—è –¥–ª—è –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ (–ø—Ä–∏ —É–º–Ω–æ–º –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–∏):</label>
          <input type="text" id="globalBaseName" class="rename-input"
                 placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: logo, banner, audio_hook">
        </div>
      </div>

      <div class="naming-example">
        –ü—Ä–∏–º–µ—Ä –∏–º–µ–Ω –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏:
        <strong id="namingExample">banner.png, banner_2.png, banner_3.png</strong>
      </div>
    </div>

    <!-- AI-—Å–æ–≤–µ—Ç–Ω–∏–∫ -->
    <div class="ai-advisor-section">
      <h3>üß† AI-–°–æ–≤–µ—Ç–Ω–∏–∫</h3>
      <div class="ai-advisor-card">
        <div class="ai-tip" id="aiTip">
          <div class="ai-tip-header">
            <span class="ai-icon">üí°</span>
            <strong id="aiTipTitle">–°–æ–≤–µ—Ç–Ω–∏–∫ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</strong>
          </div>
          <div class="ai-tip-content" id="aiTipContent">
            –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
          </div>
        </div>

        <div class="ai-actions">
          <button class="ai-btn" onclick="appState.getAIAdvice()" id="aiAdviceBtn">ü§ñ –ü–æ–ª—É—á–∏—Ç—å —Å–æ–≤–µ—Ç—ã</button>
          <button class="ai-btn secondary" onclick="appState.analyzeAllImages()" id="analyzeImagesBtn">üé® –ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</button>
        </div>

        <div class="ai-results hidden" id="aiResults">
          <div class="ai-stats" id="aiStats"></div>
          <div class="ai-tips-list" id="aiTipsList"></div>
        </div>
      </div>
    </div>

    <!-- AI-–∞–Ω–∞–ª–∏–∑ –±—Ä–µ–Ω–¥–∞ -->
    <div class="ai-section">
      <h3>üß† AI-–ê–Ω–∞–ª–∏–∑ –±—Ä–µ–Ω–¥–∞</h3>
      <div class="checkbox-controls">
        <button class="checkbox-btn select-all" onclick="appState.selectAllCheckboxes('ai')">‚úÖ –í—ã–±—Ä–∞—Ç—å –≤—Å–µ AI</button>
        <button class="checkbox-btn clear-all" onclick="appState.clearCheckboxes('ai')">‚ùå –£–±—Ä–∞—Ç—å –≤—Å–µ AI</button>
      </div>
      <div class="ai-feature">
        <input type="checkbox" id="aiAnalysis">
        <label for="aiAnalysis">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ü–≤–µ—Ç–∞ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</label>
      </div>
      <button class="upload-btn" onclick="appState.analyzeBrandAssets()" style="background:#9b59b6;">üîç –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –±—Ä–µ–Ω–¥</button>

      <div class="brand-analysis-results hidden" id="brandAnalysisResults"></div>
    </div>

    <!-- –¶–≤–µ—Ç –ø–æ–¥–ª–æ–∂–∫–∏ -->
    <div class="background-color-section">
      <h3>üé® –¶–≤–µ—Ç –ø–æ–¥–ª–æ–∂–∫–∏ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</h3>
      <p style="color: #666; margin-bottom: 15px;">
        –í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç —Ñ–æ–Ω–∞ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–∞–∫—Ç—É–∞–ª—å–Ω–æ –¥–ª—è JPG –∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–æ–≤)
      </p>

      <div class="background-color-options">
        <div class="background-color-option selected" data-background="white">
          <div class="background-color-preview" style="background: white; border: 2px solid #ddd;">
            <span style="color: #666;">‚¨ú</span>
          </div>
          <div class="background-color-info">
            <div class="background-color-name">–ë–µ–ª—ã–π</div>
            <div class="background-color-description">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –±–µ–ª—ã–π —Ñ–æ–Ω</div>
          </div>
        </div>

        <div class="background-color-option" data-background="lightgray">
          <div class="background-color-preview" style="background: #f0f0f0;">
            <span style="color: #666;">‚¨ú</span>
          </div>
          <div class="background-color-info">
            <div class="background-color-name">–°–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π</div>
            <div class="background-color-description">–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π —Å–µ—Ä—ã–π —Ñ–æ–Ω</div>
          </div>
        </div>

        <div class="background-color-option" data-background="transparent">
          <div class="background-color-preview transparent-grid" style="background: rgba(0,0,0,0);">
            <span>‚óªÔ∏è</span>
          </div>
          <div class="background-color-info">
            <div class="background-color-name">–ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π</div>
            <div class="background-color-description">–î–ª—è PNG —Å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é</div>
          </div>
        </div>

        <div class="background-color-option" data-background="black">
          <div class="background-color-preview" style="background: #000000;">
            <span style="color: white;">‚¨õ</span>
          </div>
          <div class="background-color-info">
            <div class="background-color-name">–ß–µ—Ä–Ω—ã–π</div>
            <div class="background-color-description">–¢–µ–º–Ω—ã–π —Ñ–æ–Ω –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞</div>
          </div>
        </div>

        <!-- –î–û–ë–ê–í–ò–õ: –∫–∞—Å—Ç–æ–º–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç, —á—Ç–æ–±—ã applyCustomColor —Ä–µ–∞–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–ª -->
        <div class="background-color-option" data-background="custom" id="customBgOption">
          <div class="background-color-preview" id="customBgPreview" style="background: #ffffff;">
            <span style="color:#666;">üéØ</span>
          </div>
          <div class="background-color-info">
            <div class="background-color-name">–°–≤–æ–π —Ü–≤–µ—Ç</div>
            <div class="background-color-description">–ë–µ—Ä—ë—Ç—Å—è –∏–∑ –ø–æ–ª—è –Ω–∏–∂–µ</div>
          </div>
        </div>
      </div>

      <div class="custom-color-picker">
        <label style="font-weight: 600; color: #2c3e50;">–°–≤–æ–π —Ü–≤–µ—Ç:</label>
        <input type="color" class="color-input" id="customColorPicker" value="#ffffff">
        <input type="text" class="color-hex-input" id="customColorHex" value="#ffffff" placeholder="#RRGGBB">
        <button class="upload-btn" onclick="appState.applyCustomColor()"
                style="padding: 8px 15px; font-size: 0.9em; background: #9b59b6;">
          –ü—Ä–∏–º–µ–Ω–∏—Ç—å
        </button>
      </div>

      <p style="margin-top: 10px; font-size: 0.9em; color: #7f8c8d;">
        <strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong> –î–ª—è PNG-—Ñ–∞–π–ª–æ–≤ —Å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤—ã–±–∏—Ä–∞—Ç—å "–ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π" —Ñ–æ–Ω.
      </p>
    </div>

    <div class="settings-section">
      <h3>üì∑ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</h3>
      <input type="text" class="size-input" id="imageSizes"
             value="1200x600, 800x400, 400x200"
             placeholder="–í–≤–µ–¥–∏—Ç–µ —Ä–∞–∑–º–µ—Ä—ã —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é">

      <div class="preset-buttons">
        <button class="preset-btn" onclick="appState.loadPreset('creatives')">–ö—Ä–µ–∞—Ç–∏–≤—ã</button>
        <button class="preset-btn" onclick="appState.loadPreset('vertical')">–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ</button>
        <button class="preset-btn" onclick="appState.loadPreset('logos')">–õ–æ–≥–æ—Ç–∏–ø—ã</button>
        <button class="preset-btn" onclick="appState.loadPreset('icons')">–ò–∫–æ–Ω–∫–∏</button>
      </div>

      <div class="checkbox-controls">
        <button class="checkbox-btn select-all" onclick="appState.selectAllCheckboxes('image')">‚úÖ –í—ã–±—Ä–∞—Ç—å –≤—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã</button>
        <button class="checkbox-btn clear-all" onclick="appState.clearCheckboxes('image')">‚ùå –£–±—Ä–∞—Ç—å –≤—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã</button>
      </div>
      <div class="format-options">
        <label class="format-option"><input type="checkbox" id="formatPNG"> PNG</label>
        <label class="format-option"><input type="checkbox" id="formatJPG"> JPG</label>
      </div>
    </div>

    <div class="settings-section">
      <h3>üéµ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞—É–¥–∏–æ</h3>
      <div class="checkbox-controls">
        <button class="checkbox-btn select-all" onclick="appState.selectAllCheckboxes('audio')">‚úÖ –í—ã–±—Ä–∞—Ç—å –≤—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã</button>
        <button class="checkbox-btn clear-all" onclick="appState.clearCheckboxes('audio')">‚ùå –£–±—Ä–∞—Ç—å –≤—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã</button>
      </div>
      <div class="format-options">
        <label class="format-option"><input type="checkbox" id="audioMP3"> MP3</label>
        <label class="format-option"><input type="checkbox" id="audioOGG"> OGG</label>
      </div>
      <select class="size-input" id="audioBitrate" style="margin-top: 10px;">
        <option value="128">128 kbps (—Å—Ç–∞–Ω–¥–∞—Ä—Ç)</option>
        <option value="192">192 kbps (–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ)</option>
        <option value="256">256 kbps (–ø—Ä–µ–º–∏—É–º)</option>
        <option value="320">320 kbps (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ)</option>
      </select>
    </div>

    <div class="settings-section">
      <h3>üé¨ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–¥–µ–æ</h3>

      <div class="video-processing-info">
        <h4>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∏–¥–µ–æ</h4>
        <p>–í–∏–¥–µ–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —Å –ø–æ–º–æ—â—å—é FFmpeg –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –î–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –æ–≥—Ä–∞–Ω–∏—á—å—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã—Ö –≤–∏–¥–µ–æ.</p>
        <p><strong>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</strong> –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –Ω–µ –±–æ–ª–µ–µ 1-2 –≤–∏–¥–µ–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.</p>
      </div>

      <h4 style="margin: 10px 0 5px 0;">üìê –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ:</h4>
      <div class="resolution-options">
        <div class="resolution-option selected" data-resolution="640x360"><span>640√ó360px</span></div>
        <div class="resolution-option" data-resolution="854x480"><span>854√ó480px</span></div>
        <div class="resolution-option" data-resolution="1280x720"><span>1280√ó720px (HD)</span></div>
        <div class="resolution-option" data-resolution="1920x1080"><span>1920√ó1080px (Full HD)</span></div>
      </div>

      <h4 style="margin: 10px 0 5px 0;">üì¶ –§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞:</h4>
      <div class="video-format-options">
        <div class="video-format-option selected" data-format="mp4">
          <span>MP4</span>
          <span style="font-size: 0.8em; color: #666;">(–ª—É—á—à–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)</span>
        </div>
      </div>

      <h4 style="margin: 15px 0 5px 0;">üéØ –ö–∞—á–µ—Å—Ç–≤–æ —Å–∂–∞—Ç–∏—è:</h4>
      <div class="video-quality-options">
        <div class="video-quality-option" data-quality="high">
          <span>–í—ã—Å–æ–∫–æ–µ (CRF 18)</span>
          <span class="quality-info">~60% –æ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª–∞</span>
        </div>
        <div class="video-quality-option selected" data-quality="medium">
          <span>–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ (CRF 23)</span>
          <span class="quality-info">~40% –æ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª–∞</span>
        </div>
        <div class="video-quality-option" data-quality="low">
          <span>–≠–∫–æ–Ω–æ–º–Ω–æ–µ (CRF 28)</span>
          <span class="quality-info">~25% –æ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª–∞</span>
        </div>
      </div>
    </div>
  </div>

  <div class="stats" id="statsInfo"></div>

  <button class="process-btn" id="processBtn">üöÄ –ù–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É</button>

  <div class="progress-bar hidden" id="progressBar">
    <div class="progress" id="progress"></div>
  </div>

  <div class="result hidden" id="result">
    <h3>‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h3>
    <div class="result-files" id="resultFiles"></div>
  </div>

  <div class="download-section hidden" id="downloadSection">
    <button class="download-all-btn" id="downloadAllBtn">üíæ –°–∫–∞—á–∞—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã (ZIP)</button>
    <p style="text-align:center; margin-top:10px; color:#666;">
      –ë—É–¥–µ—Ç —Å–∫–∞—á–∞–Ω ZIP-–∞—Ä—Ö–∏–≤ —Å–æ –≤—Å–µ–º–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏
    </p>
  </div>
</div>

<script>
/* ===========================
   Video Processor Class
=========================== */
class VideoProcessor {
  constructor() {
    this.ffmpeg = null;
    this.isFFmpegReady = false;
    this.initFFmpeg();
  }

  async initFFmpeg() {
    if (typeof FFmpeg === 'undefined') {
      console.warn('FFmpeg –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω. –í–∏–¥–µ–æ –±—É–¥—É—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è –±–µ–∑ –ø–µ—Ä–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è.');
      return;
    }

    try {
      const { createFFmpeg } = FFmpeg;
      this.ffmpeg = createFFmpeg({
        log: true,
        corePath: 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.4/dist/ffmpeg-core.js'
      });

      console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º FFmpeg...');
      await this.ffmpeg.load();
      this.isFFmpegReady = true;
      console.log('‚úÖ FFmpeg —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω');
    } catch (e) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ FFmpeg:', e);
    }
  }

  async processVideo(file, settings) {
    const { resolution='640x360', quality='medium', format='mp4' } = settings;

    // –ï—Å–ª–∏ FFmpeg –Ω–µ –≥–æ—Ç–æ–≤ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª
    if (!this.isFFmpegReady || !this.ffmpeg) {
      console.warn('‚ö†Ô∏è FFmpeg –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞—é –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π');
      return file;
    }

    try {
      return await this.processWithFFmpeg(file, resolution, quality, format);
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ FFmpeg –æ–±—Ä–∞–±–æ—Ç–∫–∏, –≤–æ–∑–≤—Ä–∞—â–∞—é –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª:', error);
      return file;
    }
  }

  async processWithFFmpeg(file, resolution, quality, format) {
    const { ffmpeg } = this;
    const [width, height] = resolution.split('x').map(Number);

    const crfValues = { high: 18, medium: 23, low: 28 };
    const crf = crfValues[quality] || 23;

    const bitrateValues = { high: '1500k', medium: '1000k', low: '500k' };
    const videoBitrate = bitrateValues[quality] || '1000k';

    const inputData = await file.arrayBuffer();
    const inputName = `input.${this.getFileExtension(file.name)}`;
    const outputName = `output.${format}`;

    ffmpeg.FS('writeFile', inputName, new Uint8Array(inputData));

    const command = [
      '-i', inputName,
      '-vf', `scale=${width}:${height}:force_original_aspect_ratio=decrease,pad=${width}:${height}:(ow-iw)/2:(oh-ih)/2`,
      '-c:v', 'libx264',
      '-b:v', videoBitrate,
      '-crf', crf.toString(),
      '-preset', 'fast',
      '-c:a', 'aac',
      '-b:a', '128k',
      '-movflags', '+faststart',
      '-y',
      outputName
    ];

    await ffmpeg.run(...command);

    const outputData = ffmpeg.FS('readFile', outputName);
    ffmpeg.FS('unlink', inputName);
    ffmpeg.FS('unlink', outputName);

    const blob = new Blob([outputData.buffer], { type: 'video/mp4' });
    return blob;
  }

  getFileExtension(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    const videoExtensions = {
      'mp4': 'mp4','mov': 'mov','avi': 'avi','mkv': 'mkv','webm': 'webm','ogg': 'ogg','wmv': 'wmv','flv': 'flv','m4v': 'm4v','3gp': '3gp'
    };
    return videoExtensions[ext] || 'mp4';
  }

  cancel() {
    if (this.ffmpeg) {
      try {
        const files = this.ffmpeg.FS('readdir', '/');
        files.forEach(file => {
          if (file !== '.' && file !== '..') {
            try { this.ffmpeg.FS('unlink', `/${file}`); } catch (e) {}
          }
        });
      } catch (e) {}
    }
  }
}

/* ===========================
   Utils
=========================== */
class FileUtils {
  static getFileType(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    const imageExts = ['jpg','jpeg','png','gif','webp','bmp','svg'];
    const audioExts = ['mp3','wav','ogg','flac','aac','m4a'];
    const videoExts = ['mp4','mov','avi','mkv','webm','wmv','flv','m4v','3gp'];

    if (imageExts.includes(ext)) return '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
    if (audioExts.includes(ext)) return '–ê—É–¥–∏–æ';
    if (videoExts.includes(ext)) return '–í–∏–¥–µ–æ';
    return '–î—Ä—É–≥–æ–π';
  }

  static formatFileSize(bytes) {
    if (bytes === 0) return '0 –ë';
    const k = 1024;
    const sizes = ['–ë','–ö–ë','–ú–ë','–ì–ë'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }
}

class ColorUtils {
  static clamp(v, min=0, max=255){ return Math.max(min, Math.min(max, v)); }
  static rgbToHex(r,g,b){
    const toHex = (n)=> n.toString(16).padStart(2,'0');
    return `#${toHex(this.clamp(r|0))}${toHex(this.clamp(g|0))}${toHex(this.clamp(b|0))}`;
  }
  static hexToRgb(hex){
    const h = (hex || '').trim();
    const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(h);
    if (!m) return null;
    return { r: parseInt(m[1],16), g: parseInt(m[2],16), b: parseInt(m[3],16) };
  }
  static luminance(r,g,b){
    // 0..1
    const srgb = [r,g,b].map(v=>{
      v/=255;
      return v<=0.03928 ? v/12.92 : Math.pow((v+0.055)/1.055, 2.4);
    });
    return 0.2126*srgb[0] + 0.7152*srgb[1] + 0.0722*srgb[2];
  }
  static dist2(a,b){
    const dr=a[0]-b[0], dg=a[1]-b[1], db=a[2]-b[2];
    return dr*dr+dg*dg+db*db;
  }
}

/* ===========================
   Media Processor
=========================== */
class MediaProcessor {
  constructor() {
    this.isCancelled = false;
    this.videoProcessor = new VideoProcessor();
    this.initVideoProcessor();
  }

  async initVideoProcessor() {
    setTimeout(() => {
      if (!this.videoProcessor.isFFmpegReady) {
        console.log('‚è≥ FFmpeg –≤—Å–µ –µ—â–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...');
      }
    }, 1000);
  }

  cancel() {
    this.isCancelled = true;
    if (this.videoProcessor) this.videoProcessor.cancel();
  }

  async processFiles(files, settings, onProgress, onFileProcessed) {
    this.isCancelled = false;
    const totalFiles = files.length;
    let processedCount = 0;

    // –°–Ω–∞—á–∞–ª–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –∞—É–¥–∏–æ
    for (let i = 0; i < files.length; i++) {
      if (this.isCancelled) break;

      const file = files[i];
      const type = FileUtils.getFileType(file.name);

      if (type === '–í–∏–¥–µ–æ') continue;

      try {
        const processed = await this.processSingleFile(file, settings, i);
        if (processed && processed.length > 0) onFileProcessed(processed);

        processedCount++;
        onProgress((processedCount / totalFiles) * 100);
        await new Promise(r => setTimeout(r, 50));
      } catch (e) {
        console.error(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞ ${file.name}:`, e);
        this.handleFallback(file, i, onFileProcessed);
        processedCount++;
        onProgress((processedCount / totalFiles) * 100);
      }
    }

    // –ó–∞—Ç–µ–º –≤–∏–¥–µ–æ
    const videoFiles = files.filter(f => FileUtils.getFileType(f.name) === '–í–∏–¥–µ–æ');
    console.log(`üé¨ –ù–∞—á–∏–Ω–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É ${videoFiles.length} –≤–∏–¥–µ–æ —Ñ–∞–π–ª–æ–≤...`);

    for (let i = 0; i < videoFiles.length; i++) {
      if (this.isCancelled) break;

      const file = videoFiles[i];
      const originalIndex = files.indexOf(file);

      try {
        const videoProgress = document.createElement('div');
        videoProgress.className = 'video-processing-status';
        videoProgress.innerHTML = `üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–µ–æ: ${file.name} (${i + 1}/${videoFiles.length})`;
        document.querySelector('.settings').appendChild(videoProgress);

        const processed = await this.processSingleFile(file, settings, originalIndex);
        if (processed && processed.length > 0) {
          onFileProcessed(processed);
          videoProgress.className = 'video-processing-status success';
          videoProgress.innerHTML = `‚úÖ –í–∏–¥–µ–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${file.name}`;
        }

        processedCount++;
        onProgress((processedCount / totalFiles) * 100);

        await new Promise(r => setTimeout(r, 500));
        setTimeout(() => videoProgress.remove(), 3000);

      } catch (e) {
        console.error(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∏–¥–µ–æ ${file.name}:`, e);

        const errorStatus = document.createElement('div');
        errorStatus.className = 'video-processing-status error';
        errorStatus.innerHTML = `‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∏–¥–µ–æ: ${file.name}`;
        document.querySelector('.settings').appendChild(errorStatus);

        this.handleFallback(file, originalIndex, onFileProcessed);
        processedCount++;
        onProgress((processedCount / totalFiles) * 100);

        setTimeout(() => errorStatus.remove(), 3000);
      }
    }
  }

  handleFallback(file, index, onFileProcessed) {
    const fallbackName = appState.generateFileName(
      file.customName || file.name.replace(/\.[^/.]+$/, ''),
      (file.name.split('.').pop() || '').toLowerCase(),
      FileUtils.getFileType(file.name),
      file.name,
      1,
      index
    );

    onFileProcessed([{
      blob: file,
      name: fallbackName,
      type: FileUtils.getFileType(file.name),
      originalSize: file.size,
      compressedSize: file.size
    }]);
  }

  async processSingleFile(file, settings, fileIndex) {
    const type = FileUtils.getFileType(file.name);
    const processed = [];

    if (type === '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ') {
      await this.processImage(file, settings, processed, fileIndex);
    } else if (type === '–ê—É–¥–∏–æ') {
      await this.processAudio(file, settings, processed, fileIndex);
    } else if (type === '–í–∏–¥–µ–æ') {
      await this.processVideo(file, settings, processed, fileIndex);
    } else {
      const name = appState.generateFileName(
        file.customName || file.name.replace(/\.[^/.]+$/, ''),
        (file.name.split('.').pop() || '').toLowerCase(),
        type,
        file.name,
        1,
        fileIndex
      );
      processed.push({ blob: file, name, type, originalSize: file.size, compressedSize: file.size });
    }

    return processed;
  }

  async processImage(file, settings, processed, fileIndex) {
    return new Promise((resolve) => {
      const reader = new FileReader();

      reader.onload = (e) => {
        const img = new Image();

        img.onload = async () => {
          try {
            const sizes = settings.imageSizes.split(',').map(s => s.trim()).filter(Boolean);

            const formats = [];
            if (document.getElementById('formatPNG').checked) formats.push('png');
            if (document.getElementById('formatJPG').checked) formats.push('jpg');

            if (!sizes.length || !formats.length) {
              const name = appState.generateFileName(
                file.customName || file.name.replace(/\.[^/.]+$/, ''),
                (file.name.split('.').pop() || '').toLowerCase(),
                '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ',
                file.name,
                1,
                fileIndex
              );

              const canvas = document.createElement('canvas');
              const ctx = canvas.getContext('2d');
              canvas.width = img.width;
              canvas.height = img.height;
              ctx.drawImage(img, 0, 0);

              const isPng = file.type.includes('png');
              const mimeType = isPng ? 'image/png' : 'image/jpeg';
              const quality = isPng ? 0.9 : 0.85;

              canvas.toBlob((blob) => {
                if (blob) {
                  processed.push({
                    blob, name,
                    type: '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ',
                    originalSize: file.size,
                    compressedSize: blob.size,
                    format: isPng ? 'png' : 'jpg',
                    background: settings.selectedBackground
                  });
                }
                resolve();
              }, mimeType, quality);
              return;
            }

            const promises = [];
            const totalVariants = sizes.length * formats.length || 1;
            let counter = 1;

            for (const size of sizes) {
              const [width, height] = size.split('x').map(Number);
              for (const format of formats) {
                if (this.isCancelled) { resolve(); return; }
                promises.push(this.createImageVersion(
                  img, width, height, format, file, processed,
                  counter, totalVariants, fileIndex, settings
                ));
                counter++;
              }
            }

            await Promise.all(promises);
            resolve();

          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
            resolve();
          }
        };

        img.onerror = () => {
          const name = appState.generateFileName(
            file.customName || file.name.replace(/\.[^/.]+$/, ''),
            (file.name.split('.').pop() || '').toLowerCase(),
            '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ',
            file.name,
            1,
            fileIndex
          );
          processed.push({
            blob: file, name,
            type: '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ',
            originalSize: file.size,
            compressedSize: file.size,
            background: settings.selectedBackground
          });
          resolve();
        };

        img.src = e.target.result;
      };

      reader.onerror = () => { console.error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞'); resolve(); };
      reader.readAsDataURL(file);
    });
  }

  async createImageVersion(img, width, height, format, file, processed, counter, totalVariants, fileIndex, settings) {
    return new Promise((resolveVersion) => {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      canvas.width = width;
      canvas.height = height;

      const backgroundColor = this.getBackgroundColor(settings.selectedBackground);

      if (backgroundColor === 'transparent' && format === 'png') {
        ctx.clearRect(0, 0, width, height);
      } else if (backgroundColor === 'transparent') {
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, width, height);
      } else {
        ctx.fillStyle = backgroundColor;
        ctx.fillRect(0, 0, width, height);
      }

      const scale = Math.min(width / img.width, height / img.height);
      const scaledWidth = img.width * scale;
      const scaledHeight = img.height * scale;
      const offsetX = (width - scaledWidth) / 2;
      const offsetY = (height - scaledHeight) / 2;

      ctx.drawImage(img, offsetX, offsetY, scaledWidth, scaledHeight);

      const finalName = appState.generateFileName(
        file.customName || file.name.replace(/\.[^/.]+$/, ''),
        format,
        '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ',
        file.name,
        counter,
        fileIndex,
        totalVariants
      );

      const mimeType = format === 'png' ? 'image/png' : 'image/jpeg';
      const quality = format === 'png' ? 0.9 : 0.85;

      canvas.toBlob((blob) => {
        if (blob) {
          processed.push({
            blob,
            name: finalName,
            type: '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ',
            originalSize: file.size,
            compressedSize: blob.size,
            format,
            resolution: `${width}x${height}`,
            background: settings.selectedBackground,
            backgroundColor
          });
        }
        resolveVersion();
      }, mimeType, quality);
    });
  }

  getBackgroundColor(backgroundType) {
    switch (backgroundType) {
      case 'white': return '#ffffff';
      case 'lightgray': return '#f0f0f0';
      case 'transparent': return 'transparent';
      case 'black': return '#000000';
      case 'custom': {
        const hexColor = document.getElementById('customColorHex').value;
        return this.validateColor(hexColor) ? hexColor : '#ffffff';
      }
      default: return '#ffffff';
    }
  }

  validateColor(color) {
    const hexRegex = /^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/;
    return hexRegex.test(color);
  }

  async processAudio(file, settings, processed, fileIndex) {
    try {
      const formats = [];
      if (document.getElementById('audioMP3').checked) formats.push('mp3');
      if (document.getElementById('audioOGG').checked) formats.push('ogg');

      const bitrate = parseInt(document.getElementById('audioBitrate').value) || 128;

      if (!formats.length) {
        const name = appState.generateFileName(
          file.customName || file.name.replace(/\.[^/.]+$/, ''),
          (file.name.split('.').pop() || '').toLowerCase(),
          '–ê—É–¥–∏–æ',
          file.name,
          1,
          fileIndex
        );
        processed.push({ blob: file, name, type: '–ê—É–¥–∏–æ', originalSize: file.size, compressedSize: file.size });
        return;
      }

      // –í–ê–ñ–ù–û: –∑–¥–µ—Å—å –Ω–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø–µ—Ä–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è, —Ç–æ–ª—å–∫–æ "–æ–±—ë—Ä—Ç–∫–∞" Blob.
      // –†–µ–∞–ª—å–Ω–æ–µ –ø–µ—Ä–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ (–±–∏—Ç—Ä–µ–π—Ç/–∫–æ–¥–µ–∫) –≤–æ–∑–º–æ–∂–Ω–æ —á–µ—Ä–µ–∑ FFmpeg WASM.
      for (let i = 0; i < formats.length; i++) {
        const format = formats[i];
        const mimeType = format === 'mp3' ? 'audio/mpeg' : 'audio/ogg';
        const newBlob = new Blob([await file.arrayBuffer()], { type: mimeType });

        const fileName = appState.generateFileName(
          file.customName || file.name.replace(/\.[^/.]+$/, ''),
          format,
          '–ê—É–¥–∏–æ',
          file.name,
          i + 1,
          fileIndex
        );

        processed.push({
          blob: newBlob,
          name: fileName,
          type: '–ê—É–¥–∏–æ',
          originalSize: file.size,
          compressedSize: newBlob.size,
          format,
          bitrate: `${bitrate}kbps`
        });
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—É–¥–∏–æ:', error);
      const name = appState.generateFileName(
        file.customName || file.name.replace(/\.[^/.]+$/, ''),
        (file.name.split('.').pop() || '').toLowerCase(),
        '–ê—É–¥–∏–æ',
        file.name,
        1,
        fileIndex
      );
      processed.push({ blob: file, name, type: '–ê—É–¥–∏–æ', originalSize: file.size, compressedSize: file.size });
    }
  }

  async processVideo(file, settings, processed, fileIndex) {
    try {
      const resolution = settings.selectedVideoResolution || '640x360';
      const quality = settings.selectedVideoQuality || 'medium';
      const format = settings.selectedVideoFormat || 'mp4';

      const videoStatus = document.createElement('div');
      videoStatus.className = 'video-processing-status';
      videoStatus.innerHTML = `üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–µ–æ: ${file.name} (—ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è)`;
      document.querySelector('.settings').appendChild(videoStatus);

      const processedBlob = await this.videoProcessor.processVideo(file, { resolution, quality, format });

      videoStatus.className = 'video-processing-status success';
      videoStatus.innerHTML = `‚úÖ –í–∏–¥–µ–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${file.name}`;
      setTimeout(() => videoStatus.remove(), 3000);

      const fileName = appState.generateFileName(
        file.customName || file.name.replace(/\.[^/.]+$/, ''),
        format,
        '–í–∏–¥–µ–æ',
        file.name,
        1,
        fileIndex
      );

      processed.push({
        blob: processedBlob,
        name: fileName,
        type: '–í–∏–¥–µ–æ',
        originalSize: file.size,
        compressedSize: processedBlob.size,
        resolution,
        quality,
        format,
        duration: '–ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è'
      });

    } catch (error) {
      console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∏–¥–µ–æ:', error);

      const errorStatus = document.createElement('div');
      errorStatus.className = 'video-processing-status error';
      errorStatus.innerHTML = `‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤–∏–¥–µ–æ: ${file.name}`;
      document.querySelector('.settings').appendChild(errorStatus);

      const name = appState.generateFileName(
        file.customName || file.name.replace(/\.[^/.]+$/, ''),
        (file.name.split('.').pop() || '').toLowerCase(),
        '–í–∏–¥–µ–æ',
        file.name,
        1,
        fileIndex
      );
      processed.push({
        blob: file,
        name,
        type: '–í–∏–¥–µ–æ',
        originalSize: file.size,
        compressedSize: file.size,
        note: '–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª (–æ—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏)'
      });

      setTimeout(() => errorStatus.remove(), 3000);
    }
  }
}

/* ===========================
   App State
=========================== */
class AppState {
  constructor() {
    this.files = [];
    this.processedFiles = [];
    this.currentSettings = this.getDefaultSettings();
    this.mediaProcessor = new MediaProcessor();

    this._brandDebounceTimer = null;
    this.lastBrandRecommendations = null;

    this.initEventListeners();
    this.updateUI();
  }

  getDefaultSettings() {
    return {
      imageSizes: '1200x600, 800x400, 400x200',
      selectedBackground: 'white',
      selectedVideoResolution: '640x360',
      selectedVideoQuality: 'medium',
      selectedVideoFormat: 'mp4'
    };
  }

  initEventListeners() {
    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('dropZone');
    const processBtn = document.getElementById('processBtn');

    fileInput.addEventListener('change', (e) => this.handleFiles(e.target.files));

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      this.handleFiles(e.dataTransfer.files);
    });

    this.initVideoSettingsListeners();
    this.initBackgroundColorListeners();

    processBtn.addEventListener('click', () => this.startProcessing());

    const smartRenamingCheckbox = document.getElementById('smartRenaming');
    const useOriginalNamesCheckbox = document.getElementById('useOriginalNames');
    const globalBaseInput = document.getElementById('globalBaseName');

    if (smartRenamingCheckbox) smartRenamingCheckbox.addEventListener('change', () => this.updateNamingExample());
    if (useOriginalNamesCheckbox) useOriginalNamesCheckbox.addEventListener('change', () => this.updateNamingExample());
    if (globalBaseInput) globalBaseInput.addEventListener('input', () => this.updateNamingExample());

    // –∞–≤—Ç–æ-–∞–Ω–∞–ª–∏–∑ –±—Ä–µ–Ω–¥–∞ –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–Ω–æ–π –≥–∞–ª–æ—á–∫–µ
    const aiAnalysis = document.getElementById('aiAnalysis');
    if (aiAnalysis) {
      aiAnalysis.addEventListener('change', () => {
        if (aiAnalysis.checked) this.scheduleBrandAnalysis();
      });
    }
  }

  initVideoSettingsListeners() {
    document.querySelectorAll('.resolution-option').forEach(option => {
      option.addEventListener('click', (e) => {
        document.querySelectorAll('.resolution-option').forEach(opt => opt.classList.remove('selected'));
        e.currentTarget.classList.add('selected');
        this.currentSettings.selectedVideoResolution = e.currentTarget.dataset.resolution;
      });
    });

    document.querySelectorAll('.video-format-option').forEach(option => {
      option.addEventListener('click', (e) => {
        document.querySelectorAll('.video-format-option').forEach(opt => opt.classList.remove('selected'));
        e.currentTarget.classList.add('selected');
        this.currentSettings.selectedVideoFormat = e.currentTarget.dataset.format;
      });
    });

    document.querySelectorAll('.video-quality-option').forEach(option => {
      option.addEventListener('click', (e) => {
        document.querySelectorAll('.video-quality-option').forEach(opt => opt.classList.remove('selected'));
        e.currentTarget.classList.add('selected');
        this.currentSettings.selectedVideoQuality = e.currentTarget.dataset.quality;
      });
    });
  }

  initBackgroundColorListeners() {
    document.querySelectorAll('.background-color-option').forEach(option => {
      option.addEventListener('click', (e) => {
        const selected = e.currentTarget.dataset.background;
        this.setBackgroundSelection(selected);
      });
    });

    document.getElementById('customColorPicker').addEventListener('input', (e) => {
      document.getElementById('customColorHex').value = e.target.value;
      this.updateCustomPreview(e.target.value);
    });

    document.getElementById('customColorHex').addEventListener('input', (e) => {
      const value = e.target.value;
      if (value.startsWith('#') && (value.length === 4 || value.length === 7)) {
        document.getElementById('customColorPicker').value = value;
        this.updateCustomPreview(value);
      }
    });

    // init preview
    this.updateCustomPreview(document.getElementById('customColorHex').value);
  }

  updateCustomPreview(hex) {
    const preview = document.getElementById('customBgPreview');
    if (preview && this.mediaProcessor && this.mediaProcessor.validateColor?.(hex)) {
      preview.style.background = hex;
    } else if (preview) {
      preview.style.background = '#ffffff';
    }
  }

  setBackgroundSelection(backgroundType) {
    document.querySelectorAll('.background-color-option').forEach(opt => opt.classList.remove('selected'));
    const option = document.querySelector(`.background-color-option[data-background="${backgroundType}"]`);
    if (option) option.classList.add('selected');

    this.currentSettings.selectedBackground = backgroundType;

    if (backgroundType === 'custom') {
      const hex = document.getElementById('customColorHex').value;
      this.updateCustomPreview(hex);
    }
  }

  applyCustomColor() {
    this.setBackgroundSelection('custom');
  }

  handleFiles(fileList) {
    const files = Array.from(fileList);
    files.forEach(file => {
      file.customName = file.name.replace(/\.[^/.]+$/, '');
      this.files.push(file);
    });
    this.updateUI();

    // –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω –∞–≤—Ç–æ-–∞–Ω–∞–ª–∏–∑ –±—Ä–µ–Ω–¥–∞ ‚Äî –ø–ª–∞–Ω–∏—Ä—É–µ–º
    if (document.getElementById('aiAnalysis')?.checked) {
      this.scheduleBrandAnalysis();
    }
  }

  scheduleBrandAnalysis() {
    clearTimeout(this._brandDebounceTimer);
    this._brandDebounceTimer = setTimeout(() => {
      this.analyzeBrandAssets().catch(err => console.error(err));
    }, 400);
  }

  updateUI() {
    const fileList = document.getElementById('fileList');
    const emptyState = document.getElementById('emptyState');
    const statsInfo = document.getElementById('statsInfo');

    if (this.files.length === 0) {
      emptyState.classList.remove('hidden');
      statsInfo.textContent = '';
      fileList.innerHTML = '';
      fileList.appendChild(emptyState);
      this.updateNamingExample();
      this.updateAITipIdle();
      return;
    }

    emptyState.classList.add('hidden');

    let html = '';
    let totalSize = 0;
    let imageCount = 0;
    let audioCount = 0;
    let videoCount = 0;

    this.files.forEach((file, index) => {
      totalSize += file.size;
      const type = FileUtils.getFileType(file.name);

      if (type === '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ') imageCount++;
      if (type === '–ê—É–¥–∏–æ') audioCount++;
      if (type === '–í–∏–¥–µ–æ') videoCount++;

      html += `
        <div class="file-item" data-index="${index}">
          <div class="file-info">
            <span class="file-icon">${this.getFileIcon(type)}</span>
            <div>
              <input type="text"
                     class="rename-input"
                     value="${file.customName}"
                     onchange="appState.updateFileName(${index}, this.value)"
                     placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ñ–∞–π–ª–∞">
              <div class="file-size">${FileUtils.formatFileSize(file.size)} ‚Ä¢ ${type}</div>
            </div>
          </div>
          <button class="cancel-btn" onclick="appState.removeFile(${index})">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      `;
    });

    fileList.innerHTML = html;

    let stats = `${this.files.length} —Ñ–∞–π–ª–æ–≤ ‚Ä¢ ${FileUtils.formatFileSize(totalSize)}`;
    if (imageCount > 0) stats += ` ‚Ä¢ ${imageCount} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π`;
    if (audioCount > 0) stats += ` ‚Ä¢ ${audioCount} –∞—É–¥–∏–æ`;
    if (videoCount > 0) stats += ` ‚Ä¢ ${videoCount} –≤–∏–¥–µ–æ`;

    statsInfo.textContent = stats;
    this.updateNamingExample();
    this.updateAITipReady();
  }

  getFileIcon(type) {
    switch (type) {
      case '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ': return 'üñºÔ∏è';
      case '–ê—É–¥–∏–æ': return 'üéµ';
      case '–í–∏–¥–µ–æ': return 'üé¨';
      default: return 'üìÑ';
    }
  }

  updateFileName(index, newName) {
    if (index >= 0 && index < this.files.length) {
      this.files[index].customName = newName || this.files[index].name.replace(/\.[^/.]+$/, '');
      this.updateNamingExample();
    }
  }

  removeFile(index) {
    if (index >= 0 && index < this.files.length) {
      this.files.splice(index, 1);
      this.updateUI();
      if (document.getElementById('aiAnalysis')?.checked) this.scheduleBrandAnalysis();
    }
  }

  getGlobalBaseName() {
    const input = document.getElementById('globalBaseName');
    if (!input) return '';
    const value = input.value.trim();
    return value || '';
  }

  extractNumberFromName(name) {
    const match = name.match(/(\d+)/);
    return match ? match[1] : '';
  }

  updateNamingExample() {
    const exampleEl = document.getElementById('namingExample');
    if (!exampleEl) return;

    if (this.files.length === 0) {
      exampleEl.textContent = 'logo.png –∏–ª–∏ logo_1.png, logo_2.png';
      return;
    }

    const useSmart = document.getElementById('smartRenaming')?.checked || false;
    const useOriginal = document.getElementById('useOriginalNames')?.checked || false;
    const globalBase = this.getGlobalBaseName();

    const firstFile = this.files[0];
    const type = FileUtils.getFileType(firstFile.name);

    let examples = [];

    if (useOriginal) {
      const ext = (firstFile.name.split('.').pop() || '').toLowerCase();
      const base = firstFile.name.replace(/\.[^/.]+$/, '');
      examples = [`${base}.${ext}`, `${base}_2.${ext}`, `${base}_3.${ext}`];
      exampleEl.textContent = examples.join(', ');
      return;
    }

    if (useSmart && globalBase && type === '–ê—É–¥–∏–æ') {
      const nums = this.files.slice(0, 3).map(f => this.extractNumberFromName(f.name)).filter(Boolean);
      if (nums.length) examples = nums.map(n => `${globalBase}${n}.mp3`);
      else examples = [`${globalBase}.mp3`, `${globalBase}_2.mp3`, `${globalBase}_3.mp3`];
      exampleEl.textContent = examples.join(', ');
      return;
    }

    if (useSmart && type === '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ' && globalBase.toLowerCase() === 'logo') {
      examples = ['logo.png', 'logo_1.png', 'logo_2.png'];
      exampleEl.textContent = examples.join(', ');
      return;
    }

    const baseName = useSmart ? (globalBase || this.getSmartPrefix(type)) : (firstFile.customName || firstFile.name.replace(/\.[^/.]+$/, '') || 'file');

    if (type === '–ê—É–¥–∏–æ') examples = [`${baseName}.mp3`, `${baseName}_2.mp3`, `${baseName}_3.mp3`];
    else if (type === '–í–∏–¥–µ–æ') examples = [`${baseName}.mp4`, `${baseName}_2.mp4`, `${baseName}_3.mp4`];
    else examples = [`${baseName}.png`, `${baseName}_2.png`, `${baseName}_3.png`];

    exampleEl.textContent = examples.join(', ');
  }

  generateFileName(baseName, format, type, originalName, index, fileIndex, totalVariants) {
    const useSmart = document.getElementById('smartRenaming')?.checked || false;
    const useOriginal = document.getElementById('useOriginalNames')?.checked || false;
    const globalBase = this.getGlobalBaseName();

    const originalExt = (originalName.split('.').pop() || '').toLowerCase();
    const ext = (format || originalExt || '').toLowerCase() || 'dat';

    const originalBase = originalName.replace(/\.[^/.]+$/, '') || baseName || 'file';

    if (useOriginal) return `${originalBase}.${ext}`;

    if (useSmart && globalBase && type === '–ê—É–¥–∏–æ') {
      const num = this.extractNumberFromName(originalName);
      if (num) return `${globalBase}${num}.${ext}`;
    }

    let nameBase;
    if (useSmart) nameBase = globalBase || this.getSmartPrefix(type);
    else nameBase = baseName || originalBase || 'file';

    if (useSmart && type === '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ' && (globalBase || nameBase).toLowerCase() === 'logo' && totalVariants && totalVariants > 0) {
      if (totalVariants === 1) return `${nameBase}.${ext}`;
      if (index === 1) return `${nameBase}.${ext}`;
      const suffix = index - 1;
      return `${nameBase}_${suffix}.${ext}`;
    }

    if (index === 1) return `${nameBase}.${ext}`;
    return `${nameBase}_${index}.${ext}`;
  }

  getSmartPrefix(type) {
    switch (type) {
      case '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ': return 'image';
      case '–ê—É–¥–∏–æ': return 'audio';
      case '–í–∏–¥–µ–æ': return 'video';
      default: return 'file';
    }
  }

  async startProcessing() {
    if (this.files.length === 0) {
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏');
      return;
    }

    const processBtn = document.getElementById('processBtn');
    const progressBar = document.getElementById('progressBar');
    const progress = document.getElementById('progress');
    const result = document.getElementById('result');
    const downloadSection = document.getElementById('downloadSection');

    processBtn.disabled = true;
    processBtn.textContent = 'üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞...';

    progressBar.classList.remove('hidden');
    progress.style.width = '0%';

    result.classList.add('hidden');
    downloadSection.classList.add('hidden');
    this.processedFiles = [];

    const settings = {
      imageSizes: document.getElementById('imageSizes').value,
      selectedBackground: this.currentSettings.selectedBackground,
      selectedVideoResolution: this.currentSettings.selectedVideoResolution,
      selectedVideoQuality: this.currentSettings.selectedVideoQuality,
      selectedVideoFormat: this.currentSettings.selectedVideoFormat
    };

    try {
      await this.mediaProcessor.processFiles(
        this.files,
        settings,
        (percent) => { progress.style.width = `${percent}%`; },
        (processedBatch) => {
          this.processedFiles.push(...processedBatch);
          this.updateResultsUI();
        }
      );

      progress.style.width = '100%';
      result.classList.remove('hidden');
      downloadSection.classList.remove('hidden');

      document.getElementById('downloadAllBtn').onclick = () => this.downloadAllAsZip();

    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏:', error);
      this.showError('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: ' + error.message);
    } finally {
      processBtn.disabled = false;
      processBtn.textContent = 'üöÄ –ù–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É';
    }
  }

  updateResultsUI() {
    const resultFiles = document.getElementById('resultFiles');
    let html = '';
    let totalOriginal = 0;
    let totalCompressed = 0;

    this.processedFiles.forEach((file, index) => {
      totalOriginal += file.originalSize;
      totalCompressed += file.compressedSize;

      const compression = file.originalSize > 0 ? Math.round((1 - file.compressedSize / file.originalSize) * 100) : 0;
      const compressionText = compression > 0 ? ` (—Å–∂–∞—Ç–∏–µ: ${compression}%)` : '';
      const note = file.note ? `<div style="font-size:0.8em;color:#666;">${file.note}</div>` : '';

      html += `
        <div class="result-file">
          <div>
            <strong>${file.name}</strong>
            <div class="file-size-compression">
              ${FileUtils.formatFileSize(file.originalSize)} ‚Üí
              ${FileUtils.formatFileSize(file.compressedSize)}${compressionText}
              ${file.resolution ? ` ‚Ä¢ ${file.resolution}` : ''}
              ${file.format ? ` ‚Ä¢ ${String(file.format).toUpperCase()}` : ''}
            </div>
            ${note}
          </div>
          <button class="download-btn" onclick="appState.downloadSingleFile(${index})">üì• –°–∫–∞—á–∞—Ç—å</button>
        </div>
      `;
    });

    const totalCompression = totalOriginal > 0 ? Math.round((1 - totalCompressed / totalOriginal) * 100) : 0;

    const statsHtml = `
      <div style="margin-bottom: 15px; padding: 10px; background: #d4edda; border-radius: 8px;">
        <strong>üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</strong><br>
        –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: ${this.processedFiles.length}<br>
        –û–±—â–∏–π —Ä–∞–∑–º–µ—Ä: ${FileUtils.formatFileSize(totalOriginal)} ‚Üí
        ${FileUtils.formatFileSize(totalCompressed)}<br>
        –û–±—â–µ–µ —Å–∂–∞—Ç–∏–µ: ${totalCompression}%
      </div>
    `;

    resultFiles.innerHTML = statsHtml + html;
  }

  downloadSingleFile(index) {
    if (index >= 0 && index < this.processedFiles.length) {
      const file = this.processedFiles[index];
      const url = URL.createObjectURL(file.blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = file.name;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  }

  async downloadAllAsZip() {
    try {
      const zip = new JSZip();
      const folder = zip.folder("processed_files");

      this.processedFiles.forEach(file => {
        folder.file(file.name, file.blob);
      });

      const readme = `
–û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –º–µ–¥–∏–∞—Ñ–∞–π–ª—ã
–î–∞—Ç–∞: ${new Date().toLocaleDateString()}
–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤: ${this.processedFiles.length}

–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏:
- –§–æ–Ω –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: ${this.currentSettings.selectedBackground}
- –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –≤–∏–¥–µ–æ: ${this.currentSettings.selectedVideoResolution}
- –ö–∞—á–µ—Å—Ç–≤–æ –≤–∏–¥–µ–æ: ${this.currentSettings.selectedVideoQuality}
- –§–æ—Ä–º–∞—Ç –≤–∏–¥–µ–æ: ${this.currentSettings.selectedVideoFormat}

–°–æ–∑–¥–∞–Ω–æ —Å –ø–æ–º–æ—â—å—é MediaProcessor | Relation-AI
      `.trim();

      folder.file("README.txt", readme);

      const content = await zip.generateAsync({ type: "blob" });
      const url = URL.createObjectURL(content);
      const a = document.createElement('a');
      a.href = url;
      a.download = `processed_files_${Date.now()}.zip`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è ZIP:', error);
      this.showError('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞—Ä—Ö–∏–≤–∞: ' + error.message);
    }
  }

  showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'temp-message error-message';
    errorDiv.innerHTML = `<strong>‚ùå –û—à–∏–±–∫–∞:</strong> ${message}`;

    const container = document.querySelector('.container');
    container.insertBefore(errorDiv, container.children[1]);

    setTimeout(() => errorDiv.remove(), 5000);
  }

  /* ===========================
     AI: UI helpers
  ============================ */
  updateAITipIdle() {
    document.getElementById('aiTipTitle').textContent = '–°–æ–≤–µ—Ç–Ω–∏–∫ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ';
    document.getElementById('aiTipContent').textContent = '–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏';
    document.getElementById('aiResults').classList.add('hidden');
  }

  updateAITipReady() {
    const img = this.files.filter(f => FileUtils.getFileType(f.name) === '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ').length;
    const aud = this.files.filter(f => FileUtils.getFileType(f.name) === '–ê—É–¥–∏–æ').length;
    const vid = this.files.filter(f => FileUtils.getFileType(f.name) === '–í–∏–¥–µ–æ').length;

    document.getElementById('aiTipTitle').textContent = '–§–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã';
    document.getElementById('aiTipContent').textContent =
      `–ù–∞–∂–º–∏—Ç–µ ‚Äú–ü–æ–ª—É—á–∏—Ç—å —Å–æ–≤–µ—Ç—ã‚Äù –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫. (–∏–∑–æ–±—Ä: ${img}, –∞—É–¥–∏–æ: ${aud}, –≤–∏–¥–µ–æ: ${vid})`;
  }

  renderAIResults(statsHtml, tips) {
    const aiResults = document.getElementById('aiResults');
    const aiStats = document.getElementById('aiStats');
    const aiTipsList = document.getElementById('aiTipsList');

    aiStats.innerHTML = statsHtml;
    aiTipsList.innerHTML = tips.map(t => `<div class="ai-tip-item">${t}</div>`).join('');

    aiResults.classList.remove('hidden');

    // top tip card
    const top = tips[0] ? tips[0].replace(/<[^>]+>/g,'') : '–ì–æ—Ç–æ–≤–æ';
    document.getElementById('aiTipTitle').textContent = '–ì–æ—Ç–æ–≤–æ ‚úÖ';
    document.getElementById('aiTipContent').textContent = top.length > 140 ? (top.slice(0, 140) + '‚Ä¶') : top;
  }

  /* ===========================
     AI #1: Advisor (heuristics)
  ============================ */
  getAIAdvice() {
    const files = this.files;
    if (!files.length) {
      this.updateAITipIdle();
      return;
    }

    const images = files.filter(f => FileUtils.getFileType(f.name) === '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
    const audio = files.filter(f => FileUtils.getFileType(f.name) === '–ê—É–¥–∏–æ');
    const video = files.filter(f => FileUtils.getFileType(f.name) === '–í–∏–¥–µ–æ');

    const pngChecked = document.getElementById('formatPNG').checked;
    const jpgChecked = document.getElementById('formatJPG').checked;

    const mp3Checked = document.getElementById('audioMP3').checked;
    const oggChecked = document.getElementById('audioOGG').checked;

    const sizesRaw = (document.getElementById('imageSizes').value || '').trim();
    const sizes = sizesRaw.split(',').map(s=>s.trim()).filter(Boolean);
    const badSizes = sizes.filter(s => !/^\d+\s*x\s*\d+$/.test(s));

    const useSmart = document.getElementById('smartRenaming')?.checked;
    const useOrig = document.getElementById('useOriginalNames')?.checked;
    const globalBase = this.getGlobalBaseName();

    const tips = [];

    // naming sanity
    if (useSmart && !globalBase) {
      tips.push('üè∑Ô∏è <b>–£–º–Ω–æ–µ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ</b>, –Ω–æ ‚Äú–û–±—â–µ–µ –∏–º—è‚Äù –ø—É—Å—Ç–æ–µ. –ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª–µ, –∏–Ω–∞—á–µ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø—Ä–µ—Ñ–∏–∫—Å –ø–æ —Ç–∏–ø—É (image/audio/video).');
    }
    if (useSmart && useOrig) {
      tips.push('‚ö†Ô∏è –í–∫–ª—é—á–µ–Ω—ã —Å—Ä–∞–∑—É <b>‚Äú–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞‚Äù</b> –∏ <b>‚Äú—É–º–Ω–æ–µ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ‚Äù</b>. –°–µ–π—á–∞—Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —É –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö –∏–º—ë–Ω ‚Äî —É–º–Ω–æ–µ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è.');
    }

    // images tips
    if (images.length) {
      if (!pngChecked && !jpgChecked) {
        tips.push('üñºÔ∏è –î–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–µ –≤—ã–±—Ä–∞–Ω PNG/JPG. –¢–æ–≥–¥–∞ —Ä–µ—Å–∞–π–∑/—Ñ–æ—Ä–º–∞—Ç—ã –º–æ–≥—É—Ç –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è (–±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ‚Äú–∫–∞–∫ –µ—Å—Ç—å‚Äù). –ü–æ—Å—Ç–∞–≤—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ñ–æ—Ä–º–∞—Ç.');
      }
      if (!sizes.length) tips.push('üìê –ü–æ–ª–µ —Ä–∞–∑–º–µ—Ä–æ–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø—É—Å—Ç–æ–µ. –î–æ–±–∞–≤—å —Ä–∞–∑–º–µ—Ä—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: 1200x600, 800x400).');
      if (badSizes.length) tips.push(`‚ùå –ù–∞–π–¥–µ–Ω—ã –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã: <b>${badSizes.join(', ')}</b>. –§–æ—Ä–º–∞—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å ‚Äú—á–∏—Å–ª–æx—á–∏—Å–ª–æ‚Äù, –Ω–∞–ø—Ä–∏–º–µ—Ä 800x400.`);

      const bg = this.currentSettings.selectedBackground;
      if (bg === 'transparent' && jpgChecked) {
        tips.push('üé® –í—ã–±—Ä–∞–Ω <b>–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω</b>, –Ω–æ –¥–ª—è JPG –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞ ‚Äî —Ñ–æ–Ω —Å—Ç–∞–Ω–µ—Ç –±–µ–ª—ã–º. –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å, –∏—Å–ø–æ–ª—å–∑—É–π PNG.');
      }
      if (bg === 'black' && jpgChecked) {
        tips.push('üé® –ß—ë—Ä–Ω—ã–π —Ñ–æ–Ω + JPG: –æ–∫, –Ω–æ –ø—Ä–æ–≤–µ—Ä—å, —á—Ç–æ–±—ã –ª–æ–≥–æ—Ç–∏–ø—ã/—Ç–µ–∫—Å—Ç –Ω–µ ‚Äú—Å—ä–µ–¥–∞–ª–∏—Å—å‚Äù –∫–æ–Ω—Ç—Ä–∞—Å—Ç–æ–º.');
      }
    }

    // audio tips
    if (audio.length) {
      if (!mp3Checked && !oggChecked) {
        tips.push('üéµ –î–ª—è –∞—É–¥–∏–æ –Ω–µ –≤—ã–±—Ä–∞–Ω MP3/OGG. –¢–æ–≥–¥–∞ –∞—É–¥–∏–æ –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∫–∞–∫ –∏—Å—Ö–æ–¥–Ω–æ–µ –±–µ–∑ ‚Äú–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏‚Äù.');
      }
      tips.push('‚ÑπÔ∏è –°–µ–π—á–∞—Å ‚Äú–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∞—É–¥–∏–æ‚Äù –≤ –∫–æ–¥–µ <b>–Ω–µ –ø–µ—Ä–µ–∫–æ–¥–∏—Ä—É–µ—Ç</b> –∑–≤—É–∫ (–±–∏—Ç—Ä–µ–π—Ç/–∫–æ–¥–µ–∫ –Ω–µ –º–µ–Ω—è—é—Ç—Å—è), –∞ —Ç–æ–ª—å–∫–æ –º–µ–Ω—è–µ—Ç —Ç–∏–ø Blob. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Ä–µ–∞–ª—å–Ω–æ–µ mp3/ogg ‚Äî –Ω–∞–¥–æ –ø–æ–¥–∫–ª—é—á–∞—Ç—å FFmpeg WASM –¥–ª—è –∞—É–¥–∏–æ.');
    }

    // video tips
    if (video.length) {
      const ffOk = this.mediaProcessor?.videoProcessor?.isFFmpegReady;
      if (!ffOk) {
        tips.push('üé¨ FFmpeg –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤/–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî –≤–∏–¥–µ–æ –±—É–¥–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞/–∫–∞—á–µ—Å—Ç–≤–∞. –ï—Å–ª–∏ —ç—Ç–æ –Ω–∞ Vercel –∏ CORS ‚Äú—Å—Ç—Ä–µ–ª—è–µ—Ç‚Äù ‚Äî –ª—É—á—à–µ —Å–∞–º–æ—Ö–æ—Å—Ç–∏–Ω–≥ core/wasm.');
      }
      if (video.length > 2) {
        tips.push(`‚ö° –£ —Ç–µ–±—è <b>${video.length}</b> –≤–∏–¥–µ–æ. –î–ª—è –±—Ä–∞—É–∑–µ—Ä–Ω–æ–≥–æ FFmpeg –ª—É—á—à–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å 1‚Äì2 –∑–∞ —Ä–∞–∑, –∏–Ω–∞—á–µ –º–æ–≥—É—Ç –±—ã—Ç—å –∑–∞–≤–∏—Å–∞–Ω–∏—è/Out of memory.`);
      }
    }

    // general tips
    if (!tips.length) {
      tips.push('‚úÖ –í—Å—ë –≤—ã–≥–ª—è–¥–∏—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ. –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî —Å–¥–µ–ª–∞–π ‚Äú–ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π‚Äù –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫ –ø–æ PNG/JPG –∏ —Ñ–æ–Ω—É.');
    }

    const totalSize = files.reduce((s,f)=>s+f.size,0);

    const statsHtml = `
      <b>üìä –°–≤–æ–¥–∫–∞</b><br>
      –§–∞–π–ª–æ–≤: <b>${files.length}</b> (${FileUtils.formatFileSize(totalSize)})<br>
      –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: <b>${images.length}</b>, –ê—É–¥–∏–æ: <b>${audio.length}</b>, –í–∏–¥–µ–æ: <b>${video.length}</b><br>
      –§–æ–Ω –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: <b>${this.currentSettings.selectedBackground}</b><br>
      PNG: <b>${pngChecked ? '–¥–∞' : '–Ω–µ—Ç'}</b>, JPG: <b>${jpgChecked ? '–¥–∞' : '–Ω–µ—Ç'}</b><br>
      MP3: <b>${mp3Checked ? '–¥–∞' : '–Ω–µ—Ç'}</b>, OGG: <b>${oggChecked ? '–¥–∞' : '–Ω–µ—Ç'}</b>
    `;

    this.renderAIResults(statsHtml, tips);
  }

  /* ===========================
     AI #1.5: Image analysis
  ============================ */
  async analyzeAllImages() {
    const files = this.files.filter(f => FileUtils.getFileType(f.name) === '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
    if (!files.length) {
      this.renderAIResults('<b>–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</b>', ['–î–æ–±–∞–≤—å —Ö–æ—Ç—è –±—ã 1 –∫–∞—Ä—Ç–∏–Ω–∫—É –∏ –ø–æ–≤—Ç–æ—Ä–∏ –∞–Ω–∞–ª–∏–∑.']);
      return;
    }

    // UI lock
    const btn = document.getElementById('analyzeImagesBtn');
    btn.disabled = true;
    btn.textContent = '‚è≥ –ê–Ω–∞–ª–∏–∑...';

    try {
      const results = [];
      for (let i=0;i<files.length;i++){
        const r = await this.analyzeSingleImage(files[i]);
        results.push(r);
      }

      const transparentCount = results.filter(r => r.alphaRatio > 0.01).length;
      const logoLikeCount = results.filter(r => r.isLogoLike).length;
      const photoLikeCount = results.filter(r => !r.isLogoLike).length;

      const tips = [];

      if (transparentCount) tips.push(`üß© –£ <b>${transparentCount}</b> –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –µ—Å—Ç—å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å. –î–ª—è —Ç–∞–∫–∏—Ö –ª—É—á—à–µ <b>PNG</b> (–∏ —Ñ–æ–Ω = transparent).`);
      if (logoLikeCount) tips.push(`üè∑Ô∏è –ü–æ—Ö–æ–∂–µ –Ω–∞ ‚Äú–ª–æ–≥–æ—Ç–∏–ø—ã/–≥—Ä–∞—Ñ–∏–∫—É‚Äù: <b>${logoLikeCount}</b> —Ñ–∞–π–ª–æ–≤. –û–±—ã—á–Ω–æ –ª—É—á—à–µ <b>PNG</b>, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ JPG.`);
      if (photoLikeCount) tips.push(`üì∏ –ü–æ—Ö–æ–∂–µ –Ω–∞ ‚Äú—Ñ–æ—Ç–æ/—Ä–µ–Ω–¥–µ—Ä—ã‚Äù: <b>${photoLikeCount}</b> —Ñ–∞–π–ª–æ–≤. –î–ª—è –Ω–∏—Ö —á–∞—Å—Ç–æ –ª—É—á—à–µ <b>JPG</b> (–º–µ–Ω—å—à–µ –≤–µ—Å).`);

      // background suggestion based on brightness
      const avgLum = results.reduce((s,r)=>s+r.avgLum,0)/results.length;
      if (avgLum > 0.75) tips.push('üé® –ö–∞—Ä—Ç–∏–Ω–∫–∏ –≤ —Å—Ä–µ–¥–Ω–µ–º —Å–≤–µ—Ç–ª—ã–µ ‚Üí —Ñ–æ–Ω ‚Äúwhite/lightgray‚Äù –æ–±—ã—á–Ω–æ –≤—ã–≥–ª—è–¥–∏—Ç –ª—É—á—à–µ.');
      else if (avgLum < 0.35) tips.push('üé® –ö–∞—Ä—Ç–∏–Ω–∫–∏ –≤ —Å—Ä–µ–¥–Ω–µ–º —Ç—ë–º–Ω—ã–µ ‚Üí —Ñ–æ–Ω ‚Äúblack‚Äù –º–æ–∂–µ—Ç –¥–∞—Ç—å –∫–æ–Ω—Ç—Ä–∞—Å—Ç (–µ—Å–ª–∏ —ç—Ç–æ –Ω—É–∂–Ω–æ).');

      // per-file detail
      results.forEach(r=>{
        const rec = [];
        if (r.alphaRatio > 0.01) rec.push('PNG + transparent');
        if (r.isLogoLike && r.alphaRatio <= 0.01) rec.push('PNG');
        if (!r.isLogoLike && r.alphaRatio <= 0.01) rec.push('JPG');
        if (!rec.length) rec.push('PNG/JPG –ø–æ –∑–∞–¥–∞—á–µ');

        tips.push(`
          <div class="image-analysis-result">
            <b>üñºÔ∏è ${r.name}</b><br>
            <div class="analysis-technical">
              <div class="tech-item"><div class="tech-value">${r.width}√ó${r.height}</div><div>–†–∞–∑–º–µ—Ä</div></div>
              <div class="tech-item"><div class="tech-value">${Math.round(r.alphaRatio*100)}%</div><div>–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å</div></div>
              <div class="tech-item"><div class="tech-value">${r.uniqueBins}</div><div>‚Äú–¶–≤–µ—Ç–æ–≤‚Äù (–≥—Ä—É–±–æ)</div></div>
              <div class="tech-item"><div class="tech-value">${Math.round(r.avgLum*100)}%</div><div>–Ø—Ä–∫–æ—Å—Ç—å</div></div>
            </div>
            –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: <b>${rec.join(' / ')}</b>
          </div>
        `);
      });

      const statsHtml = `
        <b>üé® –ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</b><br>
        –ö–∞—Ä—Ç–∏–Ω–æ–∫: <b>${results.length}</b><br>
        –° –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é: <b>${transparentCount}</b><br>
        –õ–æ–≥–æ—Ç–∏–ø–æ–ø–æ–¥–æ–±–Ω—ã–µ: <b>${logoLikeCount}</b><br>
        –°—Ä–µ–¥–Ω—è—è —è—Ä–∫–æ—Å—Ç—å: <b>${Math.round(avgLum*100)}%</b>
      `;

      this.renderAIResults(statsHtml, tips);
    } finally {
      btn.disabled = false;
      btn.textContent = 'üé® –ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π';
    }
  }

  async analyzeSingleImage(file) {
    const img = await this.loadImageFromFile(file);
    const { data, width, height } = this.getScaledImageData(img, 160);

    // metrics
    let alphaCount = 0;
    let total = 0;

    // approximate unique colors by binning
    const bins = new Set();

    // average luminance
    let lumSum = 0;
    let lumN = 0;

    for (let i=0;i<data.length;i+=4){
      const r=data[i], g=data[i+1], b=data[i+2], a=data[i+3];
      total++;
      if (a < 250) alphaCount++;

      if (a > 10) {
        const br = r >> 4; // 0..15
        const bg = g >> 4;
        const bb = b >> 4;
        bins.add((br<<8) | (bg<<4) | bb);

        lumSum += ColorUtils.luminance(r,g,b);
        lumN++;
      }
    }

    const alphaRatio = total ? alphaCount/total : 0;
    const uniqueBins = bins.size;
    const avgLum = lumN ? lumSum/lumN : 0;

    // heuristic: "logo-like" often has few colors (after binning) and/or transparency
    const isLogoLike = (alphaRatio > 0.02) || uniqueBins < 80;

    return {
      name: file.name,
      width: img.width,
      height: img.height,
      alphaRatio,
      uniqueBins,
      avgLum,
      isLogoLike
    };
  }

  loadImageFromFile(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = e.target.result;
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  getScaledImageData(img, maxDim=160) {
    const scale = Math.min(1, maxDim / Math.max(img.width, img.height));
    const w = Math.max(1, Math.round(img.width * scale));
    const h = Math.max(1, Math.round(img.height * scale));

    const canvas = document.createElement('canvas');
    canvas.width = w;
    canvas.height = h;
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    ctx.drawImage(img, 0, 0, w, h);
    const imageData = ctx.getImageData(0, 0, w, h);
    return { data: imageData.data, width: w, height: h };
  }

  /* ===========================
     AI #2: Brand analysis (palette + recommendations)
  ============================ */
  async analyzeBrandAssets() {
    const container = document.getElementById('brandAnalysisResults');
    container.classList.remove('hidden');
    container.innerHTML = `‚è≥ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –±—Ä–µ–Ω–¥–∞...`;

    const files = this.files.filter(f => FileUtils.getFileType(f.name) === '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');

    if (!files.length) {
      container.innerHTML = `<b>–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</b><br>–î–æ–±–∞–≤—å –∫–∞—Ä—Ç–∏–Ω–∫–∏ (–ª–æ–≥–æ—Ç–∏–ø—ã/–±–∞–Ω–Ω–µ—Ä—ã/–∫—Ä–µ–∞—Ç–∏–≤—ã) –∏ –∑–∞–ø—É—Å—Ç–∏ –∞–Ω–∞–ª–∏–∑.`;
      return;
    }

    // –±–µ—Ä–µ–º –¥–æ 12 –∫–∞—Ä—Ç–∏–Ω–æ–∫, —á—Ç–æ–±—ã –Ω–µ —É–±–∏—Ç—å –±—Ä–∞—É–∑–µ—Ä
    const subset = files.slice(0, 12);

    // —Å–æ–±–∏—Ä–∞–µ–º –ø–∏–∫—Å–µ–ª–∏
    const samples = [];
    let transparentHits = 0;

    for (const f of subset) {
      const img = await this.loadImageFromFile(f);
      const { data } = this.getScaledImageData(img, 180);

      for (let i=0;i<data.length;i+=4*3){ // —à–∞–≥, —á—Ç–æ–±—ã –º–µ–Ω—å—à–µ —Ç–æ—á–µ–∫
        const r=data[i], g=data[i+1], b=data[i+2], a=data[i+3];
        if (a < 20) { transparentHits++; continue; }
        samples.push([r,g,b]);
      }
    }

    if (samples.length < 50) {
      container.innerHTML = `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–∞–ª–∏—Ç—Ä—ã (—Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏/–º–∞–ª–æ –ø–∏–∫—Å–µ–ª–µ–π).`;
      return;
    }

    // KMeans –Ω–∞ 5 —Ü–≤–µ—Ç–æ–≤
    const k = 5;
    const { centroids, counts } = this.kmeans(samples, k, 7);

    // —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏
    const palette = centroids
      .map((c, idx)=>({ rgb: c, count: counts[idx] || 0 }))
      .sort((a,b)=>b.count-a.count)
      .filter(p=>p.count>0);

    const totalCount = palette.reduce((s,p)=>s+p.count,0) || 1;

    const paletteHtml = `
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
        <b>üé® –ü–∞–ª–∏—Ç—Ä–∞ (—Ç–æ–ø —Ü–≤–µ—Ç–æ–≤)</b>
        <span style="font-size:0.85em;opacity:0.9;">(–ø–æ ${Math.min(files.length, 12)} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º)</span>
      </div>
      <div class="color-palette">
        ${palette.map(p=>{
          const hex = ColorUtils.rgbToHex(p.rgb[0],p.rgb[1],p.rgb[2]);
          return `<div class="color-swatch" data-hex="${hex}" style="background:${hex};"></div>`;
        }).join('')}
      </div>
      <div style="font-size:0.9em;opacity:0.95;">
        ${palette.map(p=>{
          const hex = ColorUtils.rgbToHex(p.rgb[0],p.rgb[1],p.rgb[2]);
          const pct = Math.round((p.count/totalCount)*100);
          return `<div>‚Ä¢ <b>${hex}</b> ‚Äî ~${pct}%</div>`;
        }).join('')}
      </div>
    `;

    // —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: —Ñ–æ–Ω –ø–æ –¥–æ–º–∏–Ω–∏—Ä—É—é—â–µ–º—É —Ü–≤–µ—Ç—É/—è—Ä–∫–æ—Å—Ç–∏
    const dom = palette[0]?.rgb || [255,255,255];
    const domHex = ColorUtils.rgbToHex(dom[0],dom[1],dom[2]);
    const domLum = ColorUtils.luminance(dom[0],dom[1],dom[2]);

    let recommendedBg = 'white';
    let recommendedCustomHex = null;

    // –µ—Å–ª–∏ –¥–æ–º–∏–Ω–∞–Ω—Ç–∞ –±–ª–∏–∑–∫–∞ –∫ –±–µ–ª–æ–º—É/—Å–µ—Ä–æ–º—É
    if (domLum > 0.85) recommendedBg = 'white';
    else if (domLum > 0.65) recommendedBg = 'lightgray';
    else if (domLum < 0.22) recommendedBg = 'black';
    else {
      // —Å—Ä–µ–¥–Ω—è—è —è—Ä–∫–æ—Å—Ç—å ‚Äî —Å—Ç–∞–≤–∏–º custom, —á—Ç–æ–±—ã ‚Äú–ø–æ–¥ –±—Ä–µ–Ω–¥‚Äù
      recommendedBg = 'custom';
      recommendedCustomHex = domHex;
    }

    const pngAuto = transparentHits > 0; // –µ—Å–ª–∏ –≤—Å—Ç—Ä–µ—Ç–∏–ª–∞—Å—å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å ‚Äî –Ω–∞–º–µ–∫–∞–µ–º –Ω–∞ png
    const recommendations = {
      recommendedBg,
      recommendedCustomHex,
      suggestPng: pngAuto,
      suggestJpg: !pngAuto
    };
    this.lastBrandRecommendations = recommendations;

    const recHtml = `
      <hr style="border:none;border-top:1px solid rgba(255,255,255,0.2);margin:12px 0;">
      <b>üß© –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</b><br>
      ‚Ä¢ –§–æ–Ω –ø–æ –±—Ä–µ–Ω–¥—É: <b>${recommendedBg === 'custom' ? `custom (${recommendedCustomHex})` : recommendedBg}</b><br>
      ‚Ä¢ –§–æ—Ä–º–∞—Ç—ã: <b>${pngAuto ? 'PNG (–µ—Å—Ç—å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å/–≥—Ä–∞—Ñ–∏–∫–∞)' : 'JPG (–µ—Å–ª–∏ —Ñ–æ—Ç–æ/–±–µ–∑ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏)'}</b><br>
      <div style="margin-top:10px;" class="ai-actions">
        <button class="ai-btn secondary" onclick="appState.applyBrandRecommendations()">‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</button>
        <button class="ai-btn" onclick="appState.copyBrandPalette()">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–∞–ª–∏—Ç—Ä—É</button>
      </div>
      <div style="font-size:0.85em;opacity:0.9;margin-top:8px;">
        –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–µ–Ω—è–µ—Ç: —Ñ–æ–Ω –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ ‚Äî –∫–∞—Å—Ç–æ–º–Ω—ã–π hex), –∞ —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç –≤—ã—Å—Ç–∞–≤–∏—Ç—å PNG/JPG.
      </div>
    `;

    container.innerHTML = paletteHtml + recHtml;

    // –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω –∞–≤—Ç–æ-–∞–Ω–∞–ª–∏–∑ ‚Äî –ø—Ä–∏–º–µ–Ω—è–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (—á—Ç–æ–±—ã —Ä–µ–∞–ª—å–Ω–æ –±—ã–ª–æ ‚Äú–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏‚Äù)
    if (document.getElementById('aiAnalysis')?.checked) {
      this.applyBrandRecommendations(true);
    }
  }

  applyBrandRecommendations(silent=false) {
    const rec = this.lastBrandRecommendations;
    if (!rec) {
      if (!silent) this.showError('–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏ ‚Äú–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –±—Ä–µ–Ω–¥‚Äù.');
      return;
    }

    // —Ñ–æ–Ω
    if (rec.recommendedBg === 'custom' && rec.recommendedCustomHex) {
      document.getElementById('customColorHex').value = rec.recommendedCustomHex;
      document.getElementById('customColorPicker').value = rec.recommendedCustomHex;
      this.updateCustomPreview(rec.recommendedCustomHex);
      this.setBackgroundSelection('custom');
    } else {
      this.setBackgroundSelection(rec.recommendedBg);
    }

    // —Ñ–æ—Ä–º–∞—Ç—ã (–º—è–≥–∫–æ: –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî –≤—ã—Å—Ç–∞–≤–ª—è–µ–º; –µ—Å–ª–∏ —É–∂–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî –Ω–µ –ª–æ–º–∞–µ–º)
    const png = document.getElementById('formatPNG');
    const jpg = document.getElementById('formatJPG');
    if (png && jpg) {
      if (!png.checked && !jpg.checked) {
        png.checked = !!rec.suggestPng;
        jpg.checked = !!rec.suggestJpg;
      }
    }

    if (!silent) {
      // –ø–æ–∫–∞–∑–∞—Ç—å –±—ã—Å—Ç—Ä—ã–π —Å–æ–≤–µ—Ç –≤ AI-—Å–æ–≤–µ—Ç–Ω–∏–∫–µ
      document.getElementById('aiTipTitle').textContent = '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã ‚úÖ';
      document.getElementById('aiTipContent').textContent =
        `–§–æ–Ω: ${this.currentSettings.selectedBackground}${rec.recommendedBg==='custom' ? ` (${rec.recommendedCustomHex})` : ''}`;
    }
  }

  async copyBrandPalette() {
    const container = document.getElementById('brandAnalysisResults');
    const swatches = container.querySelectorAll('.color-swatch');
    const hexes = Array.from(swatches).map(s => s.getAttribute('data-hex')).filter(Boolean);
    const text = hexes.join(', ');
    try {
      await navigator.clipboard.writeText(text);
      document.getElementById('aiTipTitle').textContent = '–ü–∞–ª–∏—Ç—Ä–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ ‚úÖ';
      document.getElementById('aiTipContent').textContent = text;
    } catch (e) {
      // fallback
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      document.getElementById('aiTipTitle').textContent = '–ü–∞–ª–∏—Ç—Ä–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ ‚úÖ';
      document.getElementById('aiTipContent').textContent = text;
    }
  }

  kmeans(points, k=5, iters=7) {
    // init centroids random
    const centroids = [];
    const counts = new Array(k).fill(0);

    const pick = () => points[Math.floor(Math.random()*points.length)];
    const used = new Set();
    while (centroids.length < k) {
      const p = pick();
      const key = (p[0]<<16)|(p[1]<<8)|p[2];
      if (!used.has(key)) {
        used.add(key);
        centroids.push([p[0],p[1],p[2]]);
      }
    }

    let assignments = new Array(points.length).fill(0);

    for (let iter=0; iter<iters; iter++) {
      counts.fill(0);
      const sums = new Array(k).fill(0).map(()=>[0,0,0]);

      // assign
      for (let i=0;i<points.length;i++){
        const p = points[i];
        let best = 0;
        let bestD = Infinity;
        for (let c=0;c<k;c++){
          const d = ColorUtils.dist2(p, centroids[c]);
          if (d < bestD) { bestD = d; best = c; }
        }
        assignments[i] = best;
        counts[best]++;
        sums[best][0] += p[0];
        sums[best][1] += p[1];
        sums[best][2] += p[2];
      }

      // update
      for (let c=0;c<k;c++){
        if (counts[c] > 0) {
          centroids[c] = [
            sums[c][0]/counts[c],
            sums[c][1]/counts[c],
            sums[c][2]/counts[c]
          ];
        } else {
          const p = pick();
          centroids[c] = [p[0],p[1],p[2]];
        }
      }
    }

    // —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ counts (–¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏ —É–∂–µ –µ—Å—Ç—å)
    return { centroids, counts };
  }

  /* ===========================
     Other UI actions
  ============================ */
  resetAllSettings() {
    this.currentSettings = this.getDefaultSettings();
    document.getElementById('imageSizes').value = this.currentSettings.imageSizes;

    document.querySelectorAll('.resolution-option').forEach(opt => opt.classList.remove('selected'));
    document.querySelector('.resolution-option[data-resolution="640x360"]').classList.add('selected');

    document.querySelectorAll('.video-format-option').forEach(opt => opt.classList.remove('selected'));
    document.querySelector('.video-format-option[data-format="mp4"]').classList.add('selected');

    document.querySelectorAll('.video-quality-option').forEach(opt => opt.classList.remove('selected'));
    document.querySelector('.video-quality-option[data-quality="medium"]').classList.add('selected');

    document.querySelectorAll('.background-color-option').forEach(opt => opt.classList.remove('selected'));
    document.querySelector('.background-color-option[data-background="white"]').classList.add('selected');
    this.currentSettings.selectedBackground = 'white';

    this.updateNamingExample();
    this.updateAITipReady();
    alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–±—Ä–æ—à–µ–Ω—ã!');
  }

  clearAllCheckboxes() {
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = false);
    this.updateNamingExample();
    alert('–í—Å–µ –≥–∞–ª–æ—á–∫–∏ —É–±—Ä–∞–Ω—ã!');
  }

  selectAllCheckboxes(type) {
    let selector = '';
    switch (type) {
      case 'image': selector = '#formatPNG, #formatJPG'; break;
      case 'audio': selector = '#audioMP3, #audioOGG'; break;
      case 'ai': selector = '#aiAnalysis'; break;
    }
    if (selector) document.querySelectorAll(selector).forEach(cb => cb.checked = true);

    this.updateNamingExample();
    if (type === 'ai') this.scheduleBrandAnalysis();
  }

  clearCheckboxes(type) {
    let selector = '';
    switch (type) {
      case 'image': selector = '#formatPNG, #formatJPG'; break;
      case 'audio': selector = '#audioMP3, #audioOGG'; break;
      case 'ai': selector = '#aiAnalysis'; break;
    }
    if (selector) document.querySelectorAll(selector).forEach(cb => cb.checked = false);
    this.updateNamingExample();
  }

  loadPreset(preset) {
    switch (preset) {
      case 'creatives': document.getElementById('imageSizes').value = '1200x600, 800x400, 600x300'; break;
      case 'vertical': document.getElementById('imageSizes').value = '1080x1920, 800x1400, 400x700'; break;
      case 'logos': document.getElementById('imageSizes').value = '800x800, 400x400, 200x200'; break;
      case 'icons': document.getElementById('imageSizes').value = '256x256, 128x128, 64x64, 32x32'; break;
    }
    this.updateNamingExample();
    alert(`–ü—Ä–µ—Å–µ—Ç "${preset}" –∑–∞–≥—Ä—É–∂–µ–Ω!`);
  }
}

/* ===========================
   Init
=========================== */
let appState;

document.addEventListener('DOMContentLoaded', () => {
  appState = new AppState();

  document.getElementById('customColorPicker').addEventListener('input', (e) => {
    document.getElementById('customColorHex').value = e.target.value;
  });

  document.getElementById('customColorHex').addEventListener('change', (e) => {
    let value = e.target.value.trim();
    if (!value.startsWith('#')) {
      value = '#' + value;
      e.target.value = value;
      document.getElementById('customColorPicker').value = value;
    }
  });

  window.appState = appState;
});
</script>
</body>
</html>
